<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JTF Team Management Portal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'sans-serif']
                    },
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e'
                        },
                        secondary: {
                            50: '#fdf4ff',
                            100: '#fae8ff',
                            200: '#f5d0fe',
                            300: '#f0abfc',
                            400: '#e879f9',
                            500: '#d946ef',
                            600: '#c026d3',
                            700: '#a21caf',
                            800: '#86198f',
                            900: '#701a75'
                        }
                    },
                    boxShadow: {
                        'card': '0 1px 3px 0 rgba(0,0,0,0.07), 0 1px 2px -1px rgba(0,0,0,0.05)',
                        'card-hover': '0 4px 12px 0 rgba(0,0,0,0.10), 0 2px 4px -2px rgba(0,0,0,0.06)',
                        'modal': '0 20px 60px -15px rgba(0,0,0,0.35)'
                    }
                }
            }
        }
    </script>
    <style>
        *, *::before, *::after { box-sizing: border-box; }
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        #root {
            position: fixed;
            inset: 0;
            display: flex;
            flex-direction: column;
        }

        /* ── Scrollbar ───────────────────────────────────────────────── */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* ── Loading spinner ─────────────────────────────────────────── */
        .loading-spinner {
            border: 3px solid #e2e8f0;
            border-top: 3px solid #0ea5e9;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            0%   { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ── Page fade-in ────────────────────────────────────────────── */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(6px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        .page-enter { animation: fadeIn 0.18s ease-out forwards; }

        /* ── Modal slide-in ──────────────────────────────────────────── */
        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.97) translateY(-8px); }
            to   { opacity: 1; transform: scale(1) translateY(0); }
        }
        .modal-panel { animation: modalIn 0.18s ease-out forwards; }

        /* ── Sidebar nav item ────────────────────────────────────────── */
        .nav-item { transition: background 0.12s ease, color 0.12s ease; }

        /* ── Card hover ──────────────────────────────────────────────── */
        .data-card {
            transition: box-shadow 0.15s ease, transform 0.15s ease;
        }
        .data-card:hover {
            box-shadow: 0 4px 12px 0 rgba(0,0,0,0.10), 0 2px 4px -2px rgba(0,0,0,0.06);
            transform: translateY(-1px);
        }

        /* ── Focus ring ──────────────────────────────────────────────── */
        input:focus, select:focus, textarea:focus, button:focus-visible {
            outline: 2px solid #0ea5e9;
            outline-offset: 2px;
        }
        input, select, textarea { outline: none; }

        /* ── Stat card accent bar ────────────────────────────────────── */
        .stat-card { position: relative; overflow: hidden; }
        .stat-card::before {
            content: '';
            position: absolute;
            left: 0; top: 0; bottom: 0;
            width: 3px;
            border-radius: 3px 0 0 3px;
        }
        .stat-card.accent-blue::before   { background: #0ea5e9; }
        .stat-card.accent-green::before  { background: #22c55e; }
        .stat-card.accent-purple::before { background: #a855f7; }
        .stat-card.accent-orange::before { background: #f97316; }

        /* ── Primary button ──────────────────────────────────────────── */
        .btn-primary {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            box-shadow: 0 1px 3px rgba(2, 132, 199, 0.4);
            transition: filter 0.12s ease, box-shadow 0.12s ease, transform 0.1s ease;
        }
        .btn-primary:hover {
            filter: brightness(1.06);
            box-shadow: 0 4px 12px rgba(2, 132, 199, 0.4);
            transform: translateY(-1px);
        }
        .btn-primary:active { transform: translateY(0); filter: brightness(0.97); }
        .btn-primary:disabled { filter: none; opacity: 0.55; transform: none; box-shadow: none; cursor: not-allowed; }

        /* ── Danger button ───────────────────────────────────────────── */
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 1px 3px rgba(220, 38, 38, 0.35);
            transition: filter 0.12s ease, box-shadow 0.12s ease, transform 0.1s ease;
        }
        .btn-danger:hover { filter: brightness(1.06); box-shadow: 0 4px 12px rgba(220,38,38,0.35); transform: translateY(-1px); }
        .btn-danger:active { transform: translateY(0); }
    </style>
</head>
<body>
    <div id="root">
        <div style="display: flex; justify-content: center; align-items: center; height: 100vh; flex-direction: column; background: #f8fafc;">
            <div class="loading-spinner"></div>
            <p style="margin-top: 16px; color: #64748b; font-size: 14px; font-family: Inter, sans-serif; font-weight: 500;">Loading JTF Portal…</p>
        </div>
    </div>

    <script type="text/babel">
        // Google Apps Script Service
        // This service handles all CRUD operations between the frontend and Google Sheets database
        
        // Environment detection - check if we're in Google Apps Script environment
        let isDevelopment = true; // Default to development mode
        
        try {
            // Check if we're actually in a Google Apps Script environment
            if (typeof google !== 'undefined' && 
                google.script && 
                typeof google.script.run !== 'undefined' &&
                window.location.hostname.includes('script.google.com')) {
                isDevelopment = false; // We're in a real Google Apps Script environment
            }
        } catch (e) {
            // If any error occurs, stay in development mode
            isDevelopment = true;
        }

        // DEBUG: Log the environment detection
        console.log('=== ENVIRONMENT DETECTION ===');
        console.log('typeof google:', typeof google);
        console.log('google exists:', typeof google !== 'undefined');
        console.log('google.script exists:', typeof google !== 'undefined' && !!google.script);
        console.log('hostname:', window.location.hostname);
        console.log('isDevelopment:', isDevelopment);
        
        // Force production mode to use Google Sheets data
        isDevelopment = false;
        
        console.log('Final isDevelopment (forced to use real data):', isDevelopment);
        console.log('================================');

        class GoogleAppsScriptService {
            // ===================================================================
            // GOOGLE APPS SCRIPT COMMUNICATION METHOD
            // This method routes all CRUD operations to Google Apps Script functions  
            // Now connects directly to your Google Sheets database
            // ===================================================================
            async callServerFunction(functionName, ...args) {
                console.log(`=== callServerFunction called ===`);
                console.log(`Calling ${functionName} with args:`, args);
                console.log('isDevelopment:', isDevelopment);
                
                // Force Google Apps Script usage - no more mock data
                console.log('Making real Apps Script call to', functionName);
                
                try {
                    const result = await new Promise((resolve, reject) => {
                        google.script.run
                            .withSuccessHandler((result) => {
                                console.log(`${functionName} success:`, result);
                                resolve(result);
                            })
                            .withFailureHandler((error) => {
                                console.error(`${functionName} error:`, error);
                                reject(error);
                            })
                            [functionName](...args);
                    });

                    return { success: true, data: result };
                } catch (error) {
                    console.error(`Error calling ${functionName}:`, error);
                    return { success: false, error: error.toString() };
                }
            }

            // ===================================================================
            // PERSONNEL CRUD API METHODS
            // These methods interact with the Personnel sheet in Google Sheets
            // ===================================================================
            
            // READ: Get all personnel records from Personnel sheet
            async getAllPersonnel() {
                return this.callServerFunction('getAllPersonnel');
            }

            // CREATE: Add new person to Personnel sheet (PersonnelID auto-generated)
            async createPersonnel(personnel) {
                return this.callServerFunction('createPersonnel', personnel);
            }

            // UPDATE: Modify existing person in Personnel sheet by PersonnelID
            async updatePersonnel(personnel) {
                return this.callServerFunction('updatePersonnel', personnel);
            }

            // DELETE: Remove person from Personnel sheet by PersonnelID
            async deletePersonnel(personnelId) {
                return this.callServerFunction('deletePersonnel', personnelId);
            }

            // ===================================================================
            // DEBUG METHOD - Test Google Sheets connection
            // ===================================================================
            
            // DEBUG: Test the Personnel sheet connection and data
            // Test basic connection
            async testConnection() {
                return this.callServerFunction('testConnection');
            }

            async debugPersonnelSheet() {
                return this.callServerFunction('debugPersonnelSheet');
            }

            // ===================================================================
            // CAST CRUD API METHODS  
            // These methods interact with cast member data from ShowPerformances sheet
            // ===================================================================
            
            // READ: Get all cast members with show details
            async getAllCastMembers() {
                return this.callServerFunction('getAllCastMembers');
            }

            // CREATE: Add a person from Personnel to CastMemberInfo
            async addPersonAsCastMember(personnelId) {
                return this.callServerFunction('addPersonAsCastMember', personnelId);
            }

            // DELETE: Remove a cast member from CastMemberInfo by CastMemberID
            async removeCastMember(castMemberId) {
                return this.callServerFunction('removeCastMember', castMemberId);
            }

            // ===================================================================
            // CREW CRUD API METHODS
            // These methods interact with crew duty data from CrewDuties sheet
            // ===================================================================

            // READ: Get all crew members with duty and show details
            async getAllCrewMembers() {
                return this.callServerFunction('getAllCrewMembers');
            }

            // CREATE: Add a person from Personnel to CrewMemberInfo
            async addPersonAsCrewMember(personnelId) {
                return this.callServerFunction('addPersonAsCrewMember', personnelId);
            }

            // DELETE: Remove a crew member from CrewMemberInfo by CrewMemberID
            async removeCrewMember(crewMemberId) {
                return this.callServerFunction('removeCrewMember', crewMemberId);
            }

            // ===================================================================
            // SHOW CRUD API METHODS  
            // These methods interact with the ShowInformation sheet in Google Sheets
            // ===================================================================
            
            // READ: Get all show records from ShowInformation sheet
            async getAllShows() {
                return this.callServerFunction('getAllShows');
            }

            // CREATE/UPDATE: Create or update a show in ShowInformation sheet
            async createOrUpdateShow(showData) {
                return this.callServerFunction('createOrUpdateShow', showData);
            }

            // DELETE: Delete a show from ShowInformation sheet
            async deleteShow(showId) {
                return this.callServerFunction('deleteShow', showId);
            }

            // READ: Get all show types for dropdown
            async getAllShowTypes() {
                return this.callServerFunction('getAllShowTypes');
            }

            // READ: Get all rooms for dropdown
            async getAllRooms() {
                return this.callServerFunction('getAllRooms');
            }

            // READ: Get all directors for dropdown
            async getAllDirectors() {
                return this.callServerFunction('getAllDirectors');
            }

            // READ: Get all bartenders for dropdown
            async getAllBartenders() {
                return this.callServerFunction('getAllBartenders');
            }

            // READ: Get all bartenders with full details (for Bartenders management page)
            async getBartendersWithDetails() {
                return this.callServerFunction('getBartendersWithDetails');
            }

            // CREATE: Add a person from Personnel to the Bartenders table
            async addPersonAsBartender(personnelId, trained, status) {
                return this.callServerFunction('addPersonAsBartender', personnelId, trained, status);
            }

            // DELETE: Remove a bartender from the Bartenders table by BartenderID
            async removeBartender(bartenderId) {
                return this.callServerFunction('removeBartender', bartenderId);
            }

            // READ: Get all teachers with full details (for Teachers management page)
            async getTeachersWithDetails() {
                return this.callServerFunction('getTeachersWithDetails');
            }

            // CREATE: Add a person from Personnel to the Teachers table
            async addPersonAsTeacher(personnelId) {
                return this.callServerFunction('addPersonAsTeacher', personnelId);
            }

            // DELETE: Remove a teacher from the Teachers table by TeacherID
            async removeTeacher(teacherId) {
                return this.callServerFunction('removeTeacher', teacherId);
            }

            // READ: Get all crew duty types
            async getAllCrewDutyTypes() {
                return this.callServerFunction('getAllCrewDutyTypes');
            }

            // ===================================================================
            // GAMES API METHODS
            // These methods interact with MasterGameList and GamesPlayed sheets
            // ===================================================================
            
            // READ: Get all games from MasterGameList
            async getAllGames() {
                return this.callServerFunction('getAllGames');
            }

            // READ: Get games played for a specific show
            async getShowGames(showId) {
                return this.callServerFunction('getShowGames', showId);
            }

            // UPDATE: Update games played for a specific show
            async updateShowGames(showId, gamesArray) {
                return this.callServerFunction('updateShowGames', showId, gamesArray);
            }

            // ===================================================================
            // CLASS CRUD API METHODS
            // These methods interact with the ClassOfferings sheet in Google Sheets
            // ===================================================================
            
            // READ: Get all class offering records from ClassOfferings sheet
            async getAllClasses() {
                return this.callServerFunction('getAllClasses');
            }

            // READ: Get all class offerings with teacher names and enrollment counts
            async getAllClassOfferings() {
                return this.callServerFunction('getAllClassOfferings');
            }

            // READ: Get detailed information for a specific class offering
            async getClassOfferingDetails(offeringId) {
                return this.callServerFunction('getClassOfferingDetails', offeringId);
            }

            // CREATE: Create a new class offering
            async createClassOffering(classData) {
                return this.callServerFunction('createClassOffering', classData);
            }

            // UPDATE: Update an existing class offering
            async updateClassOffering(classData) {
                return this.callServerFunction('updateClassOffering', classData);
            }

            // UPDATE: Update class attendance record
            async updateClassAttendance(attendanceData) {
                return this.callServerFunction('updateClassAttendance', attendanceData);
            }

            // UPDATE: Update student enrollment status
            async updateEnrollmentStatus(enrollmentId, status) {
                return this.callServerFunction('updateEnrollmentStatus', enrollmentId, status);
            }

            // READ: Get all active teachers with their names
            async getActiveTeachers() {
                return this.callServerFunction('getActiveTeachers');
            }

            // READ: Get all class levels
            async getAllClassLevels() {
                return this.callServerFunction('getAllClassLevels');
            }

            // ===================================================================
            // INVENTORY CRUD API METHODS (NEW FOUR-TABLE SCHEMA)
            // These methods work with the new inventory schema:
            // InventoryItems (master catalog), InventoryCategories, StorageLocations, InventoryTransactions
            // ===================================================================
            
            // READ: Get all inventory items with calculated quantities from new schema
            async getAllInventory() {
                return this.callServerFunction('getAllInventory');
            }

            // NEW METHODS FOR INVENTORY SCHEMA

            // ADD TRANSACTION: Log inventory changes (stock in/out/transfers)
            async addInventoryTransaction(transaction) {
                return this.callServerFunction('addInventoryTransaction', transaction);
            }

            // GET CATEGORIES: Fetch all inventory categories for dropdowns
            async getAllInventoryCategories() {
                return this.callServerFunction('getAllInventoryCategories');
            }

            // GET LOCATIONS: Fetch all storage locations for dropdowns
            async getAllStorageLocations() {
                return this.callServerFunction('getAllStorageLocations');
            }

            // GET TRANSACTION HISTORY: Get all transactions for a specific item
            async getItemTransactionHistory(itemId) {
                return this.callServerFunction('getItemTransactionHistory', itemId);
            }

            // ===================================================================
            // DASHBOARD STATISTICS API METHOD
            // This method reads from multiple sheets to calculate dashboard stats
            // READS FROM: Personnel, ShowInformation, ClassOfferings, StudentEnrollments sheets
            // ===================================================================
            
            // READ: Calculate aggregated statistics from multiple sheets
            async getDashboardStats() {
                return this.callServerFunction('getDashboardStats');
            }

            // ===================================================================
            // ENROLLMENT CRUD API METHODS
            // These methods interact with the StudentEnrollments sheet in Google Sheets
            // ===================================================================
            
            // CREATE: Add student enrollment records to StudentEnrollments sheet
            // Links students (PersonnelID) to classes (OfferingID)
            async enrollStudents(offeringId, studentIds) {
                return this.callServerFunction('enrollStudents', offeringId, studentIds);
            }

            // ===================================================================
            // INVENTORY ITEM CRUD API METHODS (FULL CRUD OPERATIONS)
            // These methods provide complete Create, Read, Update, Delete for inventory
            // ===================================================================
            
            // CREATE: Add new inventory item to Inventory sheet (ItemID auto-generated)
            async createInventoryItem(item) {
                return this.callServerFunction('createInventoryItem', item);
            }

            // UPDATE: Modify existing inventory item in Inventory sheet by ItemID
            async updateInventoryItem(item) {
                return this.callServerFunction('updateInventoryItem', item);
            }

            // DELETE: Remove inventory item from Inventory sheet by ItemID
            async deleteInventoryItem(itemId) {
                return this.callServerFunction('deleteInventoryItem', itemId);
            }

            // ===================================================================
            // STUDENT MANAGEMENT API METHODS
            // These methods interact with student profile and enrollment data
            // ===================================================================

            // READ: Get comprehensive student profile data (uses StudentID from StudentInfo table)
            // Updated: 2025-10-13 - Now calls getStudentProfileData backend function
            async getStudentProfile(studentId) {
                console.log('=== gasService.getStudentProfile called ===');
                console.log('Calling backend: getStudentProfileData with studentId:', studentId);
                return this.callServerFunction('getStudentProfileData', studentId);
            }

            // READ: Get all students with full details (joins StudentInfo + Personnel)
            // Updated: 2025-10-13 - Now calls getAllStudentsWithDetails backend function
            async getAllStudents() {
                console.log('=== gasService.getAllStudents called ===');
                console.log('Calling backend: getAllStudentsWithDetails');
                return this.callServerFunction('getAllStudentsWithDetails');
            }

            // READ: Get active class offerings for enrollment
            async getActiveClassOfferings() {
                return this.callServerFunction('getActiveClassOfferings');
            }

            // CREATE: Enroll a single student in a class
            async enrollStudent(personnelId, offeringId) {
                return this.callServerFunction('enrollStudent', personnelId, offeringId);
            }

            // CREATE: Enroll multiple personnel in a class at once (bulk enrollment)
            async bulkEnrollStudents(personnelIds, offeringId) {
                return this.callServerFunction('bulkEnrollStudents', personnelIds, offeringId);
            }

            // READ: Get all students enrolled in a specific class offering
            async getEnrolledStudents(offeringId) {
                return this.callServerFunction('getEnrolledStudents', offeringId);
            }

            // READ: Get all students with full details (joins StudentInfo + Personnel)
            async getAllStudentsWithDetails() {
                return this.callServerFunction('getAllStudentsWithDetails');
            }

            // DELETE: Remove a student from a class (delete enrollment record)
            async removeStudentFromClass(enrollmentId) {
                return this.callServerFunction('removeStudentFromClass', enrollmentId);
            }
        }

        const gasService = new GoogleAppsScriptService();

        // React Components
        const { useState, useEffect, useMemo, createElement: e } = React;

        // Loader Component
        function Loader({ text = 'Loading...' }) {
            return e('div', { className: 'flex flex-col items-center justify-center p-12 gap-3' },
                e('div', { className: 'loading-spinner' }),
                e('p', { className: 'text-sm font-medium text-slate-500' }, text)
            );
        }

        // Message Component
        function Message({ type, message, onClose }) {
            const styles = {
                success: { wrap: 'bg-emerald-50 border border-emerald-200 text-emerald-800', dot: 'bg-emerald-500', icon: '✓' },
                error:   { wrap: 'bg-red-50 border border-red-200 text-red-800',         dot: 'bg-red-500',     icon: '✕' },
                warning: { wrap: 'bg-amber-50 border border-amber-200 text-amber-800',    dot: 'bg-amber-500',   icon: '!' },
                info:    { wrap: 'bg-sky-50 border border-sky-200 text-sky-800',           dot: 'bg-sky-500',     icon: 'i' }
            };
            const s = styles[type] || styles.info;
            return e('div', { className: `flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium ${s.wrap}` },
                e('span', { className: `flex-shrink-0 w-5 h-5 rounded-full ${s.dot} text-white flex items-center justify-center text-xs font-bold` }, s.icon),
                e('span', { className: 'flex-1' }, message),
                onClose && e('button', {
                    onClick: onClose,
                    className: 'ml-2 text-current opacity-50 hover:opacity-100 transition-opacity text-lg leading-none'
                }, '×')
            );
        }

        // StatCard Component
        function StatCard({ title, value, icon, color = 'blue' }) {
            const iconBg = {
                blue:   'bg-sky-100 text-sky-600',
                green:  'bg-emerald-100 text-emerald-600',
                purple: 'bg-violet-100 text-violet-600',
                orange: 'bg-orange-100 text-orange-600'
            };
            return e('div', { className: `stat-card accent-${color} bg-white rounded-xl shadow-card border border-gray-100 px-5 py-4` },
                e('div', { className: 'flex items-center justify-between' },
                    e('div', null,
                        e('p', { className: 'text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1' }, title),
                        e('p', { className: 'text-2xl font-bold text-gray-900 leading-tight' }, value ?? '—')
                    ),
                    e('div', { className: `w-10 h-10 rounded-xl flex items-center justify-center text-lg flex-shrink-0 ${iconBg[color] || iconBg.blue}` }, icon)
                )
            );
        }

        // PersonCard Component
        function PersonCard({ person, onClick }) {
            const getInitials = (firstName, lastName) => {
                return `${(firstName || '').charAt(0)}${(lastName || '').charAt(0)}`.toUpperCase() || '?';
            };
            return e('div', {
                onClick: onClick,
                className: 'data-card bg-white rounded-xl shadow-card border border-gray-100 p-4 cursor-pointer'
            },
                e('div', { className: 'flex items-center gap-3' },
                    e('div', { className: 'w-10 h-10 bg-sky-100 rounded-full flex items-center justify-center text-sky-700 text-sm font-bold flex-shrink-0' },
                        getInitials(person.FirstName, person.LastName)
                    ),
                    e('div', { className: 'min-w-0' },
                        e('h3', { className: 'font-semibold text-gray-900 text-sm truncate' }, `${person.FirstName} ${person.LastName}`),
                        e('p', { className: 'text-xs text-gray-500 truncate' }, person.PrimaryEmail)
                    )
                )
            );
        }

        // StudentProfile Component
        function StudentProfile({ studentId, onBack }) {
            const [student, setStudent] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [message, setMessage] = useState(null);

            useEffect(() => {
                loadStudentProfile();
            }, [studentId]);

            const loadStudentProfile = async () => {
                setIsLoading(true);
                try {
                    console.log('=== Loading Student Profile ===');
                    console.log('StudentID:', studentId);
                    const response = await gasService.getStudentProfile(studentId);
                    console.log('getStudentProfile response:', response);
                    
                    if (response.success) {
                        // The response structure is: { success: true, data: { success: true, data: actualStudentData } }
                        // We need to unwrap it properly
                        const studentData = response.data?.data || response.data;
                        console.log('Student data received (unwrapped):', studentData);
                        console.log('FirstName:', studentData?.FirstName);
                        console.log('Lastname:', studentData?.LastName);
                        console.log('PrimaryEmail:', studentData?.PrimaryEmail);
                        console.log('PrimaryPhone:', studentData?.PrimaryPhone);
                        console.log('Birthday:', studentData?.Birthday);
                        setStudent(studentData);
                    } else {
                        console.error('Failed to load student:', response.error);
                        setMessage({ type: 'error', text: response.error || 'Failed to load student profile' });
                    }
                } catch (error) {
                    console.error('Error loading student profile:', error);
                    setMessage({ type: 'error', text: 'Error loading student profile' });
                } finally {
                    setIsLoading(false);
                }
            };

            if (isLoading) {
                return e(Loader, { text: 'Loading student profile...' });
            }

            if (!student) {
                return e('div', { className: 'p-6' },
                    e('button', {
                        onClick: onBack,
                        className: 'mb-4 px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors'
                    }, '← Back'),
                    message && e(Message, {
                        type: message.type,
                        message: message.text
                    })
                );
            }

            return e('div', { className: 'p-6' },
                e('div', { className: 'flex items-center justify-between mb-6' },
                    e('div', { className: 'flex items-center' },
                        e('button', {
                            onClick: onBack,
                            className: 'mr-4 px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors'
                        }, '← Back'),
                        e('h1', { className: 'text-2xl font-bold text-gray-900' }, 
                            `${student.FirstName || 'Unknown'} ${student.LastName || 'Student'} - Student Profile`
                        )
                    )
                ),

                message && e('div', { className: 'mb-4' },
                    e(Message, {
                        type: message.type,
                        message: message.text,
                        onClose: () => setMessage(null)
                    })
                ),

                // Student Information Panel
                e('div', { className: 'grid grid-cols-1 lg:grid-cols-2 gap-6' },
                    // Basic Information
                    e('div', { className: 'bg-white rounded-xl shadow-card border border-gray-100 p-6' },
                        e('div', { className: 'flex items-center mb-6' },
                            e('div', { className: 'w-16 h-16 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center text-white font-bold text-xl mr-4' },
                                `${(student.FirstName || '').charAt(0)}${(student.LastName || '').charAt(0)}`.toUpperCase()
                            ),
                            e('div', null,
                                e('h2', { className: 'text-xl font-bold text-gray-900' }, 
                                    `${student.FirstName || 'Unknown'} ${student.LastName || 'Student'}`
                                ),
                                student.StudentStatus && e('span', { 
                                    className: `inline-block px-2 py-1 text-xs rounded-full mt-1 ${
                                        student.StudentStatus === 'Active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'
                                    }`
                                }, student.StudentStatus)
                            )
                        ),
                        e('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4' },
                            e('div', { className: 'space-y-4' },
                                e('div', null,
                                    e('div', { className: 'flex items-center mb-1' },
                                        e('svg', { className: 'w-4 h-4 text-gray-500 mr-2', fill: 'currentColor', viewBox: '0 0 20 20' },
                                            e('path', { d: 'M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z' }),
                                            e('path', { d: 'M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z' })
                                        ),
                                        e('label', { className: 'text-xs font-semibold text-gray-600 uppercase tracking-wide' }, 'Email')
                                    ),
                                    e('p', { className: 'text-sm text-gray-900 pl-6' }, student.PrimaryEmail || 'Not provided')
                                ),
                                e('div', null,
                                    e('div', { className: 'flex items-center mb-1' },
                                        e('svg', { className: 'w-4 h-4 text-gray-500 mr-2', fill: 'currentColor', viewBox: '0 0 20 20' },
                                            e('path', { d: 'M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z' })
                                        ),
                                        e('label', { className: 'text-xs font-semibold text-gray-600 uppercase tracking-wide' }, 'Phone')
                                    ),
                                    e('p', { className: 'text-sm text-gray-900 pl-6' }, student.PrimaryPhone || 'Not provided')
                                )
                            ),
                            e('div', { className: 'space-y-4' },
                                e('div', null,
                                    e('div', { className: 'flex items-center mb-1' },
                                        e('svg', { className: 'w-4 h-4 text-gray-500 mr-2', fill: 'currentColor', viewBox: '0 0 20 20' },
                                            e('path', { fillRule: 'evenodd', d: 'M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z', clipRule: 'evenodd' })
                                        ),
                                        e('label', { className: 'text-xs font-semibold text-gray-600 uppercase tracking-wide' }, 'Birthday')
                                    ),
                                    e('p', { className: 'text-sm text-gray-900 pl-6' }, 
                                        student.Birthday ? new Date(student.Birthday).toLocaleDateString() : 'Not provided'
                                    )
                                ),
                                student.EnrollmentDate && e('div', null,
                                    e('div', { className: 'flex items-center mb-1' },
                                        e('svg', { className: 'w-4 h-4 text-gray-500 mr-2', fill: 'currentColor', viewBox: '0 0 20 20' },
                                            e('path', { fillRule: 'evenodd', d: 'M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z', clipRule: 'evenodd' })
                                        ),
                                        e('label', { className: 'text-xs font-semibold text-gray-600 uppercase tracking-wide' }, 'Student Since')
                                    ),
                                    e('p', { className: 'text-sm text-gray-900 pl-6' }, 
                                        new Date(student.EnrollmentDate).toLocaleDateString()
                                    )
                                )
                            )
                        ),
                        student.CurrentLevel && e('div', { className: 'mt-6 pt-4 border-t border-gray-200' },
                            e('div', { className: 'flex items-center justify-between' },
                                e('span', { className: 'text-sm font-semibold text-gray-600' }, 'Current Level'),
                                e('span', { className: 'px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium' }, 
                                    `Level ${student.CurrentLevel}`
                                )
                            )
                        )
                    ),
                    
                    // Quick Stats Card
                    e('div', { className: 'bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg shadow-sm border border-blue-100 p-6' },
                        e('h2', { className: 'text-lg font-semibold text-gray-900 mb-4' }, 'Student Stats'),
                        e('div', { className: 'space-y-4' },
                            e('div', { className: 'bg-white rounded-lg p-4 shadow-sm' },
                                e('div', { className: 'flex items-center justify-between' },
                                    e('div', null,
                                        e('p', { className: 'text-xs font-medium text-gray-600 uppercase tracking-wide' }, 'Total Enrollments'),
                                        e('p', { className: 'text-2xl font-bold text-gray-900 mt-1' }, 
                                            student.Enrollments ? student.Enrollments.length : 0
                                        )
                                    ),
                                    e('div', { className: 'w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center' },
                                        e('svg', { className: 'w-6 h-6 text-blue-600', fill: 'currentColor', viewBox: '0 0 20 20' },
                                            e('path', { d: 'M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3zM3.31 9.397L5 10.12v4.102a8.969 8.969 0 00-1.05-.174 1 1 0 01-.89-.89 11.115 11.115 0 01.25-3.762zM9.3 16.573A9.026 9.026 0 007 14.935v-3.957l1.818.78a3 3 0 002.364 0l5.508-2.361a11.026 11.026 0 01.25 3.762 1 1 0 01-.89.89 8.968 8.968 0 00-5.35 2.524 1 1 0 01-1.4 0zM6 18a1 1 0 001-1v-2.065a8.935 8.935 0 00-2-.712V17a1 1 0 001 1z' })
                                        )
                                    )
                                )
                            ),
                            student.Enrollments && e('div', { className: 'bg-white rounded-lg p-4 shadow-sm' },
                                e('div', { className: 'flex items-center justify-between' },
                                    e('div', null,
                                        e('p', { className: 'text-xs font-medium text-gray-600 uppercase tracking-wide' }, 'Completed Classes'),
                                        e('p', { className: 'text-2xl font-bold text-green-600 mt-1' }, 
                                            student.Enrollments.filter(e => e.CompletionStatus === 'Completed').length
                                        )
                                    ),
                                    e('div', { className: 'w-12 h-12 bg-green-100 rounded-full flex items-center justify-center' },
                                        e('svg', { className: 'w-6 h-6 text-green-600', fill: 'currentColor', viewBox: '0 0 20 20' },
                                            e('path', { fillRule: 'evenodd', d: 'M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z', clipRule: 'evenodd' })
                                        )
                                    )
                                )
                            ),
                            student.Enrollments && e('div', { className: 'bg-white rounded-lg p-4 shadow-sm' },
                                e('div', { className: 'flex items-center justify-between' },
                                    e('div', null,
                                        e('p', { className: 'text-xs font-medium text-gray-600 uppercase tracking-wide' }, 'Active Classes'),
                                        e('p', { className: 'text-2xl font-bold text-blue-600 mt-1' }, 
                                            student.Enrollments.filter(e => 
                                                e.CompletionStatus === 'Active' || 
                                                e.CompletionStatus === 'In Progress' || 
                                                e.CompletionStatus === 'Enrolled'
                                            ).length
                                        )
                                    ),
                                    e('div', { className: 'w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center' },
                                        e('svg', { className: 'w-6 h-6 text-blue-600', fill: 'currentColor', viewBox: '0 0 20 20' },
                                            e('path', { fillRule: 'evenodd', d: 'M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z', clipRule: 'evenodd' })
                                        )
                                    )
                                )
                            )
                        )
                    )
                ),

                // Enrollment History
                student.Enrollments && student.Enrollments.length > 0 && e('div', { className: 'mt-6 bg-white rounded-xl shadow-card border border-gray-100 p-6' },
                    e('div', { className: 'flex items-center justify-between mb-6' },
                        e('h2', { className: 'text-xl font-bold text-gray-900' }, 'Enrollment History'),
                        e('span', { className: 'text-sm text-gray-600 bg-gray-100 px-3 py-1 rounded-full' }, 
                            `${student.Enrollments.length} total enrollment${student.Enrollments.length !== 1 ? 's' : ''}`
                        )
                    ),
                    e('div', { className: 'overflow-x-auto' },
                        e('table', { className: 'min-w-full' },
                            e('thead', null,
                                e('tr', { className: 'border-b-2 border-gray-200' },
                                    e('th', { className: 'px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider' }, 'Class Level'),
                                    e('th', { className: 'px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider' }, 'Instructor'),
                                    e('th', { className: 'px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider' }, 'Enrolled'),
                                    e('th', { className: 'px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider' }, 'Completed'),
                                    e('th', { className: 'px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider' }, 'Status')
                                )
                            ),
                            e('tbody', { className: 'divide-y divide-gray-200' },
                                student.Enrollments
                                    .sort((a, b) => {
                                        // Sort by enrollment date descending (newest first)
                                        const dateA = a.EnrollmentDate ? new Date(a.EnrollmentDate) : new Date(0);
                                        const dateB = b.EnrollmentDate ? new Date(b.EnrollmentDate) : new Date(0);
                                        return dateB - dateA;
                                    })
                                    .map((enrollment, index) =>
                                    e('tr', { 
                                        key: index,
                                        className: 'hover:bg-gray-50 transition-colors'
                                    },
                                        e('td', { className: 'px-6 py-4' }, 
                                            e('div', { className: 'flex items-center' },
                                                e('div', { 
                                                    className: `w-2 h-2 rounded-full mr-3 ${
                                                        enrollment.CompletionStatus === 'Completed' ? 'bg-blue-500' :
                                                        enrollment.CompletionStatus === 'In Progress' || enrollment.CompletionStatus === 'Active' ? 'bg-green-500' :
                                                        enrollment.CompletionStatus === 'Dropped' || enrollment.CompletionStatus === 'Withdrawn' ? 'bg-red-500' :
                                                        'bg-gray-400'
                                                    }`
                                                }),
                                                e('span', { className: 'text-sm font-medium text-gray-900' }, 
                                                    enrollment.ClassLevelName || `Offering ${enrollment.OfferingID}`
                                                )
                                            )
                                        ),
                                        e('td', { className: 'px-6 py-4 text-sm text-gray-600' }, 
                                            enrollment.TeacherName || e('span', { className: 'italic text-gray-400' }, 'N/A')
                                        ),
                                        e('td', { className: 'px-6 py-4 text-sm text-gray-600' }, 
                                            enrollment.EnrollmentDate ? new Date(enrollment.EnrollmentDate).toLocaleDateString('en-US', { 
                                                month: 'short', 
                                                day: 'numeric', 
                                                year: 'numeric' 
                                            }) : e('span', { className: 'italic text-gray-400' }, 'Unknown')
                                        ),
                                        e('td', { className: 'px-6 py-4 text-sm text-gray-600' }, 
                                            enrollment.CompletionDate ? new Date(enrollment.CompletionDate).toLocaleDateString('en-US', { 
                                                month: 'short', 
                                                day: 'numeric', 
                                                year: 'numeric' 
                                            }) : e('span', { className: 'text-gray-400' }, '—')
                                        ),
                                        e('td', { className: 'px-6 py-4' },
                                            e('span', { 
                                                className: `inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                                                    enrollment.CompletionStatus === 'Completed' ? 'bg-blue-100 text-blue-800' :
                                                    enrollment.CompletionStatus === 'In Progress' || enrollment.CompletionStatus === 'Active' ? 'bg-green-100 text-green-800' :
                                                    enrollment.CompletionStatus === 'Dropped' || enrollment.CompletionStatus === 'Withdrawn' ? 'bg-red-100 text-red-800' :
                                                    'bg-gray-100 text-gray-800'
                                                }`
                                            }, enrollment.CompletionStatus || enrollment.Status || 'Unknown')
                                        )
                                    )
                                )
                            )
                        )
                    )
                )
            );
        }

        // CastCard Component
        function CastCard({ castMember, onClick, onRemove }) {
            const getInitials = (firstName, lastName) => {
                const first = (firstName || '').trim();
                const last = (lastName || '').trim();
                return `${first.charAt(0)}${last.charAt(0)}`.toUpperCase() || '??';
            };
            const formatDate = (dateString) => {
                if (!dateString) return 'TBD';
                try { return new Date(dateString).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }); }
                catch { return dateString; }
            };
            const fullName = `${castMember.FirstName || ''} ${castMember.LastName || ''}`.trim() || 'Unknown Name';
            return e('div', {
                onClick: onClick,
                className: 'data-card bg-white rounded-xl shadow-card border border-gray-100 p-4 cursor-pointer flex flex-col gap-3'
            },
                e('div', { className: 'flex items-center gap-3' },
                    e('div', { className: 'w-10 h-10 bg-violet-100 rounded-full flex items-center justify-center text-violet-700 text-sm font-bold flex-shrink-0' },
                        getInitials(castMember.FirstName, castMember.LastName)
                    ),
                    e('div', { className: 'flex-1 min-w-0' },
                        e('h3', { className: 'font-semibold text-sm text-gray-900 truncate' }, fullName),
                        e('p', { className: 'text-xs text-gray-500 truncate' }, castMember.PrimaryEmail || 'No email')
                    ),
                    castMember.Status && e('span', {
                        className: `text-xs font-medium px-2 py-0.5 rounded-full flex-shrink-0 ${
                            castMember.Status === 'Active' ? 'bg-emerald-100 text-emerald-700' : 'bg-gray-100 text-gray-500'
                        }`
                    }, castMember.Status)
                ),
                e('div', { className: 'grid grid-cols-2 gap-x-3 gap-y-1' },
                    e('div', null,
                        e('p', { className: 'text-xs text-gray-400 uppercase tracking-wide font-medium' }, 'Last Show'),
                        e('p', { className: 'text-xs text-gray-700 font-medium' }, formatDate(castMember.LastShowDate))
                    ),
                    e('div', null,
                        e('p', { className: 'text-xs text-gray-400 uppercase tracking-wide font-medium' }, 'Phone'),
                        e('p', { className: 'text-xs text-gray-700 font-medium truncate' }, castMember.PrimaryPhone || '—')
                    )
                ),
                onRemove && e('button', {
                    onClick: (ev) => { ev.stopPropagation(); onRemove(castMember.CastMemberID); },
                    className: 'w-full px-3 py-1.5 text-xs font-semibold text-red-600 bg-red-50 rounded-lg hover:bg-red-100 transition-colors border border-red-100'
                }, 'Remove from Cast')
            );
        }

        // Show color palettes — one set per show, cycles after 8 shows
        const SHOW_COLORS = [
            'bg-violet-100 text-violet-700 border-violet-200',
            'bg-sky-100 text-sky-700 border-sky-200',
            'bg-amber-100 text-amber-700 border-amber-200',
            'bg-rose-100 text-rose-700 border-rose-200',
            'bg-emerald-100 text-emerald-700 border-emerald-200',
            'bg-orange-100 text-orange-700 border-orange-200',
            'bg-pink-100 text-pink-700 border-pink-200',
            'bg-cyan-100 text-cyan-700 border-cyan-200',
        ];
        const SHOW_HEADER_COLORS = [
            'bg-violet-600 text-white',
            'bg-sky-600 text-white',
            'bg-amber-500 text-white',
            'bg-rose-600 text-white',
            'bg-emerald-600 text-white',
            'bg-orange-500 text-white',
            'bg-pink-600 text-white',
            'bg-cyan-600 text-white',
        ];

        // CrewCard Component
        function CrewCard({ crewMember, onClick, showColorClasses }) {
            const displayLastName = crewMember.LastName || crewMember.Lastname || '';
            const getInitials = (firstName, lastName) => {
                const first = (firstName || '').trim();
                const last = (lastName || '').trim();
                return `${first.charAt(0)}${last.charAt(0)}`.toUpperCase() || '??';
            };
            const formatDate = (dateString) => {
                if (!dateString || dateString === 'N/A') return '—';
                try { return new Date(dateString).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }); } catch { return dateString; }
            };
            const badgeClasses = showColorClasses || 'bg-gray-100 text-gray-600 border-gray-200';
            const fullName = `${crewMember.FirstName || ''} ${displayLastName}`.trim() || 'Unknown Name';

            return e('div', {
                onClick: onClick,
                className: 'data-card bg-white rounded-xl shadow-card border border-gray-100 cursor-pointer overflow-hidden'
            },
                crewMember.ShowName && e('div', {
                    className: `px-3 py-1.5 text-xs font-semibold border-b truncate ${badgeClasses}`
                }, crewMember.ShowName),
                e('div', { className: 'p-4 flex flex-col gap-3' },
                    e('div', { className: 'flex items-center gap-3' },
                        e('div', { className: 'w-10 h-10 bg-teal-100 rounded-full flex items-center justify-center text-teal-700 text-sm font-bold flex-shrink-0' },
                            getInitials(crewMember.FirstName, displayLastName)
                        ),
                        e('div', { className: 'flex-1 min-w-0' },
                            e('h3', { className: 'font-semibold text-sm text-gray-900 truncate' }, fullName),
                            e('p', { className: 'text-xs text-gray-500 truncate' }, crewMember.PrimaryEmail || 'No email')
                        ),
                        crewMember.Status && e('span', {
                            className: `text-xs font-medium px-2 py-0.5 rounded-full flex-shrink-0 ${
                                crewMember.Status === 'Active' ? 'bg-emerald-100 text-emerald-700' : 'bg-gray-100 text-gray-500'
                            }`
                        }, crewMember.Status)
                    ),
                    e('div', { className: 'grid grid-cols-2 gap-x-3 gap-y-1' },
                        e('div', null,
                            e('p', { className: 'text-xs text-gray-400 uppercase tracking-wide font-medium' }, 'Duty'),
                            e('p', { className: 'text-xs text-gray-800 font-semibold' }, crewMember.DutyName || '—')
                        ),
                        e('div', null,
                            e('p', { className: 'text-xs text-gray-400 uppercase tracking-wide font-medium' }, 'Date'),
                            e('p', { className: 'text-xs text-gray-700 font-medium' }, formatDate(crewMember.ShowDate || crewMember.LastShowDate))
                        )
                    )
                )
            );
        }

        // PersonnelModal Component - FIXED VERSION
        function PersonnelModal({ isOpen, mode, person, onClose, onSave, onEdit, onDelete }) {
            const [formData, setFormData] = useState({
                FirstName: '',
                Lastname: '',
                PrimaryEmail: '',
                PrimaryPhone: '',
                Instagram: '',
                Birthday: ''
            });
            const [isLoading, setIsLoading] = useState(false); // FIXED: Added missing isLoading state

            useEffect(() => {
                if (person) {
                    setFormData(person);
                } else {
                    setFormData({
                        FirstName: '',
                        Lastname: '',
                        PrimaryEmail: '',
                        PrimaryPhone: '',
                        Instagram: '',
                        Birthday: ''
                    });
                }
            }, [person, isOpen]);

            const handleInputChange = (field, value) => {
                setFormData(prev => ({ ...prev, [field]: value }));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsLoading(true);
                
                try {
                    await onSave(formData);
                    onClose();
                } catch (error) {
                    console.error('Error saving personnel:', error);
                } finally {
                    setIsLoading(false);
                }
            };

            if (!isOpen) return null;

            const isEditable = mode === 'edit' || mode === 'create';
            const title = mode === 'create' ? 'Add New Personnel' : 
                         mode === 'edit' ? 'Edit Personnel' : 'Personnel Details';

            return e('div', { className: 'fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4' },
                e('div', { className: 'modal-panel bg-white rounded-2xl shadow-modal max-w-2xl w-full mx-auto max-h-[90vh] overflow-y-auto' },
                    e('div', { className: 'flex justify-between items-center px-6 py-5 border-b border-gray-100' },
                        e('h2', { className: 'text-lg font-bold text-gray-900' }, title),
                        e('button', {
                            onClick: onClose,
                            className: 'w-8 h-8 flex items-center justify-center rounded-lg text-gray-400 hover:text-gray-600 hover:bg-gray-100 transition-colors text-xl leading-none font-light'
                        }, '×')
                    ),

                    isLoading ? e('div', { className: 'p-8' }, e(Loader)) : 
                    e('form', { onSubmit: handleSubmit, className: 'p-6' },
                        e('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4 mb-6' },
                            // First Name
                            e('div', null,
                                e('label', { className: 'block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1.5' }, 'First Name'),
                                isEditable ? 
                                e('input', {
                                    type: 'text',
                                    value: formData.FirstName || '',
                                    onChange: (e) => handleInputChange('FirstName', e.target.value),
                                    className: 'w-full px-3 py-2.5 text-sm border border-gray-200 rounded-lg bg-gray-50 focus:bg-white focus:border-sky-400 transition-colors',
                                    required: true
                                }) :
                                e('p', { className: 'py-2 text-sm text-gray-900 font-medium' }, formData.FirstName)
                            ),
                            
                            // Last Name
                            e('div', null,
                                e('label', { className: 'block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1.5' }, 'Last Name'),
                                isEditable ? 
                                e('input', {
                                    type: 'text',
                                    value: formData.LastName || '',
                                    onChange: (e) => handleInputChange('Lastname', e.target.value),
                                    className: 'w-full px-3 py-2.5 text-sm border border-gray-200 rounded-lg bg-gray-50 focus:bg-white focus:border-sky-400 transition-colors',
                                    required: true
                                }) :
                                e('p', { className: 'py-2 text-sm text-gray-900 font-medium' }, formData.LastName)
                            ),

                            // Email
                            e('div', null,
                                e('label', { className: 'block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1.5' }, 'Email'),
                                isEditable ? 
                                e('input', {
                                    type: 'email',
                                    value: formData.PrimaryEmail || '',
                                    onChange: (e) => handleInputChange('PrimaryEmail', e.target.value),
                                    className: 'w-full px-3 py-2.5 text-sm border border-gray-200 rounded-lg bg-gray-50 focus:bg-white focus:border-sky-400 transition-colors',
                                    required: true
                                }) :
                                e('p', { className: 'py-2 text-sm text-gray-900 font-medium' }, formData.PrimaryEmail)
                            ),

                            // Phone
                            e('div', null,
                                e('label', { className: 'block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1.5' }, 'Phone'),
                                isEditable ? 
                                e('input', {
                                    type: 'tel',
                                    value: formData.PrimaryPhone || '',
                                    onChange: (e) => handleInputChange('PrimaryPhone', e.target.value),
                                    className: 'w-full px-3 py-2.5 text-sm border border-gray-200 rounded-lg bg-gray-50 focus:bg-white focus:border-sky-400 transition-colors'
                                }) :
                                e('p', { className: 'py-2 text-sm text-gray-900 font-medium' }, formData.PrimaryPhone)
                            ),

                            // Instagram
                            e('div', null,
                                e('label', { className: 'block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1.5' }, 'Instagram'),
                                isEditable ? 
                                e('input', {
                                    type: 'text',
                                    value: formData.Instagram || '',
                                    onChange: (e) => handleInputChange('Instagram', e.target.value),
                                    className: 'w-full px-3 py-2.5 text-sm border border-gray-200 rounded-lg bg-gray-50 focus:bg-white focus:border-sky-400 transition-colors',
                                    placeholder: '@username'
                                }) :
                                e('p', { className: 'py-2 text-sm text-gray-900 font-medium' }, formData.Instagram)
                            ),

                            // Birthday
                            e('div', null,
                                e('label', { className: 'block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1.5' }, 'Birthday'),
                                isEditable ? 
                                e('input', {
                                    type: 'date',
                                    value: formData.Birthday ? formData.Birthday.toString().split('T')[0] : '',
                                    onChange: (e) => handleInputChange('Birthday', e.target.value),
                                    className: 'w-full px-3 py-2.5 text-sm border border-gray-200 rounded-lg bg-gray-50 focus:bg-white focus:border-sky-400 transition-colors'
                                }) :
                                e('p', { className: 'py-2 text-sm text-gray-900 font-medium' }, 
                                    formData.Birthday ? new Date(formData.Birthday).toLocaleDateString() : ''
                                )
                            )
                        ),

                        e('div', { className: 'flex justify-end gap-2 pt-4 border-t border-gray-100' },
                            e('button', {
                                type: 'button',
                                onClick: onClose,
                                className: 'px-4 py-2 text-sm font-medium text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors'
                            }, mode === 'view' ? 'Close' : 'Cancel'),
                            
                            // Edit and Delete buttons for view mode
                            mode === 'view' && person && [
                                e('button', {
                                    key: 'edit',
                                    type: 'button',
                                    onClick: onEdit,
                                    className: 'btn-primary px-4 py-2 text-sm font-semibold text-white rounded-lg'
                                }, 'Edit'),
                                e('button', {
                                    key: 'delete',
                                    type: 'button',
                                    onClick: onDelete,
                                    className: 'btn-danger px-4 py-2 text-sm font-semibold text-white rounded-lg'
                                }, 'Delete')
                            ],
                            
                            isEditable && e('button', {
                                type: 'submit',
                                disabled: isLoading,
                                className: 'btn-primary px-5 py-2 text-sm font-semibold text-white rounded-lg disabled:opacity-50'
                            }, mode === 'create' ? 'Create' : 'Save Changes')
                        )
                    )
                )
            );
        }

        // Dashboard Component
        // READS FROM: Multiple Google Sheets via getDashboardStats()
        // DATA SOURCES: Personnel, ShowInformation, ClassOfferings, StudentEnrollments,
        //               StudentInfo, CastMemberInfo, CrewDuties, Bartenders sheets
        function Dashboard() {
            const [stats, setStats] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [loadedAt, setLoadedAt] = useState(null);

            useEffect(() => {
                loadDashboardData();
            }, []);

            const loadDashboardData = async () => {
                try {
                    const response = await gasService.getDashboardStats();
                    if (response.success && response.data) {
                        setStats(response.data);
                        setLoadedAt(new Date().toLocaleTimeString());
                    }
                } catch (error) {
                    console.error('Error loading dashboard data:', error);
                } finally {
                    setIsLoading(false);
                }
            };

            if (isLoading) {
                return e(Loader, { text: 'Loading dashboard...' });
            }

            if (!stats) {
                return e('div', { className: 'p-6' },
                    e('h1', { className: 'text-2xl font-bold text-gray-900 mb-6' }, 'Dashboard'),
                    e('p', { className: 'text-gray-600' }, 'Unable to load dashboard data.')
                );
            }

            // ── Segmented status bar helper ──────────────────────────────────
            // segments: [{ label, count, color (tailwind bg-*) }]
            function SegmentedBar({ segments }) {
                const total = segments.reduce((s, seg) => s + (seg.count || 0), 0);
                return e('div', null,
                    e('div', { className: 'flex rounded-full overflow-hidden h-2.5 mb-2 bg-gray-100' },
                        ...segments.map((seg, i) => {
                            const pct = total > 0 ? Math.round((seg.count || 0) / total * 100) : 0;
                            return e('div', {
                                key: i,
                                title: `${seg.label}: ${seg.count}`,
                                className: `${seg.color} h-2.5 transition-all`,
                                style: { width: `${pct}%` }
                            });
                        })
                    ),
                    e('div', { className: 'flex flex-wrap gap-x-4 gap-y-1' },
                        ...segments.map((seg, i) => {
                            const pct = total > 0 ? Math.round((seg.count || 0) / total * 100) : 0;
                            return e('div', { key: i, className: 'flex items-center gap-1.5 text-xs text-gray-600' },
                                e('span', { className: `inline-block w-2.5 h-2.5 rounded-full ${seg.color}` }),
                                e('span', null, `${seg.label}: `),
                                e('span', { className: 'font-semibold text-gray-800' }, seg.count),
                                e('span', { className: 'text-gray-400' }, `(${pct}%)`)
                            );
                        })
                    )
                );
            }

            // ── Enrollment progress bar helper ───────────────────────────────
            function EnrollmentBar({ levelName, enrolled, max, status }) {
                const safeMax = max > 0 ? max : 1;
                const pct = Math.min(100, Math.round(enrolled / safeMax * 100));
                const barColor = pct >= 90 ? 'bg-red-500' : pct >= 70 ? 'bg-yellow-500' : 'bg-primary-500';
                const badgeClass = status === 'In Progress'
                    ? 'bg-blue-100 text-blue-700'
                    : 'bg-emerald-100 text-emerald-700';
                return e('div', { className: 'mb-3 last:mb-0' },
                    e('div', { className: 'flex justify-between items-center mb-1' },
                        e('div', { className: 'flex items-center gap-2 min-w-0' },
                            e('span', { className: 'text-sm font-medium text-gray-800 truncate' }, levelName),
                            e('span', { className: `text-xs px-1.5 py-0.5 rounded-full font-medium flex-shrink-0 ${badgeClass}` }, status)
                        ),
                        e('span', { className: 'text-sm text-gray-600 flex-shrink-0 ml-2' }, `${enrolled} / ${max}`)
                    ),
                    e('div', { className: 'w-full bg-gray-200 rounded-full h-2' },
                        e('div', {
                            className: `${barColor} h-2 rounded-full transition-all`,
                            style: { width: `${pct}%` }
                        })
                    )
                );
            }

            // ── Date formatter ────────────────────────────────────────────────
            function formatShowDate(dateStr) {
                if (!dateStr) return 'TBD';
                try {
                    return new Date(dateStr).toLocaleDateString('en-US', {
                        weekday: 'short', month: 'short', day: 'numeric', year: 'numeric'
                    });
                } catch(err) { return String(dateStr); }
            }

            // ── Metric tile (compact, used in Personnel Breakdown grid) ───────
            function MetricTile({ value, label, color }) {
                const bg = color === 'blue'   ? 'bg-blue-50   border-blue-100'
                         : color === 'green'  ? 'bg-green-50  border-green-100'
                         : color === 'purple' ? 'bg-purple-50 border-purple-100'
                         : color === 'orange' ? 'bg-orange-50 border-orange-100'
                         : 'bg-gray-50 border-gray-100';
                const text = color === 'blue'   ? 'text-blue-700'
                           : color === 'green'  ? 'text-green-700'
                           : color === 'purple' ? 'text-purple-700'
                           : color === 'orange' ? 'text-orange-700'
                           : 'text-gray-700';
                return e('div', { className: `text-center p-3 rounded-lg border ${bg}` },
                    e('p', { className: `text-2xl font-bold ${text}` }, value),
                    e('p', { className: 'text-xs text-gray-600 mt-0.5 leading-tight' }, label)
                );
            }

            return e('div', { className: 'p-6 max-w-screen-xl' },

                // ── Header ───────────────────────────────────────────────────
                e('div', { className: 'flex justify-between items-center mb-6' },
                    e('div', null,
                        e('h1', { className: 'text-2xl font-bold text-gray-900' }, 'Dashboard'),
                        e('p', { className: 'text-sm text-gray-500 mt-0.5' }, 'JTF Team overview')
                    ),
                    loadedAt && e('p', { className: 'text-xs text-gray-400 bg-white border border-gray-100 px-3 py-1.5 rounded-lg shadow-sm' }, `Updated ${loadedAt}`)
                ),

                // ── ROW 1: KPI Cards (6 up) ──────────────────────────────────
                e('div', { className: 'grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3 mb-6' },
                    e(StatCard, { title: 'Total Personnel', value: stats.totalPersonnel,                          icon: '👥', color: 'blue'   }),
                    e(StatCard, { title: 'Active Students',  value: stats.studentsActive || stats.activeStudents, icon: '🎓', color: 'green'  }),
                    e(StatCard, { title: 'Scheduled Shows',  value: stats.scheduledShows,                        icon: '🎪', color: 'purple' }),
                    e(StatCard, { title: 'Active Classes',   value: stats.activeClasses,                         icon: '📚', color: 'orange' }),
                    e(StatCard, { title: 'Cast Members',     value: stats.totalCastMembers,                      icon: '🎭', color: 'blue'   }),
                    e(StatCard, { title: 'Bartenders',       value: stats.activeBartenders || stats.totalBartenders, icon: '🍺', color: 'green' })
                ),

                // ── ROW 2: Status Distribution Panels ───────────────────────
                e('div', { className: 'grid grid-cols-1 md:grid-cols-3 gap-3 mb-6' },

                    // Show Status
                    e('div', { className: 'bg-white rounded-xl shadow-card border border-gray-100 p-5' },
                        e('h2', { className: 'text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1' }, 'Show Status'),
                        e('p', { className: 'text-2xl font-bold text-gray-900 mb-3' }, `${stats.totalShows} Total`),
                        e(SegmentedBar, {
                            segments: [
                                { label: 'Scheduled', count: stats.scheduledShows, color: 'bg-violet-500' },
                                { label: 'Canceled',  count: stats.canceledShows,  color: 'bg-red-400'   }
                            ]
                        })
                    ),

                    // Student Status
                    e('div', { className: 'bg-white rounded-xl shadow-card border border-gray-100 p-5' },
                        e('h2', { className: 'text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1' }, 'Student Status'),
                        e('p', { className: 'text-2xl font-bold text-gray-900 mb-3' }, `${stats.totalStudents} Total`),
                        e(SegmentedBar, {
                            segments: [
                                { label: 'Active',    count: stats.studentsActive,    color: 'bg-emerald-500' },
                                { label: 'Inactive',  count: stats.studentsInactive,  color: 'bg-gray-300'    },
                                { label: 'Graduated', count: stats.studentsGraduated, color: 'bg-sky-400'     }
                            ]
                        })
                    ),

                    // Class Status
                    e('div', { className: 'bg-white rounded-xl shadow-card border border-gray-100 p-5' },
                        e('h2', { className: 'text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1' }, 'Class Status'),
                        e('p', { className: 'text-2xl font-bold text-gray-900 mb-3' }, `${stats.totalClasses} Total`),
                        e(SegmentedBar, {
                            segments: [
                                { label: 'Upcoming',    count: stats.upcomingClasses,    color: 'bg-amber-400'  },
                                { label: 'In Progress', count: stats.inProgressClasses,  color: 'bg-sky-500'    },
                                { label: 'Completed',   count: stats.completedClasses,   color: 'bg-emerald-400'},
                                { label: 'Cancelled',   count: stats.cancelledClasses,   color: 'bg-red-300'    }
                            ]
                        })
                    )
                ),

                // ── ROW 3: Detail Panels ─────────────────────────────────────
                e('div', { className: 'grid grid-cols-1 lg:grid-cols-2 gap-3' },

                    // Active Class Enrollment
                    e('div', { className: 'bg-white rounded-xl shadow-card border border-gray-100 p-5' },
                        e('div', { className: 'flex justify-between items-center mb-4' },
                            e('h2', { className: 'text-xs font-semibold text-gray-400 uppercase tracking-wider' }, 'Active Class Enrollment'),
                            e('span', { className: 'text-xs text-gray-500 bg-gray-100 px-2.5 py-1 rounded-full font-medium' },
                                `${stats.totalEnrollments} enrollments`
                            )
                        ),
                        stats.classEnrollmentData && stats.classEnrollmentData.length > 0
                            ? e('div', null,
                                ...stats.classEnrollmentData.map((cls, i) =>
                                    e(EnrollmentBar, {
                                        key: cls.OfferingID || i,
                                        levelName:    cls.LevelName,
                                        enrolled:     cls.EnrolledCount,
                                        max:          cls.MaxStudents,
                                        status:       cls.Status
                                    })
                                )
                            )
                            : e('p', { className: 'text-sm text-gray-400 text-center py-8' },
                                'No active classes at this time.'
                            )
                    ),

                    // Right column — Next Show + Personnel Breakdown
                    e('div', { className: 'flex flex-col gap-3' },

                        // Next Upcoming Show
                        e('div', { className: 'bg-white rounded-xl shadow-card border border-gray-100 p-5' },
                            e('h2', { className: 'text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3' }, 'Next Upcoming Show'),
                            stats.nextShow
                                ? e('div', null,
                                    e('p', { className: 'text-lg font-bold text-gray-900' },
                                        formatShowDate(stats.nextShow.ShowDate)
                                    ),
                                    e('div', { className: 'flex flex-wrap gap-4 mt-2' },
                                        stats.nextShow.ShowTime && e('span', { className: 'text-sm text-gray-600' },
                                            '🕐 ' + stats.nextShow.ShowTime
                                        ),
                                        stats.nextShow.Venue && e('span', { className: 'text-sm text-gray-600' },
                                            '📍 ' + stats.nextShow.Venue
                                        )
                                    )
                                )
                                : e('p', { className: 'text-sm text-gray-400' }, 'No upcoming shows scheduled.')
                        ),

                        // Personnel Breakdown
                        e('div', { className: 'bg-white rounded-xl shadow-card border border-gray-100 p-5' },
                            e('h2', { className: 'text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3' }, 'Personnel Breakdown'),
                            e('div', { className: 'grid grid-cols-2 gap-3' },
                                e(MetricTile, { value: stats.studentsActive || stats.activeStudents, label: 'Active Students',  color: 'green'  }),
                                e(MetricTile, { value: stats.studentsGraduated,                      label: 'Graduated',        color: 'blue'   }),
                                e(MetricTile, { value: stats.totalCastMembers,                       label: 'Cast Members',     color: 'purple' }),
                                e(MetricTile, { value: stats.totalCrewMembers,                       label: 'Crew Members',     color: 'orange' })
                            )
                        )
                    )
                )
            );
        }

        // PersonnelDirectory Component
        // FULL CRUD OPERATIONS: Create, Read, Update, Delete personnel records
        // DATA SOURCE: Personnel sheet (PersonnelID, FirstName, Lastname, PrimaryEmail, etc.)
        function PersonnelDirectory() {
            const [personnel, setPersonnel] = useState([]);
            const [filteredPersonnel, setFilteredPersonnel] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedPerson, setSelectedPerson] = useState(null);
            const [modalMode, setModalMode] = useState('view');
            const [message, setMessage] = useState(null);
            const [sortBy, setSortBy] = useState('az');

            useEffect(() => {
                loadPersonnel();
            }, []);

            useEffect(() => {
                const name = p => `${p.FirstName || ''} ${p.LastName || p.Lastname || ''}`.toLowerCase();
                let filtered = personnel.filter(person =>
                    name(person).includes(searchTerm.toLowerCase()) ||
                    (person.PrimaryEmail || '').toLowerCase().includes(searchTerm.toLowerCase())
                );
                if (sortBy === 'az') filtered = [...filtered].sort((a, b) => name(a).localeCompare(name(b)));
                else if (sortBy === 'za') filtered = [...filtered].sort((a, b) => name(b).localeCompare(name(a)));
                setFilteredPersonnel(filtered);
            }, [personnel, searchTerm, sortBy]);

            const loadPersonnel = async () => {
                setIsLoading(true);
                console.log('Loading personnel...');
                console.log('isDevelopment:', isDevelopment);
                console.log('gasService:', gasService);
                
                try {
                    // STEP 1: First run debug function to test connection
                    console.log('=== RUNNING DEBUG TEST ===');
                    const debugResponse = await gasService.debugPersonnelSheet();
                    console.log('Debug response:', debugResponse);
                    
                    if (debugResponse && !debugResponse.success) {
                        setMessage({ 
                            type: 'error', 
                            text: `Debug failed: ${debugResponse.error}. Available sheets: ${debugResponse.availableSheets?.join(', ') || 'unknown'}` 
                        });
                        return;
                    }
                    
                    if (debugResponse && debugResponse.success) {
                        console.log('✓ Debug test passed! Sheet details:', {
                            dimensions: debugResponse.dimensions,
                            headers: debugResponse.headers,
                            sampleData: debugResponse.sampleData
                        });
                    }
                    
                    // STEP 2: Now try the regular getAllPersonnel function
                    console.log('=== RUNNING REGULAR getAllPersonnel ===');
                    const response = await gasService.getAllPersonnel();
                    console.log('Personnel response:', response);
                    console.log('Response type:', typeof response);
                    console.log('Response.success:', response.success);
                    console.log('Response.data:', response.data);
                    
                    if (response && response.success && response.data) {
                        setPersonnel(response.data);
                        console.log('Personnel data loaded:', response.data.length, 'records');
                    } else {
                        console.error('Personnel loading failed. Full response:', response);
                        let errorMsg = 'Failed to load personnel from Google Sheets';
                        
                        if (response && response.success && response.data === null) {
                            errorMsg = 'getAllPersonnel returned null. Check the getAllPersonnel function in Code.gs for errors.';
                        } else if (response && !response.success) {
                            errorMsg = `Google Apps Script error: ${response.error}`;
                        }
                        
                        setMessage({ type: 'error', text: errorMsg });
                    }
                } catch (error) {
                    console.error('Personnel loading error:', error);
                    console.error('Error stack:', error.stack);
                    setMessage({ type: 'error', text: 'Error loading personnel data: ' + error.message });
                } finally {
                    setIsLoading(false);
                }
            };

            const [isEditing, setIsEditing] = useState(false);
            const [editFormData, setEditFormData] = useState({});
            const [isSaving, setIsSaving] = useState(false);
            const [isCreateModalOpen, setIsCreateModalOpen] = useState(false);

            const handlePersonClick = (person) => {
                setSelectedPerson(person);
                setIsEditing(false);
                setEditFormData(person);
            };

            const handleAddNew = () => {
                setSelectedPerson(null);
                setModalMode('create');
                setIsCreateModalOpen(true);
            };

            const handleSavePerson = async (personData) => {
                try {
                    let response;
                    if (modalMode === 'create') {
                        response = await gasService.createPersonnel(personData);
                    } else {
                        response = await gasService.updatePersonnel(personData);
                    }
                    if (response.success) {
                        setMessage({ type: 'success', text: modalMode === 'create' ? 'Personnel created successfully' : 'Personnel updated successfully' });
                        loadPersonnel();
                    } else {
                        setMessage({ type: 'error', text: response.error || 'Failed to save personnel' });
                    }
                } catch (error) {
                    setMessage({ type: 'error', text: 'Error saving personnel' });
                }
            };

            const handleSaveEdit = async () => {
                setIsSaving(true);
                try {
                    const response = await gasService.updatePersonnel(editFormData);
                    if (response.success) {
                        setMessage({ type: 'success', text: 'Personnel updated successfully' });
                        setSelectedPerson(editFormData);
                        setIsEditing(false);
                        loadPersonnel();
                    } else {
                        setMessage({ type: 'error', text: response.error || 'Failed to save' });
                    }
                } catch (error) {
                    setMessage({ type: 'error', text: 'Error saving personnel' });
                } finally {
                    setIsSaving(false);
                }
            };

            const handleDeletePerson = async () => {
                if (selectedPerson) {
                    const confirmDelete = confirm(`Are you sure you want to delete ${selectedPerson.FirstName} ${selectedPerson.LastName}? This action cannot be undone.`);
                    if (confirmDelete) {
                        try {
                            const response = await gasService.deletePersonnel(selectedPerson.PersonnelID);
                            if (response.success) {
                                setMessage({ type: 'success', text: 'Personnel deleted successfully' });
                                loadPersonnel();
                                setSelectedPerson(null);
                            } else {
                                setMessage({ type: 'error', text: response.error || 'Failed to delete personnel' });
                            }
                        } catch (error) {
                            setMessage({ type: 'error', text: 'Error deleting personnel' });
                        }
                    }
                }
            };

            const fieldLabel = (label) => e('p', { className: 'text-xs font-semibold text-slate-400 uppercase tracking-wider mb-0.5' }, label);
            const fieldValue = (val) => e('p', { className: 'text-sm text-slate-800 font-medium' }, val || e('span', { className: 'text-slate-400 italic' }, 'Not provided'));

            const detailPanel = selectedPerson ? (
                e('div', { className: 'flex flex-col h-full bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden' },
                    // Panel header
                    e('div', { className: 'flex items-center justify-between px-5 py-4 border-b border-slate-100 flex-shrink-0' },
                        e('div', { className: 'flex items-center gap-3' },
                            e('div', { className: 'w-10 h-10 rounded-full bg-sky-100 flex items-center justify-center text-sky-600 font-bold text-sm flex-shrink-0' },
                                `${(selectedPerson.FirstName || '?')[0]}${(selectedPerson.LastName || selectedPerson.Lastname || '?')[0]}`
                            ),
                            e('div', null,
                                e('p', { className: 'text-sm font-bold text-slate-900 leading-tight' }, `${selectedPerson.FirstName} ${selectedPerson.LastName || selectedPerson.Lastname}`),
                                e('p', { className: 'text-xs text-slate-400' }, selectedPerson.PrimaryEmail)
                            )
                        ),
                        e('button', {
                            onClick: () => setSelectedPerson(null),
                            className: 'w-7 h-7 flex items-center justify-center rounded-lg text-slate-400 hover:text-slate-600 hover:bg-slate-100 transition-colors text-lg leading-none'
                        }, '×')
                    ),
                    // Panel body
                    e('div', { className: 'flex-1 overflow-y-auto p-5 space-y-4' },
                        isEditing ? (
                            e('div', { className: 'grid grid-cols-1 gap-3' },
                                ['FirstName','LastName','PrimaryEmail','PrimaryPhone','Instagram','Birthday'].map(field =>
                                    e('div', { key: field },
                                        e('label', { className: 'block text-xs font-semibold text-slate-400 uppercase tracking-wider mb-1' }, field.replace(/([A-Z])/g, ' $1').trim()),
                                        e('input', {
                                            type: field === 'PrimaryEmail' ? 'email' : field === 'Birthday' ? 'date' : 'text',
                                            value: editFormData[field] || editFormData[field === 'LastName' ? 'Lastname' : field] || '',
                                            onChange: (ev) => setEditFormData(prev => ({ ...prev, [field]: ev.target.value })),
                                            className: 'w-full px-3 py-2 text-sm border border-slate-200 rounded-lg bg-slate-50 focus:bg-white focus:border-sky-400 transition-colors'
                                        })
                                    )
                                )
                            )
                        ) : (
                            e('div', { className: 'grid grid-cols-2 gap-x-6 gap-y-4' },
                                e('div', null, fieldLabel('First Name'), fieldValue(selectedPerson.FirstName)),
                                e('div', null, fieldLabel('Last Name'), fieldValue(selectedPerson.LastName || selectedPerson.Lastname)),
                                e('div', { className: 'col-span-2' }, fieldLabel('Email'), fieldValue(selectedPerson.PrimaryEmail)),
                                e('div', null, fieldLabel('Phone'), fieldValue(selectedPerson.PrimaryPhone)),
                                e('div', null, fieldLabel('Instagram'), fieldValue(selectedPerson.Instagram)),
                                e('div', null, fieldLabel('Birthday'), fieldValue(selectedPerson.Birthday))
                            )
                        )
                    ),
                    // Panel footer actions
                    e('div', { className: 'flex items-center gap-2 px-5 py-4 border-t border-slate-100 flex-shrink-0' },
                        isEditing ? (
                            e(React.Fragment, null,
                                e('button', {
                                    onClick: handleSaveEdit,
                                    disabled: isSaving,
                                    className: 'btn-primary flex-1 py-2 text-sm font-semibold text-white rounded-xl'
                                }, isSaving ? 'Saving…' : 'Save Changes'),
                                e('button', {
                                    onClick: () => setIsEditing(false),
                                    className: 'px-4 py-2 text-sm font-medium text-slate-600 rounded-xl hover:bg-slate-100 transition-colors'
                                }, 'Cancel')
                            )
                        ) : (
                            e(React.Fragment, null,
                                e('button', {
                                    onClick: () => { setIsEditing(true); setEditFormData(selectedPerson); },
                                    className: 'flex-1 py-2 text-sm font-semibold text-slate-700 bg-slate-100 hover:bg-slate-200 rounded-xl transition-colors'
                                }, 'Edit'),
                                e('button', {
                                    onClick: handleDeletePerson,
                                    className: 'px-4 py-2 text-sm font-semibold text-red-600 hover:bg-red-50 rounded-xl transition-colors'
                                }, 'Delete')
                            )
                        )
                    )
                )
            ) : (
                e('div', { className: 'flex flex-col items-center justify-center h-full bg-slate-50 rounded-2xl border border-dashed border-slate-200 text-center p-8' },
                    e('div', { className: 'w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center mb-3' },
                        e('svg', { className: 'w-6 h-6 text-slate-400', fill: 'none', stroke: 'currentColor', strokeWidth: '1.5', viewBox: '0 0 24 24' },
                            e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', d: 'M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z' })
                        )
                    ),
                    e('p', { className: 'text-sm font-medium text-slate-500' }, 'Select a person to view details')
                )
            );

            return e('div', { className: 'flex flex-col p-6 gap-4', style: { height: '100%', overflow: 'hidden', boxSizing: 'border-box' } },
                // Header
                e('div', { className: 'flex justify-between items-center flex-shrink-0' },
                    e('div', null,
                        e('h1', { className: 'text-2xl font-bold text-gray-900' }, 'Personnel Directory'),
                        e('p', { className: 'text-sm text-gray-500 mt-0.5' }, 'Manage all team members')
                    ),
                    e('button', { onClick: handleAddNew, className: 'btn-primary px-4 py-2 text-sm font-semibold text-white rounded-xl' }, '+ Add New Person')
                ),

                message && e('div', { className: 'flex-shrink-0' },
                    e(Message, { type: message.type, message: message.text, onClose: () => setMessage(null) })
                ),

                // Search + Sort
                e('div', { className: 'flex flex-wrap gap-2 items-center flex-shrink-0' },
                    e('input', {
                        type: 'text',
                        placeholder: 'Search by name or email\u2026',
                        value: searchTerm,
                        onChange: (ev) => setSearchTerm(ev.target.value),
                        className: 'flex-1 min-w-[180px] max-w-sm px-4 py-2.5 text-sm border border-gray-200 rounded-xl bg-white shadow-sm focus:border-sky-400 transition-colors'
                    }),
                    e('select', {
                        value: sortBy, onChange: (ev) => setSortBy(ev.target.value),
                        className: 'px-3 py-2.5 text-sm border border-gray-200 rounded-xl bg-white shadow-sm focus:border-sky-400 transition-colors'
                    },
                        e('option', { value: 'az' }, 'Name A \u2192 Z'),
                        e('option', { value: 'za' }, 'Name Z \u2192 A')
                    )
                ),

                // Split panel
                e('div', { className: 'flex gap-4', style: { flex: '1 1 0', minHeight: 0, overflow: 'hidden' } },
                    // Left: scrollable card list
                    e('div', { style: { flex: '1 1 0', overflowY: 'auto', minHeight: 0 } },
                        isLoading ? e(Loader, { text: 'Loading personnel...' }) :
                        e('div', { className: 'grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3 pb-2' },
                            filteredPersonnel.map((person) =>
                                e(PersonCard, {
                                    key: person.PersonnelID,
                                    person: person,
                                    onClick: () => handlePersonClick(person),
                                    style: selectedPerson && selectedPerson.PersonnelID === person.PersonnelID
                                        ? { outline: '2px solid #0ea5e9', outlineOffset: '2px' }
                                        : {}
                                })
                            )
                        )
                    ),
                    // Right: detail panel (fixed width)
                    e('div', { style: { width: '320px', flexShrink: 0, minHeight: 0, overflow: 'hidden', display: 'flex', flexDirection: 'column' } }, detailPanel)
                ),

                // Create modal (overlay only for adding new)
                e(PersonnelModal, {
                    isOpen: isCreateModalOpen,
                    mode: 'create',
                    person: null,
                    onClose: () => setIsCreateModalOpen(false),
                    onSave: async (personData) => {
                        await handleSavePerson(personData);
                        setIsCreateModalOpen(false);
                    },
                    onEdit: () => {},
                    onDelete: () => {}
                })
            );
        }

        // Cast Directory Component
        // READS FROM: ShowPerformances, Personnel, and ShowInformation sheets via getAllCastMembers()
        function CastDirectory() {
            const [castMembers, setCastMembers] = useState([]);
            const [filteredCastMembers, setFilteredCastMembers] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedCastMember, setSelectedCastMember] = useState(null);
            const [message, setMessage] = useState(null);

            // Add Cast Member modal state
            const [isAddModalOpen, setIsAddModalOpen] = useState(false);
            const [allPersonnel, setAllPersonnel] = useState([]);
            const [personnelSearch, setPersonnelSearch] = useState('');
            const [isAdding, setIsAdding] = useState(false);
            const [selectedPersonnelIds, setSelectedPersonnelIds] = useState([]);

            // Remove confirmation state
            const [removeTarget, setRemoveTarget] = useState(null);
            const [isRemoving, setIsRemoving] = useState(false);
            const [sortBy, setSortBy] = useState('az');

            useEffect(() => {
                loadCastMembers();
            }, []);

            useEffect(() => {
                const name = m => `${m.FirstName || ''} ${m.LastName || ''}`.toLowerCase();
                let filtered = castMembers.filter(member =>
                    name(member).includes(searchTerm.toLowerCase()) ||
                    (member.PrimaryEmail || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
                    (member.PrimaryPhone || '').toLowerCase().includes(searchTerm.toLowerCase())
                );
                if (sortBy === 'az') filtered = [...filtered].sort((a, b) => name(a).localeCompare(name(b)));
                else if (sortBy === 'za') filtered = [...filtered].sort((a, b) => name(b).localeCompare(name(a)));
                else if (sortBy === 'active') filtered = [...filtered].sort((a, b) => (a.Status === 'Active' ? 0 : 1) - (b.Status === 'Active' ? 0 : 1));
                else if (sortBy === 'lastshow') filtered = [...filtered].sort((a, b) => {
                    const da = a.LastShowDate && a.LastShowDate !== 'N/A' ? new Date(a.LastShowDate) : new Date(0);
                    const db = b.LastShowDate && b.LastShowDate !== 'N/A' ? new Date(b.LastShowDate) : new Date(0);
                    return db - da;
                });
                setFilteredCastMembers(filtered);
            }, [castMembers, searchTerm, sortBy]);

            const loadCastMembers = async () => {
                setIsLoading(true);
                try {
                    const response = await gasService.getAllCastMembers();
                    if (response.success && response.data && response.data.data) {
                        setCastMembers(response.data.data);
                        setMessage(null);
                    } else {
                        setMessage({ type: 'error', text: response.error || 'Failed to load cast members' });
                    }
                } catch (error) {
                    setMessage({ type: 'error', text: 'Error loading cast member data' });
                } finally {
                    setIsLoading(false);
                }
            };

            const handleOpenAddModal = async () => {
                setPersonnelSearch('');
                setSelectedPersonnelIds([]);
                setIsAddModalOpen(true);
                if (allPersonnel.length === 0) {
                    try {
                        const response = await gasService.getAllPersonnel();
                        if (response.success && Array.isArray(response.data)) {
                            setAllPersonnel(response.data);
                        }
                    } catch (err) {
                        // silently fail
                    }
                }
            };

            const castPersonnelIds = new Set(castMembers.map(c => c.PersonnelID).filter(Boolean));
            const availablePersonnel = allPersonnel.filter(p => {
                const notInCast = !castPersonnelIds.has(p.PersonnelID);
                const matchesSearch = personnelSearch === '' ||
                    `${p.FirstName} ${p.LastName}`.toLowerCase().includes(personnelSearch.toLowerCase()) ||
                    (p.PrimaryEmail || '').toLowerCase().includes(personnelSearch.toLowerCase());
                return notInCast && matchesSearch;
            });

            const togglePersonnelSelect = (personnelId) => {
                setSelectedPersonnelIds(prev =>
                    prev.includes(personnelId)
                        ? prev.filter(id => id !== personnelId)
                        : [...prev, personnelId]
                );
            };

            const toggleSelectAll = () => {
                const allIds = availablePersonnel.map(p => p.PersonnelID);
                const allSelected = allIds.every(id => selectedPersonnelIds.includes(id));
                setSelectedPersonnelIds(allSelected ? [] : allIds);
            };

            const handleAddSelectedCastMembers = async () => {
                if (selectedPersonnelIds.length === 0) return;
                setIsAdding(true);
                let successCount = 0;
                let failCount = 0;
                for (const personnelId of selectedPersonnelIds) {
                    try {
                        const response = await gasService.addPersonAsCastMember(personnelId);
                        if (response.success) successCount++;
                        else failCount++;
                    } catch (err) {
                        failCount++;
                    }
                }
                setIsAdding(false);
                setIsAddModalOpen(false);
                setSelectedPersonnelIds([]);
                if (successCount > 0 && failCount === 0) {
                    setMessage({ type: 'success', text: `${successCount} cast member${successCount > 1 ? 's' : ''} added successfully.` });
                } else if (successCount > 0) {
                    setMessage({ type: 'success', text: `${successCount} added, ${failCount} failed.` });
                } else {
                    setMessage({ type: 'error', text: 'Failed to add cast members.' });
                }
                await loadCastMembers();
            };

            const handleRemoveClick = (castMemberId) => {
                const target = castMembers.find(c => c.CastMemberID === castMemberId);
                if (target) setRemoveTarget(target);
            };

            const handleConfirmRemove = async () => {
                if (!removeTarget) return;
                setIsRemoving(true);
                try {
                    const response = await gasService.removeCastMember(removeTarget.CastMemberID);
                    if (response.success) {
                        setMessage({ type: 'success', text: `${removeTarget.FirstName} ${removeTarget.LastName} removed from cast.` });
                        setRemoveTarget(null);
                        await loadCastMembers();
                    } else {
                        setMessage({ type: 'error', text: response.error || 'Failed to remove cast member.' });
                        setRemoveTarget(null);
                    }
                } catch (err) {
                    setMessage({ type: 'error', text: 'Error removing cast member.' });
                    setRemoveTarget(null);
                } finally {
                    setIsRemoving(false);
                }
            };

            const handleCastMemberClick = (castMember) => {
                setSelectedCastMember(castMember);
            };

            const castDetailPanel = selectedCastMember ? (
                e('div', { className: 'flex flex-col h-full bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden' },
                    e('div', { className: 'flex items-center justify-between px-5 py-4 border-b border-slate-100 flex-shrink-0' },
                        e('div', { className: 'flex items-center gap-3' },
                            e('div', { className: 'w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center text-purple-600 font-bold text-sm flex-shrink-0' },
                                `${(selectedCastMember.FirstName||'?')[0]}${(selectedCastMember.LastName||'?')[0]}`
                            ),
                            e('div', null,
                                e('p', { className: 'text-sm font-bold text-slate-900 leading-tight' }, `${selectedCastMember.FirstName||''} ${selectedCastMember.LastName||''}`.trim()),
                                e('span', { className: `text-xs px-2 py-0.5 rounded-full font-medium ${selectedCastMember.Status==='Active'?'bg-green-100 text-green-700':'bg-red-100 text-red-700'}` }, selectedCastMember.Status||'Unknown')
                            )
                        ),
                        e('button', { onClick: () => setSelectedCastMember(null), className: 'w-7 h-7 flex items-center justify-center rounded-lg text-slate-400 hover:text-slate-600 hover:bg-slate-100 transition-colors text-lg leading-none' }, '×')
                    ),
                    e('div', { className: 'flex-1 overflow-y-auto p-5' },
                        e('div', { className: 'grid grid-cols-2 gap-x-6 gap-y-4' },
                            e('div', { className: 'col-span-2' }, e('p', { className: 'text-xs font-semibold text-slate-400 uppercase tracking-wider mb-0.5' }, 'Email'), e('p', { className: 'text-sm text-slate-800 font-medium' }, selectedCastMember.PrimaryEmail||'Not provided')),
                            e('div', null, e('p', { className: 'text-xs font-semibold text-slate-400 uppercase tracking-wider mb-0.5' }, 'Phone'), e('p', { className: 'text-sm text-slate-800 font-medium' }, selectedCastMember.PrimaryPhone||'N/A')),
                            e('div', null, e('p', { className: 'text-xs font-semibold text-slate-400 uppercase tracking-wider mb-0.5' }, 'Birthday'), e('p', { className: 'text-sm text-slate-800 font-medium' }, selectedCastMember.Birthday?new Date(selectedCastMember.Birthday).toLocaleDateString():'N/A')),
                            e('div', { className: 'col-span-2' }, e('p', { className: 'text-xs font-semibold text-slate-400 uppercase tracking-wider mb-0.5' }, 'Last Show Date'), e('p', { className: 'text-sm text-slate-800 font-medium' }, selectedCastMember.LastShowDate&&selectedCastMember.LastShowDate!=='N/A'?new Date(selectedCastMember.LastShowDate).toLocaleDateString():'N/A'))
                        )
                    ),
                    e('div', { className: 'flex items-center gap-2 px-5 py-4 border-t border-slate-100 flex-shrink-0' },
                        e('button', { onClick: () => { setRemoveTarget(selectedCastMember); setSelectedCastMember(null); }, className: 'flex-1 py-2 text-sm font-semibold text-red-600 hover:bg-red-50 rounded-xl transition-colors' }, 'Remove from Cast'),
                        e('button', { onClick: () => setSelectedCastMember(null), className: 'px-4 py-2 text-sm font-medium text-slate-600 rounded-xl hover:bg-slate-100 transition-colors' }, 'Close')
                    )
                )
            ) : e('div', { className: 'flex flex-col items-center justify-center h-full bg-slate-50 rounded-2xl border border-dashed border-slate-200 text-center p-8' },
                e('p', { className: 'text-sm font-medium text-slate-500' }, 'Select a cast member to view details')
            );

            return e('div', { className: 'flex flex-col p-6 gap-4', style: { height: '100%', overflow: 'hidden', boxSizing: 'border-box' } },
                e('div', { className: 'flex justify-between items-center flex-shrink-0' },
                    e('div', null,
                        e('h1', { className: 'text-2xl font-bold text-gray-900' }, 'Cast Directory'),
                        e('p', { className: 'text-sm text-gray-500 mt-0.5' }, `${filteredCastMembers.length} cast assignments`)
                    ),
                    e('button', { onClick: handleOpenAddModal, className: 'btn-primary px-4 py-2 text-sm font-semibold text-white rounded-xl' }, '+ Add Cast Member')
                ),
                message && e('div', { className: 'flex-shrink-0' }, e(Message, { type: message.type, message: message.text, onClose: () => setMessage(null) })),
                e('div', { className: 'flex flex-wrap gap-2 items-center flex-shrink-0' },
                    e('input', { type: 'text', placeholder: 'Search by name, email, or phone…', value: searchTerm, onChange: (ev) => setSearchTerm(ev.target.value), className: 'flex-1 min-w-[180px] max-w-sm px-4 py-2.5 text-sm border border-gray-200 rounded-xl bg-white shadow-sm focus:border-sky-400 transition-colors' }),
                    e('select', {
                        value: sortBy, onChange: (ev) => setSortBy(ev.target.value),
                        className: 'px-3 py-2.5 text-sm border border-gray-200 rounded-xl bg-white shadow-sm focus:border-sky-400 transition-colors'
                    },
                        e('option', { value: 'az' }, 'Name A → Z'),
                        e('option', { value: 'za' }, 'Name Z → A'),
                        e('option', { value: 'active' }, 'Active First'),
                        e('option', { value: 'lastshow' }, 'Last Show Date')
                    )
                ),
                e('div', { className: 'flex gap-4', style: { flex: '1 1 0', minHeight: 0, overflow: 'hidden' } },
                    e('div', { style: { flex: '1 1 0', overflowY: 'auto', minHeight: 0 } },
                        isLoading ? e(Loader, { text: 'Loading cast members...' }) :
                        filteredCastMembers.length === 0 ? e('div', { className: 'text-center text-gray-500 mt-8 pb-2' }, e('p', null, 'No cast members found.')) :
                        e('div', { className: 'grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3 pb-2' },
                            filteredCastMembers.map((castMember) =>
                                e(CastCard, { key: `${castMember.PerformanceID}-${castMember.CastMemberID}`, castMember: castMember, onClick: () => handleCastMemberClick(castMember), onRemove: handleRemoveClick,
                                    style: selectedCastMember&&selectedCastMember.CastMemberID===castMember.CastMemberID?{outline:'2px solid #a855f7',outlineOffset:'2px'}:{} })
                            )
                        )
                    ),
                    e('div', { style: { width: '320px', flexShrink: 0, minHeight: 0, overflow: 'hidden', display: 'flex', flexDirection: 'column' } }, castDetailPanel)
                ),

                // Add Cast Member Modal
                isAddModalOpen && e('div', {
                    className: 'fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4',
                    onClick: () => setIsAddModalOpen(false)
                },
                    e('div', {
                        className: 'bg-white rounded-lg p-6 max-w-lg w-full mx-4 flex flex-col',
                        style: { maxHeight: '80vh' },
                        onClick: (ev) => ev.stopPropagation()
                    },
                        e('div', { className: 'flex justify-between items-center mb-4' },
                            e('h2', { className: 'text-lg font-semibold text-gray-900' }, 'Add Cast Members from Personnel'),
                            e('button', {
                                onClick: () => setIsAddModalOpen(false),
                                className: 'text-gray-400 hover:text-gray-600 text-xl'
                            }, '×')
                        ),
                        e('input', {
                            type: 'text',
                            placeholder: 'Search personnel...',
                            value: personnelSearch,
                            onChange: (ev) => setPersonnelSearch(ev.target.value),
                            className: 'mb-2 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent'
                        }),
                        availablePersonnel.length > 0 && e('div', { className: 'flex items-center justify-between mb-2 px-1' },
                            e('label', { className: 'flex items-center gap-2 text-sm text-gray-600 cursor-pointer select-none' },
                                e('input', {
                                    type: 'checkbox',
                                    checked: availablePersonnel.length > 0 && availablePersonnel.every(p => selectedPersonnelIds.includes(p.PersonnelID)),
                                    onChange: toggleSelectAll,
                                    className: 'w-4 h-4 accent-purple-600'
                                }),
                                'Select all'
                            ),
                            selectedPersonnelIds.length > 0 && e('span', { className: 'text-sm text-purple-700 font-medium' },
                                `${selectedPersonnelIds.length} selected`
                            )
                        ),
                        e('div', { className: 'overflow-y-auto flex-1' },
                            availablePersonnel.length === 0
                                ? e('p', { className: 'text-center text-gray-500 py-6' }, 'No available personnel found.')
                                : availablePersonnel.map((person) => {
                                    const isChecked = selectedPersonnelIds.includes(person.PersonnelID);
                                    return e('label', {
                                        key: person.PersonnelID,
                                        className: `flex items-center gap-3 p-3 mb-1 border rounded-lg cursor-pointer select-none transition-colors ${
                                            isChecked ? 'border-purple-400 bg-purple-50' : 'border-gray-200 hover:bg-gray-50'
                                        }`
                                    },
                                        e('input', {
                                            type: 'checkbox',
                                            checked: isChecked,
                                            onChange: () => togglePersonnelSelect(person.PersonnelID),
                                            className: 'w-4 h-4 accent-purple-600 flex-shrink-0'
                                        }),
                                        e('div', { className: 'flex-1 min-w-0' },
                                            e('p', { className: 'font-medium text-gray-900' }, `${person.FirstName} ${person.LastName}`.trim()),
                                            e('p', { className: 'text-sm text-gray-500 truncate' }, person.PrimaryEmail || 'No email')
                                        )
                                    );
                                })
                        ),
                        e('div', { className: 'mt-4 flex justify-between items-center' },
                            e('button', {
                                onClick: () => setIsAddModalOpen(false),
                                className: 'px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors'
                            }, 'Cancel'),
                            e('button', {
                                onClick: handleAddSelectedCastMembers,
                                disabled: isAdding || selectedPersonnelIds.length === 0,
                                className: 'px-4 py-2 text-white bg-purple-600 rounded-lg hover:bg-purple-700 disabled:opacity-50 transition-colors font-medium'
                            }, isAdding ? 'Adding...' : `Add ${selectedPersonnelIds.length > 0 ? selectedPersonnelIds.length + ' ' : ''}Selected`)
                        )
                    )
                ),

                // Remove Confirmation Modal
                removeTarget && e('div', {
                    className: 'fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4',
                    onClick: () => setRemoveTarget(null)
                },
                    e('div', {
                        className: 'bg-white rounded-lg p-6 max-w-md w-full mx-4',
                        onClick: (ev) => ev.stopPropagation()
                    },
                        e('h2', { className: 'text-lg font-semibold text-gray-900 mb-2' }, 'Remove Cast Member'),
                        e('p', { className: 'text-gray-600 mb-6' },
                            'Are you sure you want to remove ',
                            e('span', { className: 'font-medium text-gray-900' }, `${removeTarget.FirstName} ${removeTarget.LastName}`),
                            ' from the cast directory? This will delete their entry from the CastMemberInfo table.'
                        ),
                        e('div', { className: 'flex justify-end gap-3' },
                            e('button', {
                                onClick: () => setRemoveTarget(null),
                                disabled: isRemoving,
                                className: 'px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors'
                            }, 'Cancel'),
                            e('button', {
                                onClick: handleConfirmRemove,
                                disabled: isRemoving,
                                className: 'px-4 py-2 text-white bg-red-600 rounded-lg hover:bg-red-700 disabled:opacity-50 transition-colors'
                            }, isRemoving ? 'Removing...' : 'Remove')
                        )
                    )
                ),

            );
        }

        // CrewDirectory Component
        function CrewDirectory() {
            const [crewMembers, setCrewMembers] = useState([]);
            const [filteredCrewMembers, setFilteredCrewMembers] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [searchTerm, setSearchTerm] = useState('');
            const [dutyFilter, setDutyFilter] = useState('all');
            const [showFilter, setShowFilter] = useState('all');
            const [viewMode, setViewMode] = useState('grid');
            const [sortBy, setSortBy] = useState('az');
            const [selectedCrewMember, setSelectedCrewMember] = useState(null);
            const [message, setMessage] = useState(null);

            useEffect(() => { loadCrewMembers(); }, []);

            useEffect(() => {
                const name = m => `${m.FirstName || ''} ${m.LastName || m.Lastname || ''}`.toLowerCase();
                let filtered = crewMembers;
                if (searchTerm) {
                    const term = searchTerm.toLowerCase();
                    filtered = filtered.filter(m =>
                        name(m).includes(term) ||
                        (m.PrimaryEmail || '').toLowerCase().includes(term) ||
                        (m.DutyName || '').toLowerCase().includes(term) ||
                        (m.ShowName || '').toLowerCase().includes(term)
                    );
                }
                if (dutyFilter !== 'all') {
                    filtered = filtered.filter(m => (m.DutyName || '') === dutyFilter);
                }
                if (showFilter !== 'all') {
                    filtered = filtered.filter(m => (m.ShowName || '') === showFilter);
                }
                if (sortBy === 'az') filtered = [...filtered].sort((a, b) => name(a).localeCompare(name(b)));
                else if (sortBy === 'za') filtered = [...filtered].sort((a, b) => name(b).localeCompare(name(a)));
                else if (sortBy === 'duty') filtered = [...filtered].sort((a, b) => (a.DutyName || '').localeCompare(b.DutyName || ''));
                else if (sortBy === 'showdate') filtered = [...filtered].sort((a, b) => {
                    const da = a.ShowDate || a.LastShowDate ? new Date(a.ShowDate || a.LastShowDate) : new Date(0);
                    const db = b.ShowDate || b.LastShowDate ? new Date(b.ShowDate || b.LastShowDate) : new Date(0);
                    return db - da;
                });
                setFilteredCrewMembers(filtered);
            }, [crewMembers, searchTerm, dutyFilter, showFilter, sortBy]);

            const loadCrewMembers = async () => {
                setIsLoading(true);
                try {
                    const response = await gasService.getAllCrewMembers();
                    if (response.success && response.data && response.data.data) {
                        setCrewMembers(response.data.data);
                        setMessage(null);
                    } else {
                        setMessage({ type: 'error', text: (response.data && response.data.error) || response.error || 'Failed to load crew members' });
                    }
                } catch (err) {
                    setMessage({ type: 'error', text: 'Error loading crew member data' });
                } finally {
                    setIsLoading(false);
                }
            };

            const uniqueDutyTypes = [...new Set(crewMembers.map(m => m.DutyName).filter(Boolean))];
            const uniqueShows = [...new Set(crewMembers.map(m => m.ShowName).filter(Boolean))];
            const uniqueShowCount = uniqueShows.length;
            const uniqueCrewCount = new Set(crewMembers.map(m => m.PersonnelID).filter(Boolean)).size;

            // Unique show dates sorted chronologically
            const getDateKey = (m) => m.ShowDate || m.LastShowDate || '';
            const uniqueShowDates = [...new Set(crewMembers.map(getDateKey).filter(Boolean))]
                .sort((a, b) => new Date(a) - new Date(b));

            // Stable date → color index map
            const showColorMap = useMemo(() => {
                const map = {};
                uniqueShowDates.forEach((date, i) => { map[date] = i % SHOW_COLORS.length; });
                return map;
            }, [uniqueShowDates.join('|')]);

            const getShowBadge = (dateKey) =>
                dateKey && showColorMap[dateKey] !== undefined ? SHOW_COLORS[showColorMap[dateKey]] : 'bg-gray-100 text-gray-600 border-gray-200';
            const getShowHeader = (dateKey) =>
                dateKey && showColorMap[dateKey] !== undefined ? SHOW_HEADER_COLORS[showColorMap[dateKey]] : 'bg-gray-500 text-white';

            // Group by duty
            const groupedByDuty = uniqueDutyTypes.reduce((acc, duty) => {
                const members = filteredCrewMembers.filter(m => m.DutyName === duty);
                if (members.length) acc[duty] = members;
                return acc;
            }, {});
            const unassigned = filteredCrewMembers.filter(m => !m.DutyName);
            if (unassigned.length) groupedByDuty['Unassigned'] = unassigned;

            // Group by show date (sorted chronologically)
            const groupedByShow = uniqueShowDates.reduce((acc, date) => {
                const members = filteredCrewMembers.filter(m => getDateKey(m) === date);
                if (members.length) acc[date] = members;
                return acc;
            }, {});
            const noShow = filteredCrewMembers.filter(m => !getDateKey(m));
            if (noShow.length) groupedByShow[''] = noShow;

            const formatDate = (d) => {
                if (!d || d === 'N/A') return 'N/A';
                try { return new Date(d).toLocaleDateString(); } catch { return d; }
            };
            const getDisplayName = (m) => `${m.FirstName || ''} ${m.LastName || m.Lastname || ''}`.trim() || 'Unknown';

            const crewDetailPanel = selectedCrewMember ? (
                e('div', { className: 'flex flex-col h-full bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden' },
                    e('div', { className: 'flex items-center justify-between px-5 py-4 border-b border-slate-100 flex-shrink-0' },
                        e('div', { className: 'flex items-center gap-3' },
                            e('div', { className: 'w-10 h-10 rounded-full bg-teal-100 flex items-center justify-center text-teal-700 font-bold text-sm flex-shrink-0' },
                                `${(selectedCrewMember.FirstName||'')[0]||''}${((selectedCrewMember.LastName||selectedCrewMember.Lastname)||'')[0]||''}`
                            ),
                            e('div', null,
                                e('p', { className: 'text-sm font-bold text-slate-900 leading-tight' }, getDisplayName(selectedCrewMember)),
                                e('span', { className: `text-xs px-2 py-0.5 rounded-full font-medium ${selectedCrewMember.Status==='Active'?'bg-green-100 text-green-700':'bg-gray-100 text-gray-600'}` }, selectedCrewMember.Status||'Crew Member')
                            )
                        ),
                        e('button', { onClick: () => setSelectedCrewMember(null), className: 'w-7 h-7 flex items-center justify-center rounded-lg text-slate-400 hover:text-slate-600 hover:bg-slate-100 transition-colors text-lg leading-none' }, '×')
                    ),
                    e('div', { className: 'flex-1 overflow-y-auto p-5 space-y-4' },
                        e('div', { className: 'bg-gray-50 rounded-lg p-4' },
                            e('h3', { className: 'text-xs font-semibold text-gray-500 uppercase tracking-wide mb-3' }, 'Contact'),
                            e('div', { className: 'space-y-2 text-sm' },
                                e('div', null, e('p', { className: 'text-gray-500' }, 'Email'), e('p', { className: 'font-medium text-gray-900' }, selectedCrewMember.PrimaryEmail||'N/A')),
                                e('div', null, e('p', { className: 'text-gray-500' }, 'Phone'), e('p', { className: 'font-medium text-gray-900' }, selectedCrewMember.PrimaryPhone||'N/A')),
                                selectedCrewMember.Birthday && e('div', null, e('p', { className: 'text-gray-500' }, 'Birthday'), e('p', { className: 'font-medium text-gray-900' }, formatDate(selectedCrewMember.Birthday)))
                            )
                        ),
                        e('div', { className: 'bg-teal-50 rounded-lg p-4' },
                            e('h3', { className: 'text-xs font-semibold text-teal-600 uppercase tracking-wide mb-3' }, 'Assignment'),
                            e('div', { className: 'space-y-2 text-sm' },
                                e('div', null, e('p', { className: 'text-gray-500' }, 'Duty'), e('p', { className: 'font-medium text-gray-900' }, selectedCrewMember.DutyName||'Unassigned')),
                                e('div', null, e('p', { className: 'text-gray-500' }, 'Show'), e('p', { className: 'font-medium text-gray-900' }, selectedCrewMember.ShowName||'N/A')),
                                e('div', null, e('p', { className: 'text-gray-500' }, 'Show Date'), e('p', { className: 'font-medium text-gray-900' }, formatDate(selectedCrewMember.ShowDate||selectedCrewMember.LastShowDate)))
                            )
                        ),
                        (() => {
                            const allDuties = crewMembers.filter(m => m.PersonnelID === selectedCrewMember.PersonnelID);
                            if (allDuties.length <= 1) return null;
                            return e('div', null,
                                e('h3', { className: 'text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2' }, `All Assignments (${allDuties.length})`),
                                e('div', { className: 'space-y-1.5' },
                                    allDuties.map((duty, idx) =>
                                        e('div', { key: idx, className: 'flex items-center justify-between p-2.5 border rounded-lg text-sm hover:bg-gray-50' },
                                            e('span', { className: 'font-medium text-gray-900' }, duty.DutyName||'Unassigned'),
                                            e('span', { className: 'text-gray-500 text-xs' }, formatDate(duty.ShowDate||duty.LastShowDate))
                                        )
                                    )
                                )
                            );
                        })()
                    ),
                    e('div', { className: 'flex items-center gap-2 px-5 py-4 border-t border-slate-100 flex-shrink-0' },
                        e('button', { onClick: () => setSelectedCrewMember(null), className: 'flex-1 py-2 text-sm font-medium text-slate-600 rounded-xl hover:bg-slate-100 transition-colors' }, 'Close')
                    )
                )
            ) : e('div', { className: 'flex flex-col items-center justify-center h-full bg-slate-50 rounded-2xl border border-dashed border-slate-200 text-center p-8' },
                e('p', { className: 'text-sm font-medium text-slate-500' }, 'Select a crew member to view details')
            );

            return e('div', { className: 'flex flex-col p-6 gap-4', style: { height: '100%', overflow: 'hidden', boxSizing: 'border-box' } },
                // Header
                e('div', { className: 'flex justify-between items-center flex-shrink-0' },
                    e('div', null,
                        e('h1', { className: 'text-2xl font-bold text-gray-900' }, 'Crew Directory'),
                        e('p', { className: 'text-sm text-gray-500 mt-0.5' }, 'View crew members and show duty assignments')
                    ),
                    e('p', { className: 'text-sm text-gray-500 bg-white border border-gray-100 px-3 py-1.5 rounded-lg shadow-sm font-medium' }, `${filteredCrewMembers.length} assignment${filteredCrewMembers.length !== 1 ? 's' : ''}`)
                ),

                // Stats bar
                !isLoading && crewMembers.length > 0 && e('div', { className: 'grid grid-cols-1 md:grid-cols-3 gap-3 flex-shrink-0' },
                    e('div', { className: 'bg-white rounded-xl shadow-card border border-gray-100 p-4' },
                        e('p', { className: 'text-xs font-semibold text-gray-400 uppercase tracking-wider' }, 'Total Crew Members'),
                        e('p', { className: 'text-2xl font-bold text-teal-600 mt-1' }, uniqueCrewCount)
                    ),
                    e('div', { className: 'bg-white rounded-xl shadow-card border border-gray-100 p-4' },
                        e('p', { className: 'text-xs font-semibold text-gray-400 uppercase tracking-wider' }, 'Duty Types'),
                        e('p', { className: 'text-2xl font-bold text-indigo-600 mt-1' }, uniqueDutyTypes.length)
                    ),
                    e('div', { className: 'bg-white rounded-xl shadow-card border border-gray-100 p-4' },
                        e('p', { className: 'text-xs font-semibold text-gray-400 uppercase tracking-wider' }, 'Shows Supported'),
                        e('p', { className: 'text-2xl font-bold text-violet-600 mt-1' }, uniqueShowCount)
                    )
                ),

                message && e('div', { className: 'flex-shrink-0' },
                    e(Message, { type: message.type, message: message.text, onClose: () => setMessage(null) })
                ),

                // Toolbar
                e('div', { className: 'flex flex-col sm:flex-row gap-3 flex-shrink-0' },
                    e('div', { className: 'relative flex-1' },
                        e('input', {
                            type: 'text',
                            placeholder: 'Search by name, email, duty, or show…',
                            value: searchTerm,
                            onChange: (ev) => setSearchTerm(ev.target.value),
                            className: 'w-full pl-10 pr-4 py-2.5 text-sm border border-gray-200 rounded-xl bg-white shadow-sm focus:border-sky-400 transition-colors'
                        }),
                        e('span', { style: { position: 'absolute', left: '12px', top: '10px', color: '#9ca3af' } }, '🔍')
                    ),
                    e('select', {
                        value: dutyFilter,
                        onChange: (ev) => setDutyFilter(ev.target.value),
                        className: 'px-3 py-2.5 text-sm border border-gray-200 rounded-xl bg-white shadow-sm focus:border-sky-400 transition-colors'
                    },
                        e('option', { value: 'all' }, 'All Duties'),
                        ...uniqueDutyTypes.map(duty => e('option', { key: duty, value: duty }, duty))
                    ),
                    e('select', {
                        value: showFilter,
                        onChange: (ev) => setShowFilter(ev.target.value),
                        className: 'px-3 py-2.5 text-sm border border-gray-200 rounded-xl bg-white shadow-sm focus:border-sky-400 transition-colors'
                    },
                        e('option', { value: 'all' }, 'All Shows'),
                        ...uniqueShows.map(show => e('option', { key: show, value: show }, show))
                    ),
                    e('select', {
                        value: sortBy, onChange: (ev) => setSortBy(ev.target.value),
                        className: 'px-3 py-2.5 text-sm border border-gray-200 rounded-xl bg-white shadow-sm focus:border-sky-400 transition-colors'
                    },
                        e('option', { value: 'az' }, 'Name A \u2192 Z'),
                        e('option', { value: 'za' }, 'Name Z \u2192 A'),
                        e('option', { value: 'duty' }, 'By Duty'),
                        e('option', { value: 'showdate' }, 'Show Date (Newest)')
                    ),
                    e('div', { className: 'flex rounded-xl border border-gray-200 overflow-hidden shadow-sm' },
                        e('button', {
                            onClick: () => setViewMode('grid'),
                            className: `px-3 py-2 text-sm transition-colors ${viewMode === 'grid' ? 'bg-slate-800 text-white' : 'bg-white text-gray-600 hover:bg-gray-50'}`
                        }, 'Grid'),
                        e('button', {
                            onClick: () => setViewMode('grouped'),
                            className: `px-3 py-2 text-sm transition-colors border-l border-gray-200 ${viewMode === 'grouped' ? 'bg-slate-800 text-white' : 'bg-white text-gray-600 hover:bg-gray-50'}`
                        }, 'By Duty'),
                        e('button', {
                            onClick: () => setViewMode('byShow'),
                            className: `px-3 py-2 text-sm transition-colors border-l border-gray-200 ${viewMode === 'byShow' ? 'bg-slate-800 text-white' : 'bg-white text-gray-600 hover:bg-gray-50'}`
                        }, 'By Show')
                    )
                ),

                // Split panel
                e('div', { className: 'flex gap-4', style: { flex: '1 1 0', minHeight: 0, overflow: 'hidden' } },
                    e('div', { style: { flex: '1 1 0', overflowY: 'auto', minHeight: 0 } },
                // Content
                isLoading ? e(Loader, { text: 'Loading crew members...' }) :
                filteredCrewMembers.length === 0 ?
                    e('div', { className: 'text-center py-12 text-gray-400' },
                        e('p', { className: 'text-4xl mb-3' }, '👷'),
                        e('p', { className: 'text-lg font-medium mb-1 text-gray-600' }, 'No crew members found'),
                        e('p', { className: 'text-sm' }, 'Try adjusting your search or filters.')
                    ) :
                viewMode === 'grid' ?
                    e('div', { className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3' },
                        filteredCrewMembers.map((member, idx) =>
                            e(CrewCard, {
                                key: `${member.PersonnelID}-${member.DutyID || idx}`,
                                crewMember: member,
                                onClick: () => { setSelectedCrewMember(member); },
                                showColorClasses: getShowBadge(getDateKey(member))
                            })
                        )
                    ) :
                viewMode === 'grouped' ?
                    e('div', { className: 'space-y-6' },
                        Object.entries(groupedByDuty).map(([duty, members]) =>
                            e('div', { key: duty, className: 'bg-white rounded-xl shadow-card border border-gray-100' },
                                e('div', { className: 'px-5 py-3 border-b bg-gray-50 rounded-t-lg flex justify-between items-center' },
                                    e('h3', { className: 'font-semibold text-gray-800' }, duty),
                                    e('span', { className: 'text-sm text-gray-500 bg-white border px-2 py-0.5 rounded-full' },
                                        `${members.length} assignment${members.length !== 1 ? 's' : ''}`
                                    )
                                ),
                                e('div', { className: 'p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4' },
                                    members.map((member, idx) =>
                                        e(CrewCard, {
                                            key: `${member.PersonnelID}-${member.DutyID || idx}`,
                                            crewMember: member,
                                            onClick: () => { setSelectedCrewMember(member); },
                                            showColorClasses: getShowBadge(getDateKey(member))
                                        })
                                    )
                                )
                            )
                        )
                    ) :
                    // By Show view
                    e('div', { className: 'space-y-6' },
                        uniqueShowDates.length > 0 && e('div', { className: 'flex flex-wrap gap-2 mb-2' },
                            uniqueShowDates.map(date =>
                                e('span', { key: date, className: `px-3 py-1 text-xs font-medium rounded-full border ${getShowBadge(date)}` },
                                    formatDate(date)
                                )
                            )
                        ),
                        Object.entries(groupedByShow).map(([date, members]) =>
                            e('div', { key: date || 'nodate', className: 'rounded-lg shadow-sm border overflow-hidden' },
                                e('div', { className: `px-5 py-3 flex justify-between items-center ${getShowHeader(date)}` },
                                    e('div', null,
                                        e('h3', { className: 'font-semibold text-lg' }, date ? formatDate(date) : 'No Date'),
                                        members[0] && members[0].ShowName && e('p', { className: 'text-xs opacity-80 mt-0.5' }, members[0].ShowName)
                                    ),
                                    e('span', { className: 'text-sm bg-white bg-opacity-20 border border-white border-opacity-30 px-2 py-0.5 rounded-full' },
                                        `${members.length} assignment${members.length !== 1 ? 's' : ''}`
                                    )
                                ),
                                e('div', { className: 'p-4 bg-white grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4' },
                                    members.map((member, idx) =>
                                        e(CrewCard, {
                                            key: `${member.PersonnelID}-${member.DutyID || idx}`,
                                            crewMember: member,
                                            onClick: () => { setSelectedCrewMember(member); },
                                            showColorClasses: getShowBadge(getDateKey(member))
                                        })
                                    )
                                )
                            )
                        )
                    )
                ),
                    e('div', { style: { width: '320px', flexShrink: 0, minHeight: 0, overflow: 'hidden', display: 'flex', flexDirection: 'column' } }, crewDetailPanel)
                )
            );
        }

        // Bartenders Page Component
        function BartendersPage() {
            const [bartenders, setBartenders] = useState([]);
            const [filteredBartenders, setFilteredBartenders] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedBartender, setSelectedBartender] = useState(null);
            const [message, setMessage] = useState(null);
            const [isAddOpen, setIsAddOpen] = useState(false);
            const [allPersonnel, setAllPersonnel] = useState([]);
            const [personnelSearch, setPersonnelSearch] = useState('');
            const [selectedPersonnelIds, setSelectedPersonnelIds] = useState([]);
            const [trainedMap, setTrainedMap] = useState({});
            const [isAdding, setIsAdding] = useState(false);
            const [removeTarget, setRemoveTarget] = useState(null);
            const [isRemoving, setIsRemoving] = useState(false);
            const [sortBy, setSortBy] = useState('az');

            useEffect(() => { loadBartenders(); }, []);

            useEffect(() => {
                const name = b => `${b.FirstName || ''} ${b.LastName || ''}`.toLowerCase();
                const term = searchTerm.toLowerCase();
                let filtered = term
                    ? bartenders.filter(b =>
                        name(b).includes(term) ||
                        (b.PrimaryEmail || '').toLowerCase().includes(term) ||
                        (b.PrimaryPhone || '').toLowerCase().includes(term)
                    )
                    : [...bartenders];
                if (sortBy === 'az') filtered = [...filtered].sort((a, b) => name(a).localeCompare(name(b)));
                else if (sortBy === 'za') filtered = [...filtered].sort((a, b) => name(b).localeCompare(name(a)));
                else if (sortBy === 'shifts') filtered = [...filtered].sort((a, b) => (b.ShiftCount || 0) - (a.ShiftCount || 0));
                else if (sortBy === 'active') filtered = [...filtered].sort((a, b) => {
                    const aA = String(a.Active).toLowerCase() === 'true' || a.Active === true ? 0 : 1;
                    const bA = String(b.Active).toLowerCase() === 'true' || b.Active === true ? 0 : 1;
                    return aA - bA;
                });
                else if (sortBy === 'trained') filtered = [...filtered].sort((a, b) => {
                    const aT = String(a.Trained).toLowerCase() === 'true' || a.Trained === true ? 0 : 1;
                    const bT = String(b.Trained).toLowerCase() === 'true' || b.Trained === true ? 0 : 1;
                    return aT - bT;
                });
                setFilteredBartenders(filtered);
            }, [bartenders, searchTerm, sortBy]);

            const loadBartenders = async () => {
                setIsLoading(true);
                try {
                    const response = await gasService.getBartendersWithDetails();
                    const data = response.data && response.data.data ? response.data.data
                        : Array.isArray(response.data) ? response.data : [];
                    if (response.success) {
                        setBartenders(data);
                        setMessage(null);
                    } else {
                        setMessage({ type: 'error', text: response.error || 'Failed to load bartenders.' });
                    }
                } catch (err) {
                    setMessage({ type: 'error', text: 'Error loading bartender data.' });
                } finally { setIsLoading(false); }
            };

            const bartenderPersonnelIds = new Set(bartenders.map(b => b.PersonnelID).filter(Boolean));
            const boolVal = (v) => v === true || String(v).toLowerCase() === 'true' || String(v) === '1';
            const activeCount = bartenders.filter(b => boolVal(b.Active)).length;
            const trainedCount = bartenders.filter(b => boolVal(b.Trained)).length;

            const availablePersonnel = allPersonnel.filter(p => {
                const notBartender = !bartenderPersonnelIds.has(p.PersonnelID);
                const matchesSearch = personnelSearch === '' ||
                    `${p.FirstName} ${p.LastName}`.toLowerCase().includes(personnelSearch.toLowerCase()) ||
                    (p.PrimaryEmail || '').toLowerCase().includes(personnelSearch.toLowerCase());
                return notBartender && matchesSearch;
            });

            const toggleSelect = (id) =>
                setSelectedPersonnelIds(prev => prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id]);

            const toggleSelectAll = () => {
                const allIds = availablePersonnel.map(p => p.PersonnelID);
                setSelectedPersonnelIds(allIds.every(id => selectedPersonnelIds.includes(id)) ? [] : allIds);
            };

            const handleOpenAdd = async () => {
                setPersonnelSearch('');
                setSelectedPersonnelIds([]);
                setTrainedMap({});
                setIsAddOpen(true);
                if (allPersonnel.length === 0) {
                    try {
                        const r = await gasService.getAllPersonnel();
                        if (r.success && Array.isArray(r.data)) setAllPersonnel(r.data);
                    } catch (err) {}
                }
            };

            const handleAddSelected = async () => {
                if (selectedPersonnelIds.length === 0) return;
                setIsAdding(true);
                let successCount = 0, failCount = 0;
                for (const id of selectedPersonnelIds) {
                    try {
                        const r = await gasService.addPersonAsBartender(id, trainedMap[id] || false, 'Active');
                        if (r.success) successCount++; else failCount++;
                    } catch (err) { failCount++; }
                }
                setIsAdding(false);
                setIsAddOpen(false);
                setSelectedPersonnelIds([]);
                await loadBartenders();
                if (successCount > 0) setMessage({ type: 'success', text: `${successCount} bartender${successCount !== 1 ? 's' : ''} added successfully.` });
                if (failCount > 0) setMessage({ type: 'error', text: `${failCount} person${failCount !== 1 ? 's' : ''} could not be added.` });
            };

            const handleConfirmRemove = async () => {
                if (!removeTarget) return;
                setIsRemoving(true);
                try {
                    const r = await gasService.removeBartender(removeTarget.BartenderID);
                    if (r.success) {
                        setMessage({ type: 'success', text: `${removeTarget.FirstName} ${removeTarget.LastName} removed from bartenders.` });
                        setRemoveTarget(null);
                        await loadBartenders();
                    } else {
                        setMessage({ type: 'error', text: r.error || 'Failed to remove bartender.' });
                        setRemoveTarget(null);
                    }
                } catch (err) {
                    setMessage({ type: 'error', text: 'Error removing bartender.' });
                    setRemoveTarget(null);
                } finally { setIsRemoving(false); }
            };

            const formatDate = (d) => {
                if (!d || d === 'N/A') return 'N/A';
                try { return new Date(d).toLocaleDateString(); } catch { return d; }
            };
            const getInitials = (b) =>
                `${(b.FirstName || '')[0] || ''}${(b.LastName || '')[0] || ''}`.toUpperCase() || '??';

            // Bartender detail panel (split-panel right column)
            const bartenderDetailPanel = selectedBartender
                ? e('div', { style: { height: '100%', display: 'flex', flexDirection: 'column', background: '#fff', borderRadius: '12px', border: '1px solid #e5e7eb', boxShadow: '0 2px 8px rgba(0,0,0,0.08)', overflow: 'hidden' } },
                    e('div', { style: { padding: '16px', borderBottom: '1px solid #f3f4f6', flexShrink: 0 } },
                        e('div', { style: { display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '8px' } },
                            e('div', { style: { width: '48px', height: '48px', borderRadius: '50%', background: '#fef3c7', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#b45309', fontWeight: 700, fontSize: '16px', flexShrink: 0 } }, getInitials(selectedBartender)),
                            e('div', null,
                                e('h2', { style: { fontSize: '15px', fontWeight: 600, color: '#111827', margin: 0 } }, `${selectedBartender.FirstName} ${selectedBartender.LastName}`.trim()),
                                e('div', { style: { display: 'flex', gap: '6px', marginTop: '4px', flexWrap: 'wrap' } },
                                    boolVal(selectedBartender.Trained) && e('span', { style: { padding: '2px 8px', fontSize: '11px', borderRadius: '999px', background: '#e0e7ff', color: '#3730a3', fontWeight: 500 } }, 'Trained'),
                                    e('span', { style: { padding: '2px 8px', fontSize: '11px', borderRadius: '999px', fontWeight: 500, background: boolVal(selectedBartender.Active) ? '#dcfce7' : '#f3f4f6', color: boolVal(selectedBartender.Active) ? '#166534' : '#4b5563' } },
                                        boolVal(selectedBartender.Active) ? 'Active' : 'Inactive'
                                    )
                                )
                            )
                        )
                    ),
                    e('div', { style: { flex: '1 1 0', overflowY: 'auto', padding: '16px' } },
                        e('div', { style: { background: '#f9fafb', borderRadius: '8px', padding: '12px', marginBottom: '12px' } },
                            e('p', { style: { fontSize: '11px', fontWeight: 600, color: '#6b7280', textTransform: 'uppercase', letterSpacing: '0.05em', marginBottom: '8px' } }, 'Contact'),
                            e('div', { style: { display: 'flex', flexDirection: 'column', gap: '6px', fontSize: '13px' } },
                                e('div', null, e('p', { style: { color: '#6b7280', margin: '0 0 2px' } }, 'Email'), e('p', { style: { fontWeight: 500, color: '#111827', margin: 0 } }, selectedBartender.PrimaryEmail || 'N/A')),
                                e('div', null, e('p', { style: { color: '#6b7280', margin: '0 0 2px' } }, 'Phone'), e('p', { style: { fontWeight: 500, color: '#111827', margin: 0 } }, selectedBartender.PrimaryPhone || 'N/A'))
                            )
                        ),
                        e('div', { style: { background: '#fffbeb', borderRadius: '8px', padding: '12px' } },
                            e('p', { style: { fontSize: '11px', fontWeight: 600, color: '#d97706', textTransform: 'uppercase', letterSpacing: '0.05em', marginBottom: '8px' } }, 'Shift Summary'),
                            e('div', { style: { display: 'flex', flexDirection: 'column', gap: '6px', fontSize: '13px' } },
                                e('div', null, e('p', { style: { color: '#6b7280', margin: '0 0 2px' } }, 'Total Shifts'), e('p', { style: { fontWeight: 500, color: '#111827', margin: 0 } }, selectedBartender.ShiftCount || 0)),
                                e('div', null, e('p', { style: { color: '#6b7280', margin: '0 0 2px' } }, 'Last Shift'), e('p', { style: { fontWeight: 500, color: '#111827', margin: 0 } }, formatDate(selectedBartender.LastShiftDate))),
                                e('div', null, e('p', { style: { color: '#6b7280', margin: '0 0 2px' } }, 'Last Show'), e('p', { style: { fontWeight: 500, color: '#111827', margin: 0 } }, selectedBartender.LastShowName || 'N/A'))
                            )
                        )
                    ),
                    e('div', { style: { padding: '12px 16px', borderTop: '1px solid #f3f4f6', display: 'flex', gap: '8px', flexShrink: 0 } },
                        e('button', {
                            onClick: () => { setRemoveTarget(selectedBartender); setSelectedBartender(null); },
                            style: { flex: 1, padding: '8px 0', fontSize: '13px', fontWeight: 500, color: '#dc2626', background: '#fef2f2', border: 'none', borderRadius: '8px', cursor: 'pointer' }
                        }, 'Remove Bartender'),
                        e('button', {
                            onClick: () => setSelectedBartender(null),
                            style: { flex: 1, padding: '8px 0', fontSize: '13px', fontWeight: 500, color: '#374151', background: '#f3f4f6', border: 'none', borderRadius: '8px', cursor: 'pointer' }
                        }, 'Close')
                    )
                )
                : e('div', { style: { height: '100%', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', background: '#f9fafb', borderRadius: '12px', border: '2px dashed #e5e7eb', color: '#9ca3af', textAlign: 'center', padding: '24px' } },
                    e('div', { style: { fontSize: '32px', marginBottom: '8px' } }, '🍺'),
                    e('p', { style: { fontWeight: 500, marginBottom: '4px', margin: '0 0 4px' } }, 'Select a bartender'),
                    e('p', { style: { fontSize: '13px', margin: 0 } }, 'Click any card to view details')
                );

            return e('div', { className: 'flex flex-col p-6 gap-4', style: { height: '100%', overflow: 'hidden', boxSizing: 'border-box' } },
                // Header
                e('div', { className: 'flex justify-between items-center flex-shrink-0' },
                    e('div', null,
                        e('h1', { className: 'text-2xl font-bold text-gray-900' }, 'Bartenders'),
                        e('p', { className: 'text-sm text-gray-500 mt-0.5' }, 'Manage bartender roster and view shift history')
                    ),
                    e('div', { className: 'flex items-center gap-3' },
                        e('p', { className: 'text-sm text-gray-500 bg-white border border-gray-100 px-3 py-1.5 rounded-lg shadow-sm font-medium' }, `${filteredBartenders.length} bartender${filteredBartenders.length !== 1 ? 's' : ''}`),
                        e('button', { onClick: handleOpenAdd, className: 'btn-primary px-4 py-2 text-sm font-semibold text-white rounded-xl' }, '+ Add Bartender')
                    )
                ),

                // Stats
                !isLoading && bartenders.length > 0 && e('div', { className: 'grid grid-cols-1 md:grid-cols-3 gap-3 flex-shrink-0' },
                    e('div', { className: 'bg-white rounded-xl shadow-card border border-gray-100 p-4' },
                        e('p', { className: 'text-xs font-semibold text-gray-400 uppercase tracking-wider' }, 'Total Bartenders'),
                        e('p', { className: 'text-2xl font-bold text-amber-600 mt-1' }, bartenders.length)
                    ),
                    e('div', { className: 'bg-white rounded-xl shadow-card border border-gray-100 p-4' },
                        e('p', { className: 'text-xs font-semibold text-gray-400 uppercase tracking-wider' }, 'Active'),
                        e('p', { className: 'text-2xl font-bold text-emerald-600 mt-1' }, activeCount)
                    ),
                    e('div', { className: 'bg-white rounded-xl shadow-card border border-gray-100 p-4' },
                        e('p', { className: 'text-xs font-semibold text-gray-400 uppercase tracking-wider' }, 'Trained'),
                        e('p', { className: 'text-2xl font-bold text-indigo-600 mt-1' }, trainedCount)
                    )
                ),

                message && e('div', { className: 'flex-shrink-0' },
                    e(Message, { type: message.type, message: message.text, onClose: () => setMessage(null) })
                ),

                // Search + Sort
                e('div', { className: 'flex flex-wrap gap-2 items-center flex-shrink-0' },
                    e('div', { className: 'relative flex-1 min-w-[180px] max-w-sm' },
                        e('input', {
                            type: 'text',
                            placeholder: 'Search by name, email, or phone…',
                            value: searchTerm,
                            onChange: (ev) => setSearchTerm(ev.target.value),
                            className: 'w-full pl-10 pr-4 py-2.5 text-sm border border-gray-200 rounded-xl bg-white shadow-sm focus:border-sky-400 transition-colors'
                        }),
                        e('span', { style: { position: 'absolute', left: '12px', top: '10px', color: '#9ca3af' } }, '🔍')
                    ),
                    e('select', {
                        value: sortBy, onChange: (ev) => setSortBy(ev.target.value),
                        className: 'px-3 py-2.5 text-sm border border-gray-200 rounded-xl bg-white shadow-sm focus:border-sky-400 transition-colors'
                    },
                        e('option', { value: 'az' }, 'Name A → Z'),
                        e('option', { value: 'za' }, 'Name Z → A'),
                        e('option', { value: 'shifts' }, 'Most Shifts'),
                        e('option', { value: 'active' }, 'Active First'),
                        e('option', { value: 'trained' }, 'Trained First')
                    )
                ),

                // Split panel
                e('div', { className: 'flex gap-4', style: { flex: '1 1 0', minHeight: 0, overflow: 'hidden' } },
                    // Left col - scrollable cards
                    e('div', { style: { flex: '1 1 0', overflowY: 'auto', minHeight: 0 } },
                        isLoading ? e('div', { className: 'flex justify-center py-12' },
                            e('p', { className: 'text-gray-500' }, 'Loading bartenders...')
                        ) : filteredBartenders.length === 0 ? e('div', { className: 'text-center py-12 text-gray-500' },
                            e('p', { className: 'text-lg font-medium mb-1' }, 'No bartenders found'),
                            e('p', { className: 'text-sm' }, 'Try adjusting your search or add a bartender.')
                        ) : e('div', { className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 pb-4' },
                            filteredBartenders.map(b =>
                                e('div', {
                                    key: b.BartenderID,
                                    onClick: () => { setSelectedBartender(b); },
                                    className: 'bg-white rounded-xl shadow-card border border-gray-100 p-4 hover:shadow-md transition-shadow cursor-pointer',
                                    style: selectedBartender && selectedBartender.BartenderID === b.BartenderID ? { outline: '2px solid #f59e0b' } : {}
                                },
                                    e('div', { className: 'flex items-center space-x-3 mb-3' },
                                        e('div', { className: 'w-10 h-10 bg-amber-100 rounded-full flex items-center justify-center text-amber-700 font-semibold' }, getInitials(b)),
                                        e('div', { className: 'flex-1 min-w-0' },
                                            e('h3', { className: 'font-semibold text-gray-900 truncate' }, `${b.FirstName} ${b.LastName}`.trim() || 'Unknown'),
                                            e('p', { className: 'text-sm text-gray-500 truncate' }, b.PrimaryEmail || 'No email')
                                        )
                                    ),
                                    e('div', { className: 'space-y-1 text-sm text-gray-600 mb-3' },
                                        e('p', null, e('strong', null, 'Phone: '), b.PrimaryPhone || 'N/A'),
                                        e('p', null, e('strong', null, 'Shifts: '), b.ShiftCount || 0),
                                        e('p', null, e('strong', null, 'Last Shift: '), formatDate(b.LastShiftDate))
                                    ),
                                    e('div', { className: 'flex flex-wrap gap-1.5 mb-3' },
                                        boolVal(b.Trained) && e('span', { className: 'px-2 py-0.5 text-xs rounded-full bg-indigo-100 text-indigo-800 font-medium' }, 'Trained'),
                                        boolVal(b.Active)
                                            ? e('span', { className: 'px-2 py-0.5 text-xs rounded-full bg-green-100 text-green-800 font-medium' }, 'Active')
                                            : e('span', { className: 'px-2 py-0.5 text-xs rounded-full bg-gray-100 text-gray-600 font-medium' }, 'Inactive')
                                    ),
                                    e('div', { className: 'pt-3 border-t border-gray-100' },
                                        e('button', {
                                            onClick: (ev) => { ev.stopPropagation(); setRemoveTarget(b); },
                                            className: 'w-full px-3 py-1.5 text-xs font-medium text-red-600 bg-red-50 rounded hover:bg-red-100 transition-colors'
                                        }, 'Remove Bartender')
                                    )
                                )
                            )
                        )
                    ),
                    // Right col - detail panel
                    e('div', { style: { width: '320px', flexShrink: 0, minHeight: 0, overflow: 'hidden', display: 'flex', flexDirection: 'column' } },
                        bartenderDetailPanel
                    )
                ),

                // Add Modal
                isAddOpen && e('div', { className: 'fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4', onClick: () => setIsAddOpen(false) },
                    e('div', { className: 'bg-white rounded-lg p-6 max-w-lg w-full mx-4 max-h-[80vh] flex flex-col', onClick: (ev) => ev.stopPropagation() },
                        e('div', { className: 'flex justify-between items-center mb-4' },
                            e('h2', { className: 'text-lg font-semibold text-gray-900' }, 'Add Bartenders from Personnel'),
                            e('button', { onClick: () => setIsAddOpen(false), className: 'text-gray-400 hover:text-gray-600 text-xl' }, '×')
                        ),
                        e('input', {
                            type: 'text', placeholder: 'Search personnel...',
                            value: personnelSearch, onChange: (ev) => setPersonnelSearch(ev.target.value),
                            className: 'mb-2 w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-sky-400'
                        }),
                        availablePersonnel.length > 0 && e('div', { className: 'flex items-center justify-between mb-2 px-1' },
                            e('label', { className: 'flex items-center gap-2 text-sm text-gray-600 cursor-pointer' },
                                e('input', { type: 'checkbox', checked: availablePersonnel.every(p => selectedPersonnelIds.includes(p.PersonnelID)), onChange: toggleSelectAll, className: 'w-4 h-4 accent-amber-600' }),
                                'Select all'
                            ),
                            selectedPersonnelIds.length > 0 && e('span', { className: 'text-sm text-amber-700 font-medium' }, `${selectedPersonnelIds.length} selected`)
                        ),
                        e('div', { className: 'overflow-y-auto flex-1' },
                            availablePersonnel.length === 0
                                ? e('p', { className: 'text-center text-gray-500 py-6' }, 'No available personnel found.')
                                : availablePersonnel.map(person => {
                                    const isChecked = selectedPersonnelIds.includes(person.PersonnelID);
                                    return e('div', {
                                        key: person.PersonnelID,
                                        className: `flex items-center gap-3 p-3 mb-1 border rounded-lg transition-colors ${isChecked ? 'border-amber-400 bg-amber-50' : 'border-gray-200 hover:bg-gray-50'}`
                                    },
                                        e('input', { type: 'checkbox', checked: isChecked, onChange: () => toggleSelect(person.PersonnelID), className: 'w-4 h-4 accent-amber-600 flex-shrink-0' }),
                                        e('div', { className: 'flex-1 min-w-0' },
                                            e('p', { className: 'font-medium text-gray-900' }, `${person.FirstName} ${person.LastName}`.trim()),
                                            e('p', { className: 'text-sm text-gray-500 truncate' }, person.PrimaryEmail || 'No email')
                                        ),
                                        isChecked && e('label', { className: 'flex items-center gap-1.5 text-xs text-gray-600 cursor-pointer flex-shrink-0' },
                                            e('input', {
                                                type: 'checkbox',
                                                checked: trainedMap[person.PersonnelID] || false,
                                                onChange: (ev) => setTrainedMap(prev => ({ ...prev, [person.PersonnelID]: ev.target.checked })),
                                                className: 'w-3.5 h-3.5 accent-indigo-600'
                                            }),
                                            'Trained'
                                        )
                                    );
                                })
                        ),
                        e('div', { className: 'mt-4 flex justify-between items-center' },
                            e('button', { onClick: () => setIsAddOpen(false), className: 'px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors' }, 'Cancel'),
                            e('button', {
                                onClick: handleAddSelected,
                                disabled: isAdding || selectedPersonnelIds.length === 0,
                                className: 'px-4 py-2 text-white bg-amber-600 rounded-lg hover:bg-amber-700 disabled:opacity-50 transition-colors font-medium'
                            }, isAdding ? 'Adding...' : `Add ${selectedPersonnelIds.length > 0 ? selectedPersonnelIds.length + ' ' : ''}Selected`)
                        )
                    )
                ),

                // Remove Confirmation Modal
                removeTarget && e('div', { className: 'fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4', onClick: () => setRemoveTarget(null) },
                    e('div', { className: 'bg-white rounded-lg p-6 max-w-md w-full mx-4', onClick: (ev) => ev.stopPropagation() },
                        e('h2', { className: 'text-lg font-semibold text-gray-900 mb-2' }, 'Remove Bartender'),
                        e('p', { className: 'text-gray-600 mb-6' },
                            'Are you sure you want to remove ',
                            e('span', { className: 'font-medium text-gray-900' }, `${removeTarget.FirstName} ${removeTarget.LastName}`),
                            ' from the Bartenders table? Their shift history will be preserved.'
                        ),
                        e('div', { className: 'flex justify-end gap-3' },
                            e('button', { onClick: () => setRemoveTarget(null), disabled: isRemoving, className: 'px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors' }, 'Cancel'),
                            e('button', { onClick: handleConfirmRemove, disabled: isRemoving, className: 'px-4 py-2 text-white bg-red-600 rounded-lg hover:bg-red-700 disabled:opacity-50 transition-colors' },
                                isRemoving ? 'Removing...' : 'Remove'
                            )
                        )
                    )
                ),

            );
        }

        // Teachers Page Component
        function TeachersPage() {
            const [teachers, setTeachers] = React.useState([]);
            const [filteredTeachers, setFilteredTeachers] = React.useState([]);
            const [isLoading, setIsLoading] = React.useState(true);
            const [searchTerm, setSearchTerm] = React.useState('');
            const [selectedTeacher, setSelectedTeacher] = React.useState(null);
            const [message, setMessage] = React.useState(null);
            const [isAddOpen, setIsAddOpen] = React.useState(false);
            const [allPersonnel, setAllPersonnel] = React.useState([]);
            const [personnelSearch, setPersonnelSearch] = React.useState('');
            const [selectedPersonnelId, setSelectedPersonnelId] = React.useState(null);
            const [isAdding, setIsAdding] = React.useState(false);
            const [removeTarget, setRemoveTarget] = React.useState(null);
            const [isRemoving, setIsRemoving] = React.useState(false);
            const [sortBy, setSortBy] = React.useState('az');

            React.useEffect(() => { loadTeachers(); }, []);

            React.useEffect(() => {
                const name = t => `${t.FirstName || ''} ${t.LastName || ''}`.toLowerCase();
                const term = searchTerm.toLowerCase();
                let filtered = term
                    ? teachers.filter(t =>
                        name(t).includes(term) ||
                        (t.PrimaryEmail || '').toLowerCase().includes(term) ||
                        (t.PrimaryPhone || '').toLowerCase().includes(term)
                    )
                    : [...teachers];
                if (sortBy === 'az') filtered = [...filtered].sort((a, b) => name(a).localeCompare(name(b)));
                else if (sortBy === 'za') filtered = [...filtered].sort((a, b) => name(b).localeCompare(name(a)));
                else if (sortBy === 'active') filtered = [...filtered].sort((a, b) => {
                    const aA = String(a.Active).toLowerCase() === 'true' || a.Active === true ? 0 : 1;
                    const bA = String(b.Active).toLowerCase() === 'true' || b.Active === true ? 0 : 1;
                    return aA - bA;
                });
                else if (sortBy === 'totalclasses') filtered = [...filtered].sort((a, b) => (b.TotalClasses || 0) - (a.TotalClasses || 0));
                else if (sortBy === 'activeclasses') filtered = [...filtered].sort((a, b) => (b.ActiveClasses || 0) - (a.ActiveClasses || 0));
                setFilteredTeachers(filtered);
            }, [teachers, searchTerm, sortBy]);

            const loadTeachers = async () => {
                setIsLoading(true);
                try {
                    const response = await gasService.getTeachersWithDetails();
                    const data = response.data && Array.isArray(response.data) ? response.data
                        : response.data && response.data.data ? response.data.data : [];
                    if (response.success) {
                        setTeachers(data);
                        setMessage(null);
                    } else {
                        setMessage({ type: 'error', text: response.error || 'Failed to load teachers.' });
                    }
                } catch (err) {
                    setMessage({ type: 'error', text: 'Error loading teachers.' });
                } finally { setIsLoading(false); }
            };

            const handleOpenAdd = async () => {
                setIsAddOpen(true);
                setPersonnelSearch('');
                setSelectedPersonnelId(null);
                try {
                    const r = await gasService.getAllPersonnel();
                    const all = r.data && r.data.data ? r.data.data : Array.isArray(r.data) ? r.data : [];
                    const teacherIds = new Set(teachers.map(t => String(t.PersonnelID)));
                    setAllPersonnel(all.filter(p => !teacherIds.has(String(p.PersonnelID))));
                } catch { setAllPersonnel([]); }
            };

            const handleAddSelected = async () => {
                if (!selectedPersonnelId) return;
                setIsAdding(true);
                try {
                    const r = await gasService.addPersonAsTeacher(selectedPersonnelId);
                    if (r.success) {
                        setIsAddOpen(false);
                        setSelectedPersonnelId(null);
                        setMessage({ type: 'success', text: 'Teacher added successfully!' });
                        await loadTeachers();
                    } else {
                        setMessage({ type: 'error', text: r.error || 'Failed to add teacher.' });
                        setIsAddOpen(false);
                    }
                } catch (err) {
                    setMessage({ type: 'error', text: 'Error adding teacher.' });
                    setIsAddOpen(false);
                } finally { setIsAdding(false); }
            };

            const handleConfirmRemove = async () => {
                if (!removeTarget) return;
                setIsRemoving(true);
                try {
                    const r = await gasService.removeTeacher(removeTarget.TeacherID);
                    if (r.success) {
                        setRemoveTarget(null);
                        if (selectedTeacher && selectedTeacher.TeacherID === removeTarget.TeacherID) setSelectedTeacher(null);
                        setMessage({ type: 'success', text: 'Teacher removed successfully.' });
                        await loadTeachers();
                    } else {
                        setMessage({ type: 'error', text: r.error || 'Failed to remove teacher.' });
                        setRemoveTarget(null);
                    }
                } catch (err) {
                    setMessage({ type: 'error', text: 'Error removing teacher.' });
                    setRemoveTarget(null);
                } finally { setIsRemoving(false); }
            };

            const formatDate = (d) => {
                if (!d || d === 'N/A') return 'N/A';
                try { return new Date(d).toLocaleDateString(); } catch { return d; }
            };

            const getInitials = (t) =>
                `${(t.FirstName || '')[0] || ''}${(t.LastName || '')[0] || ''}`.toUpperCase() || '??';

            const activeCount = teachers.filter(t => String(t.Active).toLowerCase() === 'true' || t.Active === true).length;
            const totalClasses = teachers.reduce((sum, t) => sum + (t.TotalClasses || 0), 0);

            const availablePersonnel = allPersonnel.filter(p =>
                !personnelSearch ||
                `${p.FirstName} ${p.LastName}`.toLowerCase().includes(personnelSearch.toLowerCase()) ||
                (p.PrimaryEmail || '').toLowerCase().includes(personnelSearch.toLowerCase())
            );

            const getClassStatusColor = (status) => {
                if (!status) return 'bg-gray-100 text-gray-600';
                const s = status.toLowerCase();
                if (s === 'active' || s === 'in progress') return 'bg-green-100 text-green-700';
                if (s === 'scheduled' || s === 'upcoming') return 'bg-blue-100 text-blue-700';
                if (s === 'completed') return 'bg-slate-100 text-slate-600';
                if (s === 'cancelled' || s === 'canceled') return 'bg-red-100 text-red-600';
                return 'bg-gray-100 text-gray-600';
            };

            // Detail panel
            const teacherDetailPanel = selectedTeacher
                ? e('div', { style: { height: '100%', display: 'flex', flexDirection: 'column', background: '#fff', borderRadius: '12px', border: '1px solid #e5e7eb', boxShadow: '0 2px 8px rgba(0,0,0,0.08)', overflow: 'hidden' } },
                    e('div', { style: { padding: '16px', borderBottom: '1px solid #f3f4f6', flexShrink: 0 } },
                        e('div', { style: { display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '8px' } },
                            e('div', { style: { width: '48px', height: '48px', borderRadius: '50%', background: '#dcfce7', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#166534', fontWeight: 700, fontSize: '16px', flexShrink: 0 } }, getInitials(selectedTeacher)),
                            e('div', null,
                                e('h2', { style: { fontSize: '15px', fontWeight: 600, color: '#111827', margin: 0 } }, `${selectedTeacher.FirstName} ${selectedTeacher.LastName}`.trim()),
                                e('div', { style: { display: 'flex', gap: '6px', marginTop: '4px' } },
                                    e('span', { style: { padding: '2px 8px', fontSize: '11px', borderRadius: '999px', fontWeight: 500, background: (String(selectedTeacher.Active).toLowerCase() === 'true' || selectedTeacher.Active === true) ? '#dcfce7' : '#f3f4f6', color: (String(selectedTeacher.Active).toLowerCase() === 'true' || selectedTeacher.Active === true) ? '#166534' : '#4b5563' } },
                                        (String(selectedTeacher.Active).toLowerCase() === 'true' || selectedTeacher.Active === true) ? 'Active' : 'Inactive'
                                    )
                                )
                            )
                        )
                    ),
                    e('div', { style: { flex: '1 1 0', overflowY: 'auto', padding: '16px', display: 'flex', flexDirection: 'column', gap: '12px' } },
                        e('div', { style: { background: '#f9fafb', borderRadius: '8px', padding: '12px' } },
                            e('p', { style: { fontSize: '11px', fontWeight: 600, color: '#6b7280', textTransform: 'uppercase', letterSpacing: '0.05em', marginBottom: '8px' } }, 'Contact'),
                            e('div', { style: { display: 'flex', flexDirection: 'column', gap: '6px', fontSize: '13px' } },
                                e('div', null, e('p', { style: { color: '#6b7280', margin: '0 0 2px' } }, 'Email'), e('p', { style: { fontWeight: 500, color: '#111827', margin: 0 } }, selectedTeacher.PrimaryEmail || 'N/A')),
                                e('div', null, e('p', { style: { color: '#6b7280', margin: '0 0 2px' } }, 'Phone'), e('p', { style: { fontWeight: 500, color: '#111827', margin: 0 } }, selectedTeacher.PrimaryPhone || 'N/A'))
                            )
                        ),
                        e('div', { style: { background: '#f0fdf4', borderRadius: '8px', padding: '12px' } },
                            e('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' } },
                                e('p', { style: { fontSize: '11px', fontWeight: 600, color: '#16a34a', textTransform: 'uppercase', letterSpacing: '0.05em', margin: 0 } }, 'Classes'),
                                e('span', { style: { fontSize: '11px', fontWeight: 600, background: '#dcfce7', color: '#166534', borderRadius: '999px', padding: '2px 8px' } }, `${selectedTeacher.TotalClasses || 0} total`)
                            ),
                            selectedTeacher.Classes && selectedTeacher.Classes.length > 0
                                ? e('div', { style: { display: 'flex', flexDirection: 'column', gap: '6px' } },
                                    selectedTeacher.Classes.map((cls, idx) =>
                                        e('div', { key: idx, style: { background: '#fff', borderRadius: '6px', padding: '8px 10px', border: '1px solid #e5e7eb' } },
                                            e('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', gap: '6px' } },
                                                e('p', { style: { fontWeight: 600, fontSize: '13px', color: '#111827', margin: 0, flex: 1 } }, cls.LevelName || 'Class'),
                                                e('span', { className: `text-xs px-1.5 py-0.5 rounded font-medium ${getClassStatusColor(cls.Status)}` }, cls.Status || 'Unknown')
                                            ),
                                            e('p', { style: { fontSize: '12px', color: '#6b7280', margin: '4px 0 0' } },
                                                cls.StartDate ? `${formatDate(cls.StartDate)}${cls.EndDate ? ' → ' + formatDate(cls.EndDate) : ''}` : 'No dates'
                                            ),
                                            cls.VenueOrRoom && e('p', { style: { fontSize: '11px', color: '#9ca3af', margin: '2px 0 0' } }, `📍 ${cls.VenueOrRoom}`)
                                        )
                                    )
                                )
                                : e('p', { style: { fontSize: '13px', color: '#9ca3af', textAlign: 'center', padding: '8px 0', margin: 0 } }, 'No classes assigned')
                        )
                    ),
                    e('div', { style: { padding: '12px 16px', borderTop: '1px solid #f3f4f6', display: 'flex', gap: '8px', flexShrink: 0 } },
                        e('button', {
                            onClick: () => { setRemoveTarget(selectedTeacher); setSelectedTeacher(null); },
                            style: { flex: 1, padding: '8px 0', fontSize: '13px', fontWeight: 500, color: '#dc2626', background: '#fef2f2', border: 'none', borderRadius: '8px', cursor: 'pointer' }
                        }, 'Remove Teacher'),
                        e('button', {
                            onClick: () => setSelectedTeacher(null),
                            style: { flex: 1, padding: '8px 0', fontSize: '13px', fontWeight: 500, color: '#374151', background: '#f3f4f6', border: 'none', borderRadius: '8px', cursor: 'pointer' }
                        }, 'Close')
                    )
                )
                : e('div', { style: { height: '100%', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', background: '#f9fafb', borderRadius: '12px', border: '2px dashed #e5e7eb', color: '#9ca3af', textAlign: 'center', padding: '24px' } },
                    e('div', { style: { fontSize: '32px', marginBottom: '8px' } }, '🎓'),
                    e('p', { style: { fontWeight: 500, marginBottom: '4px', margin: '0 0 4px' } }, 'Select a teacher'),
                    e('p', { style: { fontSize: '13px', margin: 0 } }, 'Click any card to view details')
                );

            return e('div', { className: 'flex flex-col p-6 gap-4', style: { height: '100%', overflow: 'hidden', boxSizing: 'border-box' } },
                // Header
                e('div', { className: 'flex justify-between items-center flex-shrink-0' },
                    e('div', null,
                        e('h1', { className: 'text-2xl font-bold text-gray-900' }, 'Teachers'),
                        e('p', { className: 'text-sm text-gray-500 mt-0.5' }, 'Manage teaching roster and class assignments')
                    ),
                    e('div', { className: 'flex items-center gap-3' },
                        e('p', { className: 'text-sm text-gray-500 bg-white border border-gray-100 px-3 py-1.5 rounded-lg shadow-sm font-medium' }, `${filteredTeachers.length} teacher${filteredTeachers.length !== 1 ? 's' : ''}`),
                        e('button', { onClick: handleOpenAdd, className: 'btn-primary px-4 py-2 text-sm font-semibold text-white rounded-xl' }, '+ Add Teacher')
                    )
                ),

                // Stats
                !isLoading && teachers.length > 0 && e('div', { className: 'grid grid-cols-1 md:grid-cols-3 gap-3 flex-shrink-0' },
                    e('div', { className: 'bg-white rounded-xl shadow-card border border-gray-100 p-4' },
                        e('p', { className: 'text-xs font-semibold text-gray-400 uppercase tracking-wider' }, 'Total Teachers'),
                        e('p', { className: 'text-2xl font-bold text-emerald-600 mt-1' }, teachers.length)
                    ),
                    e('div', { className: 'bg-white rounded-xl shadow-card border border-gray-100 p-4' },
                        e('p', { className: 'text-xs font-semibold text-gray-400 uppercase tracking-wider' }, 'Active'),
                        e('p', { className: 'text-2xl font-bold text-green-600 mt-1' }, activeCount)
                    ),
                    e('div', { className: 'bg-white rounded-xl shadow-card border border-gray-100 p-4' },
                        e('p', { className: 'text-xs font-semibold text-gray-400 uppercase tracking-wider' }, 'Total Classes'),
                        e('p', { className: 'text-2xl font-bold text-indigo-600 mt-1' }, totalClasses)
                    )
                ),

                message && e('div', { className: 'flex-shrink-0' },
                    e(Message, { type: message.type, message: message.text, onClose: () => setMessage(null) })
                ),

                // Search + Sort
                e('div', { className: 'flex flex-wrap gap-2 items-center flex-shrink-0' },
                    e('div', { className: 'relative flex-1 min-w-[180px] max-w-sm' },
                        e('input', {
                            type: 'text',
                            placeholder: 'Search by name, email, or phone…',
                            value: searchTerm,
                            onChange: (ev) => setSearchTerm(ev.target.value),
                            className: 'w-full pl-10 pr-4 py-2.5 text-sm border border-gray-200 rounded-xl bg-white shadow-sm focus:border-sky-400 transition-colors'
                        }),
                        e('span', { style: { position: 'absolute', left: '12px', top: '10px', color: '#9ca3af' } }, '🔍')
                    ),
                    e('select', {
                        value: sortBy, onChange: (ev) => setSortBy(ev.target.value),
                        className: 'px-3 py-2.5 text-sm border border-gray-200 rounded-xl bg-white shadow-sm focus:border-sky-400 transition-colors'
                    },
                        e('option', { value: 'az' }, 'Name A → Z'),
                        e('option', { value: 'za' }, 'Name Z → A'),
                        e('option', { value: 'active' }, 'Active First'),
                        e('option', { value: 'totalclasses' }, 'Most Classes'),
                        e('option', { value: 'activeclasses' }, 'Active Classes')
                    )
                ),

                // Split panel
                e('div', { className: 'flex gap-4', style: { flex: '1 1 0', minHeight: 0, overflow: 'hidden' } },
                    e('div', { style: { flex: '1 1 0', overflowY: 'auto', minHeight: 0 } },
                        isLoading ? e('div', { className: 'flex justify-center py-12' },
                            e('p', { className: 'text-gray-500' }, 'Loading teachers...')
                        ) : filteredTeachers.length === 0 ? e('div', { className: 'text-center py-12 text-gray-500' },
                            e('p', { className: 'text-lg font-medium mb-1' }, 'No teachers found'),
                            e('p', { className: 'text-sm' }, 'Try adjusting your search or add a teacher.')
                        ) : e('div', { className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 pb-4' },
                            filteredTeachers.map(t =>
                                e('div', {
                                    key: t.TeacherID,
                                    onClick: () => setSelectedTeacher(t),
                                    className: 'bg-white rounded-xl shadow-card border border-gray-100 p-4 hover:shadow-md transition-shadow cursor-pointer',
                                    style: selectedTeacher && selectedTeacher.TeacherID === t.TeacherID ? { outline: '2px solid #16a34a' } : {}
                                },
                                    e('div', { className: 'flex items-center space-x-3 mb-3' },
                                        e('div', { className: 'w-10 h-10 bg-green-100 rounded-full flex items-center justify-center text-green-700 font-semibold flex-shrink-0' }, getInitials(t)),
                                        e('div', { className: 'flex-1 min-w-0' },
                                            e('h3', { className: 'font-semibold text-gray-900 truncate' }, `${t.FirstName} ${t.LastName}`.trim() || 'Unknown'),
                                            e('p', { className: 'text-sm text-gray-500 truncate' }, t.PrimaryEmail || 'No email')
                                        )
                                    ),
                                    e('div', { className: 'space-y-1 text-sm text-gray-600 mb-3' },
                                        e('p', null, e('strong', null, 'Phone: '), t.PrimaryPhone || 'N/A'),
                                        e('p', null, e('strong', null, 'Classes: '), t.TotalClasses || 0),
                                        e('p', null, e('strong', null, 'Active Classes: '), t.ActiveClasses || 0)
                                    ),
                                    e('div', { className: 'flex flex-wrap gap-1.5 mb-3' },
                                        (String(t.Active).toLowerCase() === 'true' || t.Active === true)
                                            ? e('span', { className: 'px-2 py-0.5 text-xs rounded-full bg-green-100 text-green-800 font-medium' }, 'Active')
                                            : e('span', { className: 'px-2 py-0.5 text-xs rounded-full bg-gray-100 text-gray-600 font-medium' }, 'Inactive')
                                    ),
                                    e('div', { className: 'pt-3 border-t border-gray-100' },
                                        e('button', {
                                            onClick: (ev) => { ev.stopPropagation(); setRemoveTarget(t); },
                                            className: 'w-full px-3 py-1.5 text-xs font-medium text-red-600 bg-red-50 rounded hover:bg-red-100 transition-colors'
                                        }, 'Remove Teacher')
                                    )
                                )
                            )
                        )
                    ),
                    e('div', { style: { width: '320px', flexShrink: 0, minHeight: 0, overflow: 'hidden', display: 'flex', flexDirection: 'column' } },
                        teacherDetailPanel
                    )
                ),

                // Add Modal
                isAddOpen && e('div', { className: 'fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4', onClick: () => setIsAddOpen(false) },
                    e('div', { className: 'bg-white rounded-lg p-6 max-w-lg w-full mx-4 max-h-[80vh] flex flex-col', onClick: (ev) => ev.stopPropagation() },
                        e('div', { className: 'flex justify-between items-center mb-4' },
                            e('h2', { className: 'text-lg font-semibold text-gray-900' }, 'Add Teacher from Personnel'),
                            e('button', { onClick: () => setIsAddOpen(false), className: 'text-gray-400 hover:text-gray-600 text-xl' }, '×')
                        ),
                        e('input', {
                            type: 'text', placeholder: 'Search personnel...',
                            value: personnelSearch, onChange: (ev) => setPersonnelSearch(ev.target.value),
                            className: 'mb-3 w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-sky-400'
                        }),
                        e('div', { className: 'overflow-y-auto flex-1' },
                            availablePersonnel.length === 0
                                ? e('p', { className: 'text-center text-gray-500 py-6' }, 'No available personnel found.')
                                : availablePersonnel.map(person => {
                                    const isSelected = selectedPersonnelId === person.PersonnelID;
                                    return e('div', {
                                        key: person.PersonnelID,
                                        onClick: () => setSelectedPersonnelId(isSelected ? null : person.PersonnelID),
                                        className: `flex items-center gap-3 p-3 mb-1 border rounded-lg transition-colors cursor-pointer ${isSelected ? 'border-green-400 bg-green-50' : 'border-gray-200 hover:bg-gray-50'}`
                                    },
                                        e('div', { className: `w-5 h-5 rounded-full border-2 flex items-center justify-center flex-shrink-0 ${isSelected ? 'border-green-500 bg-green-500' : 'border-gray-300'}` },
                                            isSelected && e('div', { className: 'w-2 h-2 rounded-full bg-white' })
                                        ),
                                        e('div', { className: 'flex-1 min-w-0' },
                                            e('p', { className: 'font-medium text-gray-900' }, `${person.FirstName} ${person.LastName || person.Lastname || ''}`.trim()),
                                            e('p', { className: 'text-sm text-gray-500 truncate' }, person.PrimaryEmail || 'No email')
                                        )
                                    );
                                })
                        ),
                        e('div', { className: 'mt-4 flex justify-between items-center' },
                            e('button', { onClick: () => setIsAddOpen(false), className: 'px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors' }, 'Cancel'),
                            e('button', {
                                onClick: handleAddSelected,
                                disabled: isAdding || !selectedPersonnelId,
                                className: 'px-4 py-2 text-white bg-green-600 rounded-lg hover:bg-green-700 disabled:opacity-50 transition-colors font-medium'
                            }, isAdding ? 'Adding...' : 'Add Teacher')
                        )
                    )
                ),

                // Remove Confirmation Modal
                removeTarget && e('div', { className: 'fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4', onClick: () => setRemoveTarget(null) },
                    e('div', { className: 'bg-white rounded-lg p-6 max-w-md w-full mx-4', onClick: (ev) => ev.stopPropagation() },
                        e('h2', { className: 'text-lg font-semibold text-gray-900 mb-2' }, 'Remove Teacher'),
                        e('p', { className: 'text-gray-600 mb-6' },
                            'Are you sure you want to remove ',
                            e('span', { className: 'font-medium text-gray-900' }, `${removeTarget.FirstName} ${removeTarget.LastName}`),
                            ' from the Teachers table? Their class history will be preserved.'
                        ),
                        e('div', { className: 'flex justify-end gap-3' },
                            e('button', { onClick: () => setRemoveTarget(null), disabled: isRemoving, className: 'px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors' }, 'Cancel'),
                            e('button', { onClick: handleConfirmRemove, disabled: isRemoving, className: 'px-4 py-2 text-white bg-red-600 rounded-lg hover:bg-red-700 disabled:opacity-50 transition-colors' },
                                isRemoving ? 'Removing...' : 'Remove'
                            )
                        )
                    )
                )
            );
        }

        // Sidebar Component
        function Sidebar({ currentPage, onNavigate }) {
            // SVG icon map — simple, consistent stroke icons
            const icons = {
                dashboard:         e('svg', { className: 'w-4 h-4', fill: 'none', strokeWidth: '2', stroke: 'currentColor', viewBox: '0 0 24 24' }, e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', d: 'M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6' })),
                personnel:         e('svg', { className: 'w-4 h-4', fill: 'none', strokeWidth: '2', stroke: 'currentColor', viewBox: '0 0 24 24' }, e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', d: 'M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z' })),
                'student-directory': e('svg', { className: 'w-4 h-4', fill: 'none', strokeWidth: '2', stroke: 'currentColor', viewBox: '0 0 24 24' }, e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', d: 'M12 14l9-5-9-5-9 5 9 5zm0 0l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z' })),
                cast:              e('svg', { className: 'w-4 h-4', fill: 'none', strokeWidth: '2', stroke: 'currentColor', viewBox: '0 0 24 24' }, e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', d: 'M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z' })),
                crew:              e('svg', { className: 'w-4 h-4', fill: 'none', strokeWidth: '2', stroke: 'currentColor', viewBox: '0 0 24 24' }, e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', d: 'M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z' }), e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', d: 'M15 12a3 3 0 11-6 0 3 3 0 016 0z' })),
                bartenders:        e('svg', { className: 'w-4 h-4', fill: 'none', strokeWidth: '2', stroke: 'currentColor', viewBox: '0 0 24 24' }, e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', d: 'M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2' })),
                teachers:          e('svg', { className: 'w-4 h-4', fill: 'none', strokeWidth: '2', stroke: 'currentColor', viewBox: '0 0 24 24' }, e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', d: 'M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z' })),
                classes:           e('svg', { className: 'w-4 h-4', fill: 'none', strokeWidth: '2', stroke: 'currentColor', viewBox: '0 0 24 24' }, e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', d: 'M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253' })),
                shows:             e('svg', { className: 'w-4 h-4', fill: 'none', strokeWidth: '2', stroke: 'currentColor', viewBox: '0 0 24 24' }, e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', d: 'M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 20h16a1 1 0 001-1V5a1 1 0 00-1-1H4a1 1 0 00-1 1v14a1 1 0 001 1z' })),
                inventory:         e('svg', { className: 'w-4 h-4', fill: 'none', strokeWidth: '2', stroke: 'currentColor', viewBox: '0 0 24 24' }, e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', d: 'M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4' })),
                scheduling:        e('svg', { className: 'w-4 h-4', fill: 'none', strokeWidth: '2', stroke: 'currentColor', viewBox: '0 0 24 24' }, e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', d: 'M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z' }))
            };

            const navigationItems = [
                { id: 'dashboard',         label: 'Dashboard'  },
                { id: 'personnel',         label: 'Personnel'  },
                { id: 'student-directory', label: 'Students'   },
                { id: 'cast',              label: 'Cast'        },
                { id: 'crew',              label: 'Crew'        },
                { id: 'bartenders',        label: 'Bartenders' },
                { id: 'teachers',          label: 'Teachers'   },
                { id: 'classes',           label: 'Classes'    },
                { id: 'shows',             label: 'Shows'      },
                { id: 'inventory',         label: 'Inventory'  },
                { id: 'scheduling',        label: 'Schedule'   }
            ];

            return e('div', { className: 'bg-slate-900 h-full w-60 flex flex-col flex-shrink-0', style: { minWidth: '240px' } },

                // ── Brand ──────────────────────────────────────────────
                e('div', { className: 'px-5 py-5 border-b border-slate-700/60' },
                    e('div', { className: 'flex items-center gap-2.5 mb-0.5' },
                        e('div', { className: 'w-7 h-7 rounded-lg bg-sky-500 flex items-center justify-center flex-shrink-0' },
                            e('svg', { className: 'w-4 h-4 text-white', fill: 'none', stroke: 'currentColor', strokeWidth: '2.5', viewBox: '0 0 24 24' },
                                e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', d: 'M13 10V3L4 14h7v7l9-11h-7z' })
                            )
                        ),
                        e('div', null,
                            e('h1', { className: 'text-sm font-bold text-white leading-tight tracking-wide' }, 'JTF PORTAL'),
                            e('p', { className: 'text-xs text-slate-400 leading-tight' }, 'Team Management')
                        )
                    )
                ),

                // ── Nav ────────────────────────────────────────────────
                e('nav', { className: 'flex-1 px-3 py-4 overflow-y-auto' },
                    e('p', { className: 'px-2 mb-2 text-xs font-semibold text-slate-500 uppercase tracking-widest' }, 'Navigation'),
                    e('ul', { className: 'space-y-0.5' },
                        navigationItems.map((item) => {
                            const isActive = currentPage === item.id;
                            return e('li', { key: item.id },
                                e('button', {
                                    onClick: () => onNavigate(item.id),
                                    className: `nav-item w-full flex items-center gap-3 px-3 py-2 rounded-lg text-left text-sm font-medium ${
                                        isActive
                                            ? 'bg-sky-500 text-white shadow-sm'
                                            : 'text-slate-400 hover:bg-slate-800 hover:text-slate-100'
                                    }`
                                },
                                    e('span', { className: `flex-shrink-0 ${isActive ? 'text-white' : 'text-slate-500'}` },
                                        icons[item.id] || e('span', { className: 'w-4 h-4 block' })
                                    ),
                                    e('span', null, item.label)
                                )
                            );
                        })
                    )
                ),

                // ── Footer ─────────────────────────────────────────────
                e('div', { className: 'px-5 py-4 border-t border-slate-700/60' },
                    e('p', { className: 'text-xs text-slate-500' }, '© 2026 JTF Team Portal'),
                    e('p', { className: 'text-xs text-slate-600 mt-0.5' }, 'v1.0.1')
                )
            );
        }

        // Class Management View Component
        function ClassManagementView({ offeringId, onBack }) {
            const [classData, setClassData] = useState(null);
            const [enrolledStudents, setEnrolledStudents] = useState([]);
            const [attendanceRecords, setAttendanceRecords] = useState([]);
            const [classDates, setClassDates] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [message, setMessage] = useState(null);
            const [showAddStudentModal, setShowAddStudentModal] = useState(false);
            const [availableStudents, setAvailableStudents] = useState([]);
            const [modalTab, setModalTab] = useState('enrolled'); // 'enrolled' or 'add'
            const [modalSearchTerm, setModalSearchTerm] = useState('');
            const [modalLoading, setModalLoading] = useState(false);
            const [selectedPersonnel, setSelectedPersonnel] = useState([]); // Array of PersonnelIDs for multi-select
            const [roleFilter, setRoleFilter] = useState('all'); // 'all', 'cast', 'student', 'teacher', 'other'
            const [levelFilter, setLevelFilter] = useState('all'); // 'all', 'IA1', 'IA2', 'IA3', etc.
            const [castMembers, setCastMembers] = useState([]); // List of PersonnelIDs who are cast members
            const [teachers, setTeachers] = useState([]); // List of PersonnelIDs who are teachers
            const [studentLevels, setStudentLevels] = useState({}); // Map of PersonnelID -> highest level

            // Edit class state
            const [showEditModal, setShowEditModal] = useState(false);
            const [editFormData, setEditFormData] = useState({});
            const [editTeachers, setEditTeachers] = useState([]);
            const [editClassLevels, setEditClassLevels] = useState([]);
            const [isSavingEdit, setIsSavingEdit] = useState(false);

            // Generate array of class dates based on start and end dates
            const generateClassDates = (startDate, endDate, meetingDays = 'Monday,Wednesday') => {
                const dates = [];
                const start = new Date(startDate);
                const end = new Date(endDate);
                
                // For now, generate weekly dates (every Monday and Wednesday)
                // You can customize this based on actual meeting days
                const current = new Date(start);
                
                while (current <= end) {
                    // Add Mondays (1) and Wednesdays (3)
                    if (current.getDay() === 1 || current.getDay() === 3) {
                        dates.push(new Date(current));
                    }
                    current.setDate(current.getDate() + 1);
                }
                
                return dates;
            };

            useEffect(() => {
                loadClassDetails();
            }, [offeringId]);

            const loadClassDetails = async () => {
                setIsLoading(true);
                try {
                    const response = await gasService.getClassOfferingDetails(offeringId);
                    console.log('Class details response:', response);

                    if (response.success && response.data) {
                        const data = response.data.data || response.data;
                        console.log('Processed class details:', data);
                        
                        const offering = data.classOffering || {};
                        setClassData(offering);
                        setEnrolledStudents(data.enrolledStudents || []);
                        
                        // Log attendance records for debugging
                        const attendance = data.attendanceRecords || [];
                        console.log(`Loaded ${attendance.length} attendance records:`, attendance);
                        setAttendanceRecords(attendance);
                        
                        // Generate class dates
                        if (offering.StartDate && offering.EndDate) {
                            const dates = generateClassDates(offering.StartDate, offering.EndDate);
                            setClassDates(dates);
                            console.log('Generated class dates:', dates);
                        }
                    } else {
                        setMessage({ type: 'error', text: response.error || 'Failed to load class details' });
                    }
                } catch (error) {
                    console.error('Error loading class details:', error);
                    setMessage({ type: 'error', text: 'Error loading class details' });
                } finally {
                    setIsLoading(false);
                }
            };

            const handleUpdateEnrollmentStatus = async (enrollmentId, newStatus) => {
                try {
                    const response = await gasService.updateEnrollmentStatus(enrollmentId, newStatus);
                    
                    if (response.success) {
                        setMessage({ type: 'success', text: `Enrollment status updated to ${newStatus}` });
                        loadClassDetails(); // Refresh data
                    } else {
                        setMessage({ type: 'error', text: response.error || 'Failed to update status' });
                    }
                } catch (error) {
                    console.error('Error updating enrollment status:', error);
                    setMessage({ type: 'error', text: 'Error updating enrollment status' });
                }
            };

            // Get attendance status for a specific student on a specific date
            const getAttendanceStatus = (enrollmentId, classDate) => {
                // Convert to local date string (YYYY-MM-DD) without timezone conversion
                const year = classDate.getFullYear();
                const month = String(classDate.getMonth() + 1).padStart(2, '0');
                const day = String(classDate.getDate()).padStart(2, '0');
                const dateStr = `${year}-${month}-${day}`;
                
                // Get from saved records
                const record = attendanceRecords.find(r => {
                    if (!r.ClassDate) return false;
                    
                    // Normalize record date for comparison
                    const recordDateStr = typeof r.ClassDate === 'string' 
                        ? r.ClassDate.split('T')[0] 
                        : new Date(r.ClassDate).toISOString().split('T')[0];
                    
                    return r.EnrollmentID == enrollmentId && recordDateStr === dateStr;
                });
                
                return record ? record.AttendanceStatus : null;
            };

            // Save attendance immediately when changed
            const handleAttendanceChange = async (enrollmentId, classDate, newStatus) => {
                // Convert to local date string (YYYY-MM-DD) without timezone conversion
                const year = classDate.getFullYear();
                const month = String(classDate.getMonth() + 1).padStart(2, '0');
                const day = String(classDate.getDate()).padStart(2, '0');
                const dateStr = `${year}-${month}-${day}`;
                
                try {
                    const response = await gasService.updateClassAttendance({
                        enrollmentId: enrollmentId,
                        offeringId: offeringId,
                        classDate: dateStr,
                        status: newStatus || '',
                        notes: ''
                    });

                    if (response.success) {
                        // Update local state immediately
                        const updatedRecords = [...attendanceRecords];
                        const existingIndex = updatedRecords.findIndex(r => {
                            if (!r.ClassDate) return false;
                            const recordDateStr = typeof r.ClassDate === 'string' 
                                ? r.ClassDate.split('T')[0] 
                                : new Date(r.ClassDate).toISOString().split('T')[0];
                            return r.EnrollmentID == enrollmentId && recordDateStr === dateStr;
                        });

                        if (existingIndex >= 0) {
                            updatedRecords[existingIndex].AttendanceStatus = newStatus;
                        } else {
                            updatedRecords.push({
                                EnrollmentID: enrollmentId,
                                ClassDate: dateStr,
                                AttendanceStatus: newStatus
                            });
                        }
                        
                        setAttendanceRecords(updatedRecords);
                        setMessage({ type: 'success', text: 'Attendance saved' });
                    } else {
                        setMessage({ type: 'error', text: response.error || 'Failed to save attendance' });
                    }
                } catch (error) {
                    console.error('Error saving attendance:', error);
                    setMessage({ type: 'error', text: 'Error saving attendance' });
                }
            };

            // Load available personnel (anyone can take a class) when modal is opened
            const loadAvailableStudents = async () => {
                setModalLoading(true);
                try {
                    // Load all personnel
                    const personnelResponse = await gasService.getAllPersonnel();
                    
                    // Load cast members to identify who's in cast
                    const castResponse = await gasService.getAllCastMembers();
                    
                    // Load students to get their levels
                    const studentsResponse = await gasService.getAllStudentsWithDetails();
                    
                    // Load teachers
                    const teachersResponse = await gasService.getActiveTeachers();
                    
                    if (personnelResponse.success) {
                        // Get data - handle both wrapped and unwrapped responses
                        const personnel = personnelResponse.data?.data || personnelResponse.data || [];
                        
                        // Get cast member PersonnelIDs
                        const castData = castResponse.success ? (castResponse.data?.data || castResponse.data || []) : [];
                        const castPersonnelIds = castData.map(c => c.PersonnelID).filter(id => id != null);
                        setCastMembers(castPersonnelIds);
                        
                        // Get teacher PersonnelIDs
                        const teacherData = teachersResponse.success ? (teachersResponse.data?.data || teachersResponse.data || []) : [];
                        const teacherPersonnelIds = teacherData.map(t => t.PersonnelID).filter(id => id != null);
                        setTeachers(teacherPersonnelIds);
                        
                        // Build map of PersonnelID -> highest level completed
                        const studentsData = studentsResponse.success ? (studentsResponse.data?.data || studentsResponse.data || []) : [];
                        const levelMap = {};
                        studentsData.forEach(student => {
                            if (student.PersonnelID && student.HighestLevelCompleted) {
                                // Store raw value from database (e.g., "IA1", "IA2", "No Levels Completed")
                                levelMap[student.PersonnelID] = student.HighestLevelCompleted;
                            }
                        });
                        console.log('Student levels loaded:', levelMap);
                        setStudentLevels(levelMap);
                        
                        // Filter out already enrolled students by PersonnelID
                        const enrolledPersonnelIds = enrolledStudents.map(s => s.PersonnelID).filter(id => id != null);
                        const available = personnel.filter(p => !enrolledPersonnelIds.includes(p.PersonnelID));
                        
                        setAvailableStudents(available);
                    } else {
                        setMessage({ type: 'error', text: personnelResponse.error || 'Failed to load personnel' });
                    }
                } catch (error) {
                    console.error('Error loading available personnel:', error);
                    setMessage({ type: 'error', text: 'Error loading personnel' });
                } finally {
                    setModalLoading(false);
                }
            };

            // Add selected personnel to class (bulk operation)
            const handleAddSelectedPersonnel = async () => {
                if (selectedPersonnel.length === 0) {
                    setMessage({ type: 'error', text: 'Please select at least one person to add' });
                    return;
                }
                
                setModalLoading(true);
                try {
                    const response = await gasService.bulkEnrollStudents(selectedPersonnel, offeringId);
                    console.log('Bulk enrollment response:', response);
                    
                    if (response.success) {
                        const result = response.data?.data || response.data;
                        console.log('Enrollment result:', result);
                        console.log('Details:', result.details);
                        
                        let successMsg = `Successfully enrolled ${result.enrolled} ${result.enrolled === 1 ? 'person' : 'people'}`;
                        if (result.alreadyEnrolled > 0) {
                            successMsg += `, ${result.alreadyEnrolled} already enrolled`;
                        }
                        if (result.failed > 0) {
                            successMsg += `, ${result.failed} failed`;
                            // Log failed details
                            if (result.details && result.details.failed) {
                                console.log('Failed enrollments:', result.details.failed);
                            }
                        }
                        
                        setMessage({ type: result.failed > 0 ? 'warning' : 'success', text: successMsg });
                        setSelectedPersonnel([]); // Clear selection
                        await loadClassDetails(); // Refresh enrolled students
                        await loadAvailableStudents(); // Refresh available personnel
                    } else {
                        setMessage({ type: 'error', text: response.error || 'Failed to enroll personnel' });
                    }
                } catch (error) {
                    console.error('Error enrolling personnel:', error);
                    setMessage({ type: 'error', text: 'Error enrolling personnel' });
                } finally {
                    setModalLoading(false);
                }
            };

            // Toggle personnel selection
            const togglePersonnelSelection = (personnelId) => {
                setSelectedPersonnel(prev => {
                    if (prev.includes(personnelId)) {
                        return prev.filter(id => id !== personnelId);
                    } else {
                        return [...prev, personnelId];
                    }
                });
            };

            // Select/Deselect all filtered personnel
            const handleSelectAll = (selectAll) => {
                if (selectAll) {
                    // Apply the same filters as the display list
                    const filtered = availableStudents.filter(person => {
                        // Text search filter
                        const searchMatch = `${person.FirstName} ${person.LastName}`.toLowerCase().includes(modalSearchTerm.toLowerCase()) ||
                            person.PrimaryEmail?.toLowerCase().includes(modalSearchTerm.toLowerCase());
                        
                        if (!searchMatch) return false;
                        
                        // Role filter
                        if (roleFilter !== 'all') {
                            const isCast = castMembers.includes(person.PersonnelID);
                            const isTeacher = teachers.includes(person.PersonnelID);
                            const isStudent = studentLevels.hasOwnProperty(person.PersonnelID);
                            
                            if (roleFilter === 'cast' && !isCast) return false;
                            if (roleFilter === 'teacher' && !isTeacher) return false;
                            if (roleFilter === 'student' && !isStudent) return false;
                            if (roleFilter === 'other' && (isCast || isTeacher || isStudent)) return false;
                        }
                        
                        // Level filter
                        if (levelFilter !== 'all' && roleFilter !== 'cast' && roleFilter !== 'teacher') {
                            const personLevel = studentLevels[person.PersonnelID];
                            
                            // Direct string comparison (database has "IA1", "IA2", "No Levels Completed", etc.)
                            if (personLevel !== levelFilter) return false;
                        }
                        
                        return true;
                    });
                    setSelectedPersonnel(filtered.map(p => p.PersonnelID));
                } else {
                    setSelectedPersonnel([]);
                }
            };

            // Remove student from class
            const handleRemoveStudent = async (enrollmentId) => {
                if (!confirm('Are you sure you want to remove this student from the class?')) {
                    return;
                }
                
                setModalLoading(true);
                try {
                    const response = await gasService.removeStudentFromClass(enrollmentId);
                    if (response.success) {
                        setMessage({ type: 'success', text: 'Student removed successfully' });
                        await loadClassDetails(); // Refresh enrolled students
                        await loadAvailableStudents(); // Refresh available students
                    } else {
                        setMessage({ type: 'error', text: response.error || 'Failed to remove student' });
                    }
                } catch (error) {
                    console.error('Error removing student:', error);
                    setMessage({ type: 'error', text: 'Error removing student' });
                } finally {
                    setModalLoading(false);
                }
            };

            // Open edit modal and pre-fill form
            const handleOpenEditModal = async () => {
                setEditFormData({
                    ClassLevelID: classData.ClassLevelID || '',
                    TeacherID: classData.TeacherID || '',
                    StartDate: classData.StartDate ? new Date(classData.StartDate).toISOString().split('T')[0] : '',
                    EndDate: classData.EndDate ? new Date(classData.EndDate).toISOString().split('T')[0] : '',
                    MaxStudents: classData.MaxStudents || '12',
                    Status: classData.Status || 'Upcoming',
                    VenueOrRoom: classData.VenueOrRoom || '',
                    MeetingDays: classData.MeetingDays || '',
                    MeetingTime: classData.MeetingTime || ''
                });
                try {
                    const [teachersResp, levelsResp] = await Promise.all([
                        gasService.getActiveTeachers(),
                        gasService.getAllClassLevels()
                    ]);
                    if (teachersResp.success) {
                        const data = Array.isArray(teachersResp.data) ? teachersResp.data : (teachersResp.data?.data || []);
                        setEditTeachers(data);
                    }
                    if (levelsResp.success) {
                        const data = Array.isArray(levelsResp.data) ? levelsResp.data : (levelsResp.data?.data || []);
                        setEditClassLevels(data);
                    }
                } catch (err) {
                    console.error('Error loading edit form data:', err);
                }
                setShowEditModal(true);
            };

            const handleSaveClassEdits = async () => {
                if (!editFormData.ClassLevelID || !editFormData.TeacherID || !editFormData.StartDate || !editFormData.EndDate) {
                    setMessage({ type: 'error', text: 'Level, teacher, start date, and end date are required.' });
                    return;
                }
                setIsSavingEdit(true);
                try {
                    const response = await gasService.updateClassOffering({
                        OfferingID: offeringId,
                        ClassLevelID: Number(editFormData.ClassLevelID),
                        TeacherID: Number(editFormData.TeacherID),
                        StartDate: editFormData.StartDate,
                        EndDate: editFormData.EndDate,
                        MaxStudents: Number(editFormData.MaxStudents) || 12,
                        Status: editFormData.Status,
                        VenueOrRoom: editFormData.VenueOrRoom,
                        MeetingDays: editFormData.MeetingDays,
                        MeetingTime: editFormData.MeetingTime
                    });
                    if (response.success) {
                        setMessage({ type: 'success', text: 'Class updated successfully!' });
                        setShowEditModal(false);
                        loadClassDetails();
                    } else {
                        setMessage({ type: 'error', text: response.error || 'Failed to update class.' });
                    }
                } catch (err) {
                    setMessage({ type: 'error', text: 'Error saving class.' });
                } finally {
                    setIsSavingEdit(false);
                }
            };

            // Open modal and load available personnel if switching to "add" tab
            useEffect(() => {
                if (showAddStudentModal && modalTab === 'add' && availableStudents.length === 0) {
                    loadAvailableStudents();
                }
            }, [showAddStudentModal, modalTab]);

            if (isLoading) {
                return e(Loader, { text: 'Loading class details...' });
            }

            if (!classData) {
                return e('div', { className: 'p-6' },
                    e('p', null, 'Class not found')
                );
            }

            return e('div', { className: 'p-6 max-w-7xl mx-auto' },
                // Back Button and Header
                e('div', { className: 'mb-6' },
                    e('button', {
                        onClick: onBack,
                        className: 'flex items-center text-blue-600 hover:text-blue-700 mb-4'
                    },
                        e('svg', { className: 'w-5 h-5 mr-2', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                            e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M15 19l-7-7 7-7' })
                        ),
                        'Back to Classes'
                    ),
                    
                    e('div', { className: 'bg-white rounded-xl shadow-card border border-gray-100 p-6' },
                        e('div', { className: 'flex justify-between items-start' },
                            e('div', null,
                                e('h1', { className: 'text-3xl font-bold text-gray-900' }, classData.LevelName || 'Class'),
                                e('p', { className: 'text-gray-600 mt-1' }, `Taught by ${classData.TeacherName || 'TBA'}`)
                            ),
                            e('div', { className: 'flex items-center gap-2' },
                                e('button', {
                                    onClick: handleOpenEditModal,
                                    className: 'px-3 py-1.5 text-sm font-medium text-blue-600 border border-blue-300 rounded-lg hover:bg-blue-50 transition-colors flex items-center gap-1.5'
                                },
                                    e('svg', { className: 'w-4 h-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                                        e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z' })
                                    ),
                                    'Edit Details'
                                ),
                                e('span', {
                                    className: `px-3 py-1 rounded-full text-sm font-medium ${
                                        classData.Status === 'Upcoming' ? 'bg-yellow-100 text-yellow-800' :
                                        classData.Status === 'In Progress' ? 'bg-green-100 text-green-800' :
                                        'bg-blue-100 text-blue-800'
                                    }`
                                }, classData.Status)
                            )
                        ),
                        e('div', { className: 'grid grid-cols-3 gap-4 mt-4' },
                            e('div', null,
                                e('p', { className: 'text-sm text-gray-600' }, 'Start Date'),
                                e('p', { className: 'font-semibold' }, new Date(classData.StartDate).toLocaleDateString())
                            ),
                            e('div', null,
                                e('p', { className: 'text-sm text-gray-600' }, 'End Date'),
                                e('p', { className: 'font-semibold' }, new Date(classData.EndDate).toLocaleDateString())
                            ),
                            e('div', null,
                                e('p', { className: 'text-sm text-gray-600' }, 'Enrollment'),
                                e('p', { className: 'font-semibold' }, `${enrolledStudents.length} / ${classData.MaxStudents || 12} students`)
                            )
                        )
                    )
                ),

                message && e(Message, {
                    type: message.type,
                    message: message.text,
                    onClose: () => setMessage(null)
                }),

                // Roster Management Section
                e('div', { className: 'bg-white rounded-xl shadow-card border border-gray-100 p-6 mb-6' },
                    e('div', { className: 'flex justify-between items-center mb-4' },
                        e('h2', { className: 'text-xl font-bold text-gray-900' }, 'Class Roster'),
                        e('button', {
                            onClick: () => setShowAddStudentModal(true),
                            className: 'btn-primary text-white px-4 py-2 text-sm font-semibold rounded-xl flex items-center gap-2'
                        },
                            e('svg', { className: 'w-5 h-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                                e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M12 4v16m8-8H4' })
                            ),
                            'Update Roster'
                        )
                    ),

                    enrolledStudents.length > 0 ? (
                        e('div', { className: 'overflow-x-auto' },
                            e('table', { className: 'min-w-full divide-y divide-gray-200' },
                                e('thead', { className: 'bg-gray-50' },
                                    e('tr', null,
                                        e('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider' }, 'Student Name'),
                                        e('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider' }, 'Email'),
                                        e('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider' }, 'Enrolled Date'),
                                        e('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider' }, 'Status')
                                    )
                                ),
                                e('tbody', { className: 'bg-white divide-y divide-gray-200' },
                                    enrolledStudents.map(student =>
                                        e('tr', { key: student.EnrollmentID },
                                            e('td', { className: 'px-6 py-4 whitespace-nowrap' },
                                                e('div', { className: 'text-sm font-medium text-gray-900' },
                                                    `${student.FirstName} ${student.LastName}`
                                                )
                                            ),
                                            e('td', { className: 'px-6 py-4 whitespace-nowrap' },
                                                e('div', { className: 'text-sm text-gray-500' }, student.PrimaryEmail || '-')
                                            ),
                                            e('td', { className: 'px-6 py-4 whitespace-nowrap' },
                                                e('div', { className: 'text-sm text-gray-500' },
                                                    student.EnrollmentDate ? new Date(student.EnrollmentDate).toLocaleDateString() : '-'
                                                )
                                            ),
                                            e('td', { className: 'px-6 py-4 whitespace-nowrap' },
                                                e('select', {
                                                    value: student.CompletionStatus || 'Active',
                                                    onChange: (ev) => handleUpdateEnrollmentStatus(student.EnrollmentID, ev.target.value),
                                                    className: `text-sm px-2 py-1 rounded ${
                                                        student.CompletionStatus === 'Completed' ? 'bg-green-100 text-green-800' :
                                                        student.CompletionStatus === 'Dropped' ? 'bg-red-100 text-red-800' :
                                                        'bg-blue-100 text-blue-800'
                                                    }`
                                                },
                                                    e('option', { value: 'Active' }, 'Active'),
                                                    e('option', { value: 'Completed' }, 'Completed'),
                                                    e('option', { value: 'Dropped' }, 'Dropped'),
                                                    e('option', { value: 'Withdrawn' }, 'Withdrawn')
                                                )
                                            )
                                        )
                                    )
                                )
                            )
                        )
                    ) : (
                        e('div', { className: 'text-center py-12 text-gray-500' },
                            e('svg', { className: 'mx-auto h-12 w-12 text-gray-400', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                                e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z' })
                            ),
                            e('h3', { className: 'mt-2 text-sm font-medium text-gray-900' }, 'No students enrolled'),
                            e('p', { className: 'mt-1 text-sm text-gray-500' }, 'Get started by adding students to this class'),
                            e('div', { className: 'mt-6' },
                                e('button', {
                                    onClick: () => setShowAddStudentModal(true),
                                    className: 'inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700'
                                },
                                    e('svg', { className: '-ml-1 mr-2 h-5 w-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                                        e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M12 4v16m8-8H4' })
                                    ),
                                    'Update Roster'
                                )
                            )
                        )
                    )
                ),

                // Attendance Tracking Grid
                e('div', { className: 'bg-white rounded-xl shadow-card border border-gray-100 p-6' },
                    e('div', { className: 'flex justify-between items-center mb-4' },
                        e('h2', { className: 'text-xl font-bold text-gray-900' }, 'Attendance Tracking'),
                        
                    ),
                    
                    enrolledStudents.length > 0 && classDates.length > 0 ? (
                        e('div', { className: 'overflow-x-auto' },
                            e('table', { className: 'min-w-full divide-y divide-gray-200' },
                                // Header Row
                                e('thead', { className: 'bg-gray-50' },
                                    e('tr', null,
                                        e('th', { className: 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky left-0 bg-gray-50 z-10' }, 
                                            'Student Name'
                                        ),
                                        classDates.map((date, idx) =>
                                            e('th', { 
                                                key: idx,
                                                className: 'px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider min-w-[80px]'
                                            },
                                                e('div', null, date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }))
                                            )
                                        )
                                    )
                                ),
                                // Student Rows
                                e('tbody', { className: 'bg-white divide-y divide-gray-200' },
                                    enrolledStudents.map(student =>
                                        e('tr', { key: student.EnrollmentID },
                                            e('td', { className: 'px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900 sticky left-0 bg-white z-10' },
                                                `${student.FirstName} ${student.LastName}`
                                            ),
                                            classDates.map((date, dateIdx) => {
                                                const status = getAttendanceStatus(student.EnrollmentID, date);
                                                
                                                return e('td', { 
                                                    key: dateIdx,
                                                    className: 'px-2 py-3 text-center'
                                                },
                                                    e('select', {
                                                        value: status || '',
                                                        onChange: (ev) => handleAttendanceChange(student.EnrollmentID, date, ev.target.value),
                                                        className: `text-xs px-2 py-1 rounded border-0 cursor-pointer ${
                                                            status === 'Present' ? 'bg-green-100 text-green-800' :
                                                            status === 'Absent' ? 'bg-red-100 text-red-800' :
                                                            status === 'Excused' ? 'bg-yellow-100 text-yellow-800' :
                                                            status === 'Tardy' ? 'bg-orange-100 text-orange-800' :
                                                            'bg-gray-100 text-gray-600'
                                                        }`
                                                    },
                                                        e('option', { value: '' }, '-'),
                                                        e('option', { value: 'Present' }, 'P'),
                                                        e('option', { value: 'Absent' }, 'A'),
                                                        e('option', { value: 'Excused' }, 'E'),
                                                        e('option', { value: 'Tardy' }, 'T')
                                                    )
                                                );
                                            })
                                        )
                                    )
                                )
                            )
                        )
                    ) : (
                        e('div', { className: 'text-center py-12 text-gray-500' },
                            e('svg', { className: 'mx-auto h-12 w-12 text-gray-400', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                                e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2' })
                            ),
                            e('h3', { className: 'mt-2 text-sm font-medium text-gray-900' }, 'No attendance data yet'),
                            e('p', { className: 'mt-1 text-sm text-gray-500' }, 
                                enrolledStudents.length === 0 
                                    ? 'Add students to the class to start tracking attendance'
                                    : 'Class dates will be generated based on the class schedule'
                            )
                        )
                    )
                ),

                // Student Enrollment Management Modal
                showAddStudentModal && e('div', { 
                    className: 'fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 p-4',
                    onClick: () => {
                        setShowAddStudentModal(false);
                        setModalTab('enrolled');
                        setModalSearchTerm('');
                        setSelectedPersonnel([]);
                    }
                },
                    e('div', { 
                        className: 'bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col',
                        onClick: (ev) => ev.stopPropagation()
                    },
                        // Header
                        e('div', { className: 'px-6 py-4 border-b border-gray-200 flex items-center justify-between' },
                            e('div', null,
                                e('h2', { className: 'text-2xl font-bold text-gray-900' }, classData.LevelName || `Level ${classData.ClassLevelID}`),
                                e('p', { className: 'text-sm text-gray-600 mt-1' }, `${classData.TeacherName} • ${classData.Status}`)
                            ),
                            e('button', {
                                onClick: () => {
                                    setShowAddStudentModal(false);
                                    setModalTab('enrolled');
                                    setModalSearchTerm('');
                                    setSelectedPersonnel([]);
                                },
                                className: 'text-gray-400 hover:text-gray-600 text-2xl font-bold'
                            }, '×')
                        ),

                        // Message
                        message && e('div', { className: 'px-6 pt-4' },
                            e(Message, { type: message.type, message: message.text, onClose: () => setMessage(null) })
                        ),

                        // Tabs
                        e('div', { className: 'px-6 pt-4 border-b border-gray-200' },
                            e('div', { className: 'flex justify-between items-center' },
                                // Tab buttons
                                e('div', { className: 'flex space-x-4' },
                                    e('button', {
                                        onClick: () => {
                                            setModalTab('enrolled');
                                            setSelectedPersonnel([]);
                                        },
                                        className: `pb-3 px-2 font-medium border-b-2 transition-colors ${
                                            modalTab === 'enrolled'
                                                ? 'border-blue-600 text-blue-600'
                                                : 'border-transparent text-gray-500 hover:text-gray-700'
                                        }`
                                    }, `Enrolled Students (${enrolledStudents.length}/${classData.MaxStudents})`),
                                    e('button', {
                                        onClick: () => setModalTab('add'),
                                        className: `pb-3 px-2 font-medium border-b-2 transition-colors ${
                                            modalTab === 'add'
                                                ? 'border-blue-600 text-blue-600'
                                                : 'border-transparent text-gray-500 hover:text-gray-700'
                                        }`
                                    }, 'Add Personnel')
                                ),
                                // Bulk actions (only show on Add tab)
                                modalTab === 'add' && e('div', { className: 'flex items-center gap-2' },
                                    selectedPersonnel.length > 0 && e('span', { className: 'text-sm text-gray-600' }, 
                                        `${selectedPersonnel.length} selected`
                                    ),
                                    e('button', {
                                        onClick: () => handleSelectAll(true),
                                        className: 'text-sm text-blue-600 hover:text-blue-700 px-2 py-1'
                                    }, 'Select All'),
                                    e('button', {
                                        onClick: () => handleSelectAll(false),
                                        className: 'text-sm text-gray-600 hover:text-gray-700 px-2 py-1'
                                    }, 'Clear'),
                                    selectedPersonnel.length > 0 && e('button', {
                                        onClick: handleAddSelectedPersonnel,
                                        className: 'px-3 py-1 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm font-medium'
                                    }, `Add ${selectedPersonnel.length}`)
                                )
                            )
                        ),

                        // Search and Filters (only on Add Personnel tab)
                        e('div', { className: 'px-6 py-4 border-b border-gray-200' },
                            // Search bar
                            e('div', { className: 'relative mb-3' },
                                e('input', {
                                    type: 'text',
                                    placeholder: 'Search by name or email...',
                                    value: modalSearchTerm,
                                    onChange: (ev) => setModalSearchTerm(ev.target.value),
                                    className: 'w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg focus:border-sky-400'
                                }),
                                e('svg', { className: 'absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                                    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z' })
                                )
                            ),
                            
                            // Filters (only show on Add Personnel tab)
                            modalTab === 'add' && e('div', { className: 'flex gap-3' },
                                // Role filter
                                e('select', {
                                    value: roleFilter,
                                    onChange: (ev) => setRoleFilter(ev.target.value),
                                    className: 'px-3 py-2 border border-gray-300 rounded-lg text-sm focus:border-sky-400'
                                },
                                    e('option', { value: 'all' }, 'All Roles'),
                                    e('option', { value: 'cast' }, '🎭 Cast Members'),
                                    e('option', { value: 'student' }, '🎓 Students'),
                                    e('option', { value: 'teacher' }, '👨‍🏫 Teachers'),
                                    e('option', { value: 'other' }, '👤 Other Personnel')
                                ),
                                
                                // Level filter (only show for non-cast)
                                roleFilter !== 'cast' && roleFilter !== 'teacher' && e('select', {
                                    value: levelFilter,
                                    onChange: (ev) => setLevelFilter(ev.target.value),
                                    className: 'px-3 py-2 border border-gray-300 rounded-lg text-sm focus:border-sky-400'
                                },
                                    e('option', { value: 'all' }, 'All Levels'),
                                    e('option', { value: 'No Levels Completed' }, 'No Level (New Students)'),
                                    e('option', { value: 'IA1' }, 'IA1'),
                                    e('option', { value: 'IA2' }, 'IA2'),
                                    e('option', { value: 'IA3' }, 'IA3'),
                                    e('option', { value: 'IA4' }, 'IA4'),
                                    e('option', { value: 'IA5' }, 'IA5'),
                                    e('option', { value: 'IA6' }, 'IA6 (Performance)')
                                ),
                                
                                // Clear filters button
                                (roleFilter !== 'all' || levelFilter !== 'all') && e('button', {
                                    onClick: () => {
                                        setRoleFilter('all');
                                        setLevelFilter('all');
                                    },
                                    className: 'px-3 py-2 text-sm text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-colors'
                                }, '✕ Clear Filters')
                            )
                        ),

                        // Student List
                        modalTab === 'enrolled' && e('div', { className: 'px-6 py-4' },
                            e('div', { className: 'relative' },
                                e('input', {
                                    type: 'text',
                                    placeholder: 'Search students...',
                                    value: modalSearchTerm,
                                    onChange: (ev) => setModalSearchTerm(ev.target.value),
                                    className: 'w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg focus:border-sky-400'
                                }),
                                e('svg', { className: 'absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                                    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z' })
                                )
                            )
                        ),

                        // Student List
                        e('div', { className: 'flex-1 overflow-y-auto px-6 pb-6' },
                            modalLoading ? e(Loader, { text: 'Loading people...' }) : 
                            (() => {
                                const people = modalTab === 'enrolled' ? enrolledStudents : availableStudents;
                                
                                // Apply filters
                                let filtered = people.filter(person => {
                                    // Text search filter
                                    const searchMatch = `${person.FirstName} ${person.LastName}`.toLowerCase().includes(modalSearchTerm.toLowerCase()) ||
                                        person.PrimaryEmail?.toLowerCase().includes(modalSearchTerm.toLowerCase());
                                    
                                    if (!searchMatch) return false;
                                    
                                    // Only apply role and level filters on Add Personnel tab
                                    if (modalTab === 'add') {
                                        // Role filter
                                        if (roleFilter !== 'all') {
                                            const isCast = castMembers.includes(person.PersonnelID);
                                            const isTeacher = teachers.includes(person.PersonnelID);
                                            const isStudent = studentLevels.hasOwnProperty(person.PersonnelID);
                                            
                                            if (roleFilter === 'cast' && !isCast) return false;
                                            if (roleFilter === 'teacher' && !isTeacher) return false;
                                            if (roleFilter === 'student' && !isStudent) return false;
                                            if (roleFilter === 'other' && (isCast || isTeacher || isStudent)) return false;
                                        }
                                        
                                        // Level filter (only for non-cast, non-teacher)
                                        if (levelFilter !== 'all' && roleFilter !== 'cast' && roleFilter !== 'teacher') {
                                            const personLevel = studentLevels[person.PersonnelID];
                                            console.log(`Checking PersonnelID ${person.PersonnelID} (${person.FirstName} ${person.LastName}): level=${personLevel}, filterValue=${levelFilter}, match=${personLevel === levelFilter}`);
                                            
                                            // Direct string comparison (database has "IA1", "IA2", "No Levels Completed", etc.)
                                            if (personLevel !== levelFilter) return false;
                                        }
                                    }
                                    
                                    return true;
                                });

                                return filtered.length > 0 ? 
                                    e('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4' },
                                        ...filtered.map(person =>
                                            e('div', { 
                                                key: modalTab === 'enrolled' ? person.StudentID : person.PersonnelID, 
                                                className: `relative border rounded-lg p-4 transition-all ${
                                                    modalTab === 'add' && selectedPersonnel.includes(person.PersonnelID)
                                                        ? 'border-blue-500 bg-blue-50 shadow-md'
                                                        : 'border-gray-200 hover:shadow-md'
                                                }`,
                                                onClick: modalTab === 'add' ? () => togglePersonnelSelection(person.PersonnelID) : null,
                                                style: { cursor: modalTab === 'add' ? 'pointer' : 'default' }
                                            },
                                                // Checkbox (Add tab only)
                                                modalTab === 'add' && e('div', { className: 'absolute top-2 left-2' },
                                                    e('input', {
                                                        type: 'checkbox',
                                                        checked: selectedPersonnel.includes(person.PersonnelID),
                                                        onChange: (ev) => {
                                                            ev.stopPropagation();
                                                            togglePersonnelSelection(person.PersonnelID);
                                                        },
                                                        className: 'w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500'
                                                    })
                                                ),
                                                
                                                // Person info
                                                e('div', { className: modalTab === 'add' ? 'pl-8 pr-2' : 'pr-8' },
                                                    e('div', { className: 'flex items-start justify-between' },
                                                        e('h4', { className: 'font-semibold text-gray-900' }, `${person.FirstName} ${person.LastName}`),
                                                        // Role badges (Add tab only)
                                                        modalTab === 'add' && e('div', { className: 'flex gap-1 ml-2' },
                                                            castMembers.includes(person.PersonnelID) && e('span', { 
                                                                className: 'px-2 py-0.5 bg-purple-100 text-purple-700 text-xs rounded-full',
                                                                title: 'Cast Member'
                                                            }, '🎭'),
                                                            teachers.includes(person.PersonnelID) && e('span', { 
                                                                className: 'px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded-full',
                                                                title: 'Teacher'
                                                            }, '👨‍🏫'),
                                                            studentLevels[person.PersonnelID] && e('span', { 
                                                                className: 'px-2 py-0.5 bg-green-100 text-green-700 text-xs rounded-full',
                                                                title: `Level: ${studentLevels[person.PersonnelID]}`
                                                            }, studentLevels[person.PersonnelID])
                                                        )
                                                    ),
                                                    e('p', { className: 'text-sm text-gray-600 mt-1' }, person.PrimaryEmail || 'No email'),
                                                    person.EnrollmentDate && e('p', { className: 'text-xs text-gray-500 mt-1' }, 
                                                        `Enrolled: ${new Date(person.EnrollmentDate).toLocaleDateString()}`
                                                    )
                                                ),
                                                
                                                // Remove button (Enrolled tab only)
                                                modalTab === 'enrolled' &&
                                                    e('button', {
                                                        onClick: () => person.EnrollmentID && handleRemoveStudent(person.EnrollmentID),
                                                        className: 'absolute top-2 right-2 p-1 bg-red-500 text-white rounded-full hover:bg-red-600 transition-colors',
                                                        title: 'Remove from class'
                                                    },
                                                        e('svg', { className: 'w-4 h-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                                                            e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M6 18L18 6M6 6l12 12' })
                                                        )
                                                    )
                                            )
                                        )
                                    ) :
                                    e('div', { className: 'text-center py-12' },
                                        e('p', { className: 'text-gray-500' },
                                            modalSearchTerm ? 'No people found matching your search' :
                                            modalTab === 'enrolled' ? 'No students enrolled yet' :
                                            'No personnel available to add'
                                        )
                                    );
                            })()
                        ),

                        // Footer
                        e('div', { className: 'px-6 py-4 border-t border-gray-200 flex justify-end' },
                            e('button', {
                                onClick: () => {
                                    setShowAddStudentModal(false);
                                    setModalTab('enrolled');
                                    setModalSearchTerm('');
                                    setSelectedPersonnel([]);
                                },
                                className: 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors'
                            }, 'Close')
                        )
                    )
                ),  // end enrollment modal

                // Edit Class Details Modal
                showEditModal && e('div', {
                    className: 'fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 p-4',
                    onClick: () => setShowEditModal(false)
                },
                    e('div', {
                        className: 'bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto',
                        onClick: (ev) => ev.stopPropagation()
                    },
                        // Header
                        e('div', { className: 'px-6 py-4 border-b border-gray-200 flex items-center justify-between' },
                            e('h2', { className: 'text-2xl font-bold text-gray-900' }, 'Edit Class Details'),
                            e('button', { onClick: () => setShowEditModal(false), className: 'text-gray-400 hover:text-gray-600 text-2xl font-bold' }, '×')
                        ),
                        // Body
                        e('div', { className: 'px-6 py-5 space-y-5' },
                            // Level + Teacher
                            e('div', { className: 'grid grid-cols-2 gap-4' },
                                e('div', null,
                                    e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Class Level *'),
                                    e('select', {
                                        value: editFormData.ClassLevelID || '',
                                        onChange: (ev) => setEditFormData(prev => ({ ...prev, ClassLevelID: ev.target.value })),
                                        className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-sky-400'
                                    },
                                        e('option', { value: '' }, 'Select a level…'),
                                        editClassLevels.map(l =>
                                            e('option', { key: l.ClassLevelID, value: l.ClassLevelID }, l.LevelName)
                                        )
                                    )
                                ),
                                e('div', null,
                                    e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Teacher *'),
                                    e('select', {
                                        value: editFormData.TeacherID || '',
                                        onChange: (ev) => setEditFormData(prev => ({ ...prev, TeacherID: ev.target.value })),
                                        className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-sky-400'
                                    },
                                        e('option', { value: '' }, 'Select a teacher…'),
                                        editTeachers.map(p =>
                                            e('option', { key: p.TeacherID, value: p.TeacherID }, p.FullName || `${p.FirstName} ${p.LastName}`)
                                        )
                                    )
                                )
                            ),
                            // Dates
                            e('div', { className: 'grid grid-cols-2 gap-4' },
                                e('div', null,
                                    e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Start Date *'),
                                    e('input', {
                                        type: 'date',
                                        value: editFormData.StartDate || '',
                                        onChange: (ev) => setEditFormData(prev => ({ ...prev, StartDate: ev.target.value })),
                                        className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-sky-400'
                                    })
                                ),
                                e('div', null,
                                    e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'End Date *'),
                                    e('input', {
                                        type: 'date',
                                        value: editFormData.EndDate || '',
                                        onChange: (ev) => setEditFormData(prev => ({ ...prev, EndDate: ev.target.value })),
                                        className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-sky-400'
                                    })
                                )
                            ),
                            // Status + Max Students
                            e('div', { className: 'grid grid-cols-2 gap-4' },
                                e('div', null,
                                    e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Status'),
                                    e('select', {
                                        value: editFormData.Status || 'Upcoming',
                                        onChange: (ev) => setEditFormData(prev => ({ ...prev, Status: ev.target.value })),
                                        className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-sky-400'
                                    },
                                        e('option', { value: 'Upcoming' }, 'Upcoming'),
                                        e('option', { value: 'In Progress' }, 'In Progress'),
                                        e('option', { value: 'Completed' }, 'Completed'),
                                        e('option', { value: 'Cancelled' }, 'Cancelled')
                                    )
                                ),
                                e('div', null,
                                    e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Max Students'),
                                    e('input', {
                                        type: 'number',
                                        min: 1,
                                        max: 100,
                                        value: editFormData.MaxStudents || '12',
                                        onChange: (ev) => setEditFormData(prev => ({ ...prev, MaxStudents: ev.target.value })),
                                        className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-sky-400'
                                    })
                                )
                            ),
                            // Venue
                            e('div', null,
                                e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Venue / Room'),
                                e('input', {
                                    type: 'text',
                                    placeholder: 'e.g. Studio A, Room 12…',
                                    value: editFormData.VenueOrRoom || '',
                                    onChange: (ev) => setEditFormData(prev => ({ ...prev, VenueOrRoom: ev.target.value })),
                                    className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-sky-400'
                                })
                            ),
                            // Meeting Days
                            e('div', null,
                                e('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 'Meeting Days'),
                                e('div', { className: 'flex flex-wrap gap-2' },
                                    ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'].map(day => {
                                        const days = (editFormData.MeetingDays || '').split(',').map(d => d.trim()).filter(Boolean);
                                        const active = days.includes(day);
                                        return e('button', {
                                            key: day,
                                            type: 'button',
                                            onClick: () => {
                                                const updated = active ? days.filter(d => d !== day) : [...days, day];
                                                setEditFormData(prev => ({ ...prev, MeetingDays: updated.join(', ') }));
                                            },
                                            className: `px-3 py-1 rounded-full text-sm font-medium border transition-colors ${
                                                active ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50'
                                            }`
                                        }, day.slice(0, 3));
                                    })
                                )
                            ),
                            // Meeting Time
                            e('div', null,
                                e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Meeting Time'),
                                e('input', {
                                    type: 'time',
                                    value: editFormData.MeetingTime || '',
                                    onChange: (ev) => setEditFormData(prev => ({ ...prev, MeetingTime: ev.target.value })),
                                    className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-sky-400'
                                })
                            )
                        ),
                        // Footer
                        e('div', { className: 'px-6 py-4 border-t border-gray-200 flex justify-end gap-3' },
                            e('button', {
                                onClick: () => setShowEditModal(false),
                                disabled: isSavingEdit,
                                className: 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors disabled:opacity-50'
                            }, 'Cancel'),
                            e('button', {
                                onClick: handleSaveClassEdits,
                                disabled: isSavingEdit,
                                className: 'px-5 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 flex items-center gap-2'
                            },
                                isSavingEdit && e('svg', { className: 'animate-spin w-4 h-4', fill: 'none', viewBox: '0 0 24 24' },
                                    e('circle', { className: 'opacity-25', cx: '12', cy: '12', r: '10', stroke: 'currentColor', strokeWidth: '4' }),
                                    e('path', { className: 'opacity-75', fill: 'currentColor', d: 'M4 12a8 8 0 018-8v8H4z' })
                                ),
                                'Save Changes'
                            )
                        )
                    )
                )  // end edit modal
            );
        }

        // Class Registration / Management Component
        function ClassRegistration() {
            const [classes, setClasses] = useState([]);
            const [filteredClasses, setFilteredClasses] = useState([]);
            const [filter, setFilter] = useState('all');
            const [searchTerm, setSearchTerm] = useState('');
            const [isLoading, setIsLoading] = useState(true);
            const [message, setMessage] = useState(null);
            const [showNewClassModal, setShowNewClassModal] = useState(false);
            
            // For Class Management View
            const [selectedOfferingId, setSelectedOfferingId] = useState(null);
            const [viewMode, setViewMode] = useState('dashboard'); // 'dashboard' or 'management'
            
            // For New Class Modal
            const [teachers, setTeachers] = useState([]);
            const [classLevels, setClassLevels] = useState([]);
            const [newClassData, setNewClassData] = useState({
                ClassLevelID: '',
                TeacherID: '',
                StartDate: '',
                EndDate: '',
                MaxStudents: '12',
                VenueOrRoom: '',
                Status: 'Upcoming'
            });
            const [isSaving, setIsSaving] = useState(false);

            useEffect(() => {
                loadClasses();
            }, []);

            useEffect(() => {
                applyFilters();
            }, [classes, filter, searchTerm]);

            const loadClasses = async () => {
                setIsLoading(true);
                try {
                    const response = await gasService.getAllClassOfferings();
                    console.log('getAllClassOfferings response:', response);

                    if (response.success && response.data) {
                        // Handle both array and nested data object formats
                        const classData = Array.isArray(response.data) 
                            ? response.data 
                            : (response.data.data || []);
                        console.log('Processed class data:', classData);
                        
                        // Debug: Log first 3 classes with teacher names
                        if (classData.length > 0) {
                            console.log('=== TEACHER NAME DEBUG ===');
                            classData.slice(0, 3).forEach(c => {
                                console.log(`OfferingID ${c.OfferingID}: TeacherID ${c.TeacherID} → TeacherName: "${c.TeacherName}"`);
                            });
                        }
                        
                        setClasses(classData);
                    } else {
                        setMessage({ type: 'error', text: response.error || 'Failed to load classes' });
                    }
                } catch (error) {
                    console.error('Error loading classes:', error);
                    setMessage({ type: 'error', text: 'Error loading classes' });
                } finally {
                    setIsLoading(false);
                }
            };

            const applyFilters = () => {
                let filtered = [...classes];

                // Apply status filter
                if (filter !== 'all') {
                    const statusMap = {
                        'all': '',
                        'upcoming': 'Upcoming',
                        'in-progress': 'In Progress',
                        'completed': 'Completed'
                    };
                    filtered = filtered.filter(c => c.Status === statusMap[filter]);
                }

                // Apply search filter
                if (searchTerm) {
                    filtered = filtered.filter(c =>
                        (c.LevelName && c.LevelName.toLowerCase().includes(searchTerm.toLowerCase())) ||
                        (c.TeacherName && c.TeacherName.toLowerCase().includes(searchTerm.toLowerCase())) ||
                        (c.Location && c.Location.toLowerCase().includes(searchTerm.toLowerCase()))
                    );
                }

                setFilteredClasses(filtered);
            };

            const getFilterCount = (filterType) => {
                if (filterType === 'all') return classes.length;
                const statusMap = {
                    'upcoming': 'Upcoming',
                    'in-progress': 'In Progress',
                    'completed': 'Completed'
                };
                return classes.filter(c => c.Status === statusMap[filterType]).length;
            };

            const handleManageClass = (offeringId) => {
                console.log('Navigate to class management:', offeringId);
                setSelectedOfferingId(offeringId);
                setViewMode('management');
            };

            const loadModalData = async () => {
                try {
                    const [teachersResp, levelsResp] = await Promise.all([
                        gasService.getActiveTeachers(),
                        gasService.getAllClassLevels()
                    ]);

                    console.log('Teachers response:', teachersResp);
                    console.log('Levels response:', levelsResp);

                    if (teachersResp.success && teachersResp.data) {
                        // Handle nested data format
                        const teacherData = Array.isArray(teachersResp.data) 
                            ? teachersResp.data 
                            : (teachersResp.data.data || []);
                        console.log('Processed teacher data:', teacherData);
                        setTeachers(teacherData);
                    }
                    if (levelsResp.success && levelsResp.data) {
                        // Handle nested data format
                        const levelData = Array.isArray(levelsResp.data) 
                            ? levelsResp.data 
                            : (levelsResp.data.data || []);
                        console.log('Processed level data:', levelData);
                        setClassLevels(levelData);
                    }
                } catch (error) {
                    console.error('Error loading modal data:', error);
                }
            };

            const handleOpenModal = () => {
                setShowNewClassModal(true);
                loadModalData();
            };

            const handleCloseModal = () => {
                setShowNewClassModal(false);
                setNewClassData({
                    ClassLevelID: '',
                    TeacherID: '',
                    StartDate: '',
                    EndDate: '',
                    MaxStudents: '12',
                    VenueOrRoom: '',
                    Status: 'Upcoming'
                });
            };

            const handleInputChange = (field, value) => {
                setNewClassData(prev => ({
                    ...prev,
                    [field]: value
                }));
            };

            const handleCreateClass = async () => {
                // Validation
                if (!newClassData.ClassLevelID || !newClassData.TeacherID || !newClassData.StartDate || !newClassData.EndDate) {
                    setMessage({ type: 'error', text: 'Please fill in all required fields' });
                    return;
                }

                setIsSaving(true);
                try {
                    const response = await gasService.createClassOffering(newClassData);

                    if (response.success) {
                        setMessage({ type: 'success', text: 'Class created successfully!' });
                        handleCloseModal();
                        loadClasses(); // Refresh the class list
                    } else {
                        setMessage({ type: 'error', text: response.error || 'Failed to create class' });
                    }
                } catch (error) {
                    console.error('Error creating class:', error);
                    setMessage({ type: 'error', text: 'Error creating class' });
                } finally {
                    setIsSaving(false);
                }
            };

            if (isLoading) {
                return e(Loader, { text: 'Loading classes...' });
            }

            // Show Class Management view if a class is selected
            if (viewMode === 'management' && selectedOfferingId) {
                return e(ClassManagementView, {
                    offeringId: selectedOfferingId,
                    onBack: () => {
                        setViewMode('dashboard');
                        setSelectedOfferingId(null);
                    }
                });
            }

            // Show Dashboard view
            return e('div', { className: 'p-6 max-w-screen-xl' },
                // Header
                e('div', { className: 'mb-6' },
                    e('div', { className: 'flex justify-between items-center mb-4' },
                        e('div', null,
                            e('h1', { className: 'text-2xl font-bold text-gray-900' }, 'Class Management'),
                            e('p', { className: 'text-sm text-gray-500 mt-0.5' }, 'Manage class offerings, rosters, and attendance')
                        ),
                        e('button', {
                            onClick: handleOpenModal,
                            className: 'btn-primary text-white px-4 py-2 text-sm font-semibold rounded-xl flex items-center gap-2'
                        },
                            e('svg', { className: 'w-4 h-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                                e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M12 4v16m8-8H4' })
                            ),
                            'New Class'
                        )
                    ),
                    message && e(Message, {
                        type: message.type,
                        message: message.text,
                        onClose: () => setMessage(null)
                    })
                ),

                // Filters
                e('div', { className: 'mb-6 space-y-4' },
                    e('div', { className: 'flex gap-2' },
                        e('button', {
                            onClick: () => setFilter('all'),
                            className: `px-4 py-2 rounded-lg font-medium transition-colors ${
                                filter === 'all'
                                    ? 'bg-blue-600 text-white'
                                    : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-50'
                            }`
                        }, `All Classes (${getFilterCount('all')})`),
                        e('button', {
                            onClick: () => setFilter('upcoming'),
                            className: `px-4 py-2 rounded-lg font-medium transition-colors ${
                                filter === 'upcoming'
                                    ? 'bg-yellow-500 text-white'
                                    : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-50'
                            }`
                        }, `Upcoming (${getFilterCount('upcoming')})`),
                        e('button', {
                            onClick: () => setFilter('in-progress'),
                            className: `px-4 py-2 rounded-lg font-medium transition-colors ${
                                filter === 'in-progress'
                                    ? 'bg-green-600 text-white'
                                    : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-50'
                            }`
                        }, `In Progress (${getFilterCount('in-progress')})`),
                        e('button', {
                            onClick: () => setFilter('completed'),
                            className: `px-4 py-2 rounded-lg font-medium transition-colors ${
                                filter === 'completed'
                                    ? 'bg-blue-600 text-white'
                                    : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-50'
                            }`
                        }, `Completed (${getFilterCount('completed')})`)
                    ),
                    // Search
                    e('div', { className: 'relative' },
                        e('input', {
                            type: 'text',
                            placeholder: 'Search classes by name, teacher, or location...',
                            value: searchTerm,
                            onChange: (ev) => setSearchTerm(ev.target.value),
                            className: 'w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg focus:border-sky-400'
                        }),
                        e('svg', {
                            className: 'absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400',
                            fill: 'none',
                            stroke: 'currentColor',
                            viewBox: '0 0 24 24'
                        },
                            e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z' })
                        )
                    )
                ),

                // Classes Grid
                filteredClasses.length > 0 ? (
                    e('div', { className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6' },
                        filteredClasses.map(classOffering =>
                            e(ClassCard, {
                                key: classOffering.OfferingID,
                                classOffering: classOffering,
                                onManage: () => handleManageClass(classOffering.OfferingID)
                            })
                        )
                    )
                ) : (
                    e('div', { className: 'text-center py-12 bg-white rounded-lg border border-gray-200' },
                        e('svg', {
                            className: 'mx-auto h-12 w-12 text-gray-400',
                            fill: 'none',
                            stroke: 'currentColor',
                            viewBox: '0 0 24 24'
                        },
                            e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z' })
                        ),
                        e('h3', { className: 'mt-2 text-sm font-medium text-gray-900' }, 'No classes found'),
                        e('p', { className: 'mt-1 text-sm text-gray-500' },
                            searchTerm ? 'Try adjusting your search' : 'Get started by creating a new class'
                        ),
                        !searchTerm && e('div', { className: 'mt-6' },
                            e('button', {
                                onClick: handleOpenModal,
                                className: 'inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700'
                            },
                                e('svg', { className: '-ml-1 mr-2 h-5 w-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                                    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M12 4v16m8-8H4' })
                                ),
                                'New Class'
                            )
                        )
                    )
                ),

                // New Class Modal
                showNewClassModal && e('div', { className: 'fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 p-4', onClick: handleCloseModal },
                    e('div', { className: 'bg-white rounded-lg p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto', onClick: (ev) => ev.stopPropagation() },
                        // Header
                        e('div', { className: 'flex justify-between items-center mb-6' },
                            e('h3', { className: 'text-2xl font-bold text-gray-900' }, 'Create New Class'),
                            e('button', {
                                onClick: handleCloseModal,
                                className: 'text-gray-400 hover:text-gray-600'
                            },
                                e('svg', { className: 'w-6 h-6', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                                    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M6 18L18 6M6 6l12 12' })
                                )
                            )
                        ),

                        // Form
                        e('div', { className: 'space-y-4' },
                            // Class Level
                            e('div', null,
                                e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' },
                                    'Class Level ',
                                    e('span', { className: 'text-red-500' }, '*')
                                ),
                                e('select', {
                                    value: newClassData.ClassLevelID,
                                    onChange: (ev) => handleInputChange('ClassLevelID', ev.target.value),
                                    className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-sky-400'
                                },
                                    e('option', { value: '' }, 'Select a class level...'),
                                    classLevels.map(level =>
                                        e('option', { key: level.ClassLevelID, value: level.ClassLevelID },
                                            level.LevelName
                                        )
                                    )
                                )
                            ),

                            // Teacher
                            e('div', null,
                                e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' },
                                    'Teacher ',
                                    e('span', { className: 'text-red-500' }, '*')
                                ),
                                e('select', {
                                    value: newClassData.TeacherID,
                                    onChange: (ev) => handleInputChange('TeacherID', ev.target.value),
                                    className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-sky-400'
                                },
                                    e('option', { value: '' }, 'Select a teacher...'),
                                    teachers.map(teacher =>
                                        e('option', { key: teacher.TeacherID, value: teacher.TeacherID },
                                            teacher.FullName
                                        )
                                    )
                                )
                            ),

                            // Date Range
                            e('div', { className: 'grid grid-cols-2 gap-4' },
                                // Start Date
                                e('div', null,
                                    e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' },
                                        'Start Date ',
                                        e('span', { className: 'text-red-500' }, '*')
                                    ),
                                    e('input', {
                                        type: 'date',
                                        value: newClassData.StartDate,
                                        onChange: (ev) => handleInputChange('StartDate', ev.target.value),
                                        className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-sky-400'
                                    })
                                ),
                                // End Date
                                e('div', null,
                                    e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' },
                                        'End Date ',
                                        e('span', { className: 'text-red-500' }, '*')
                                    ),
                                    e('input', {
                                        type: 'date',
                                        value: newClassData.EndDate,
                                        onChange: (ev) => handleInputChange('EndDate', ev.target.value),
                                        className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-sky-400'
                                    })
                                )
                            ),

                            // Max Students and Location
                            e('div', { className: 'grid grid-cols-2 gap-4' },
                                // Max Students
                                e('div', null,
                                    e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' },
                                        'Max Students'
                                    ),
                                    e('input', {
                                        type: 'number',
                                        value: newClassData.MaxStudents,
                                        onChange: (ev) => handleInputChange('MaxStudents', ev.target.value),
                                        min: '1',
                                        max: '50',
                                        className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-sky-400'
                                    })
                                ),
                                // Location
                                e('div', null,
                                    e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' },
                                        'Location'
                                    ),
                                    e('input', {
                                        type: 'text',
                                        value: newClassData.VenueOrRoom,
                                        onChange: (ev) => handleInputChange('VenueOrRoom', ev.target.value),
                                        placeholder: 'e.g., Studio A',
                                        className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-sky-400'
                                    })
                                )
                            )
                        ),

                        // Actions
                        e('div', { className: 'flex gap-3 mt-6 pt-6 border-t' },
                            e('button', {
                                onClick: handleCloseModal,
                                disabled: isSaving,
                                className: 'flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors disabled:opacity-50'
                            }, 'Cancel'),
                            e('button', {
                                onClick: handleCreateClass,
                                disabled: isSaving,
                                className: 'btn-primary flex-1 text-white px-4 py-2 text-sm font-semibold rounded-xl flex items-center justify-center gap-2 disabled:opacity-50'
                            },
                                isSaving && e('svg', { className: 'animate-spin h-5 w-5', fill: 'none', viewBox: '0 0 24 24' },
                                    e('circle', { className: 'opacity-25', cx: 12, cy: 12, r: 10, stroke: 'currentColor', strokeWidth: 4 }),
                                    e('path', { className: 'opacity-75', fill: 'currentColor', d: 'M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z' })
                                ),
                                isSaving ? 'Creating...' : 'Create Class'
                            )
                        )
                    )
                )
            );
        }

        // ClassCard Component
        function ClassCard({ classOffering, onManage }) {
            const getStatusColor = (status) => {
                switch (status?.toLowerCase()) {
                    case 'upcoming':
                        return 'bg-yellow-100 text-yellow-800 border-yellow-200';
                    case 'in progress':
                    case 'open':
                        return 'bg-green-100 text-green-800 border-green-200';
                    case 'completed':
                        return 'bg-blue-100 text-blue-800 border-blue-200';
                    case 'cancelled':
                        return 'bg-red-100 text-red-800 border-red-200';
                    default:
                        return 'bg-gray-100 text-gray-800 border-gray-200';
                }
            };

            const formatDate = (dateString) => {
                if (!dateString) return 'TBD';
                try {
                    return new Date(dateString).toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric'
                    });
                } catch {
                    return dateString;
                }
            };

            const enrollmentPercentage = classOffering.MaxStudents 
                ? (classOffering.EnrolledCount / classOffering.MaxStudents) * 100 
                : 0;

            return e('div', {
                onClick: onManage,
                className: 'data-card bg-white rounded-xl shadow-card border border-gray-100 p-5 cursor-pointer group'
            },
                // Header
                e('div', { className: 'flex items-start justify-between mb-3' },
                    e('div', { className: 'flex-1' },
                        e('h3', { className: 'text-lg font-bold text-gray-900 group-hover:text-primary-600 transition-colors' },
                            classOffering.LevelName || `Level ${classOffering.ClassLevelID}`
                        ),
                        e('p', { className: 'text-sm text-gray-600 mt-1' },
                            e('span', { className: 'inline-flex items-center' },
                                e('svg', { className: 'w-4 h-4 mr-1', fill: 'currentColor', viewBox: '0 0 20 20' },
                                    e('path', { d: 'M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z' })
                                ),
                                classOffering.TeacherName || 'TBA'
                            )
                        )
                    ),
                    e('span', { className: `px-3 py-1 rounded-full text-xs font-medium border ${getStatusColor(classOffering.Status)}` },
                        classOffering.Status
                    )
                ),

                // Schedule
                e('div', { className: 'space-y-2 mb-4' },
                    e('div', { className: 'flex items-center text-sm text-gray-600' },
                        e('svg', { className: 'w-4 h-4 mr-2 text-gray-400', fill: 'currentColor', viewBox: '0 0 20 20' },
                            e('path', { fillRule: 'evenodd', d: 'M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z', clipRule: 'evenodd' })
                        ),
                        e('span', null,
                            `${formatDate(classOffering.StartDate)} - ${formatDate(classOffering.EndDate)}`
                        )
                    ),
                    classOffering.VenueOrRoom && e('div', { className: 'flex items-center text-sm text-gray-600' },
                        e('svg', { className: 'w-4 h-4 mr-2 text-gray-400', fill: 'currentColor', viewBox: '0 0 20 20' },
                            e('path', { fillRule: 'evenodd', d: 'M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z', clipRule: 'evenodd' })
                        ),
                        e('span', null, classOffering.VenueOrRoom)
                    )
                ),

                // Enrollment Progress
                e('div', { className: 'space-y-2' },
                    e('div', { className: 'flex items-center justify-between text-sm' },
                        e('span', { className: 'text-gray-600' }, 'Enrollment'),
                        e('span', { className: 'font-semibold text-gray-900' },
                            `${classOffering.EnrolledCount || 0} / ${classOffering.MaxStudents || 12} students`
                        )
                    ),
                    e('div', { className: 'w-full bg-gray-200 rounded-full h-2' },
                        e('div', {
                            className: `h-2 rounded-full transition-all ${
                                enrollmentPercentage >= 100
                                    ? 'bg-red-500'
                                    : enrollmentPercentage >= 75
                                    ? 'bg-yellow-500'
                                    : 'bg-green-500'
                            }`,
                            style: { width: `${Math.min(enrollmentPercentage, 100)}%` }
                        })
                    )
                ),

                // View Details Link
                e('div', { className: 'mt-4 pt-4 border-t border-gray-100' },
                    e('button', { className: 'text-sm text-primary-600 hover:text-primary-700 font-medium flex items-center group-hover:translate-x-1 transition-transform' },
                        'Manage Class',
                        e('svg', { className: 'w-4 h-4 ml-1', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                            e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M9 5l7 7-7 7' })
                        )
                    )
                )
            );
        }

        // Placeholder Components for other pages

        // Shows Component - Full Show Management
        function Shows() {
            const [shows, setShows] = useState([]);
            const [filteredShows, setFilteredShows] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [message, setMessage] = useState(null);
            const [showModal, setShowModal] = useState(false);
            const [modalMode, setModalMode] = useState('create'); // 'create' or 'edit'
            const [selectedShow, setSelectedShow] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            
            // Enhanced filtering state
            const [statusFilter, setStatusFilter] = useState('all'); // 'all', 'upcoming', 'active', 'completed'
            const [typeFilter, setTypeFilter] = useState('all');
            const [dateFilter, setDateFilter] = useState('all');
            const [sortConfig, setSortConfig] = useState({ key: 'ShowDate', direction: 'asc' });
            
            // Statistics state
            const [showStats, setShowStats] = useState({
                total: 0,
                upcoming: 0,
                active: 0,
                completed: 0
            });
            
            // Dropdown data
            const [showTypes, setShowTypes] = useState([]);
            const [rooms, setRooms] = useState([]);
            const [directors, setDirectors] = useState([]);
            const [castMembers, setCastMembers] = useState([]);
            const [bartenders, setBartenders] = useState([]);
            const [crewDutyTypes, setCrewDutyTypes] = useState([]);
            const [masterGames, setMasterGames] = useState([]);
            
            // Cast assignment UI state
            const [castSearchTerm, setCastSearchTerm] = useState('');
            const [showOnlySelected, setShowOnlySelected] = useState(false);
            
            // Games logging state
            const [loggedGames, setLoggedGames] = useState([]);
            const [gameSearchTerm, setGameSearchTerm] = useState('');
            const [showOnlySelectedGames, setShowOnlySelectedGames] = useState(false);
            const [gameFormData, setGameFormData] = useState({
                selectedGameId: '',
                customGameName: '',
                variationNotes: '',
                flagForMasterList: false
            });
            
            // Form state
            const [formData, setFormData] = useState({
                ShowTypeID: '',
                ShowDate: '',
                ShowTime: '',
                RoomID: '',
                DirectorID: '',
                ShowNotes: '',
                // Cast and crew assignments
                castAssignments: [], // Array of CastMemberIDs
                techCrew: '',
                boxOfficeCrew: '',
                houseManagerCrew: '',
                bartenderAssignment: ''
            });
            const [isSaving, setIsSaving] = useState(false);

            useEffect(() => {
                loadShows();
            }, []);

            useEffect(() => {
                // Use enhanced filtering when any filter changes
                const filtered = getEnhancedFilteredShows();
                setFilteredShows(filtered);
            }, [shows, searchTerm, statusFilter, typeFilter, dateFilter, sortConfig]);

            const loadShows = async () => {
                setIsLoading(true);
                try {
                    const response = await gasService.getAllShows();
                    console.log('getAllShows response:', response);
                    console.log('Response type:', typeof response);
                    console.log('Is array:', Array.isArray(response));

                    let showData = [];
                    
                    // Handle different response formats from Google Apps Script
                    if (Array.isArray(response)) {
                        // Direct array response (most common)
                        showData = response;
                        console.log('Using direct array response');
                    } else if (response && response.success && response.data) {
                        // Wrapped success response
                        showData = Array.isArray(response.data) 
                            ? response.data 
                            : (response.data.data || []);
                        console.log('Using wrapped success response');
                    }
                    
                    console.log('Final showData:', showData);
                    console.log('showData length:', showData.length);
                    
                    if (showData.length > 0) {
                        console.log('Sample show data:', showData[0]);
                        setShows(showData);
                        
                        // Calculate and set statistics
                        const stats = calculateShowStats(showData);
                        setShowStats(stats);
                        
                        setMessage({ type: 'success', text: `Loaded ${showData.length} shows successfully` });
                    } else {
                        setShows([]);
                        setMessage({ type: 'info', text: 'No shows found' });
                    }
                } catch (error) {
                    console.error('Error loading shows:', error);
                    setMessage({ type: 'error', text: 'Error loading shows' });
                } finally {
                    setIsLoading(false);
                }
            };

            const applyFilters = () => {
                let filtered = [...shows];

                if (searchTerm) {
                    filtered = filtered.filter(show =>
                        (show.ShowType && show.ShowType.toLowerCase().includes(searchTerm.toLowerCase())) ||
                        (show.DirectorName && show.DirectorName.toLowerCase().includes(searchTerm.toLowerCase())) ||
                        (show.RoomName && show.RoomName.toLowerCase().includes(searchTerm.toLowerCase()))
                    );
                }

                setFilteredShows(filtered);
            };

            // Enhanced utility functions for filtering and statistics
            const getShowStatus = (show) => {
                const showDate = new Date(show.ShowDate || show.date);
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const showDay = new Date(showDate.getFullYear(), showDate.getMonth(), showDate.getDate());
                
                if (showDay < today) {
                    return 'completed';
                } else if (showDay.getTime() === today.getTime()) {
                    return 'active';
                } else {
                    return 'upcoming';
                }
            };

            const calculateShowStats = (showData) => {
                const stats = {
                    total: showData.length,
                    upcoming: 0,
                    active: 0,
                    completed: 0
                };
                
                showData.forEach(show => {
                    const status = getShowStatus(show);
                    stats[status]++;
                });
                
                return stats;
            };

            const getEnhancedFilteredShows = () => {
                let filtered = [...shows];
                
                // Text search (keep existing simple search)
                if (searchTerm.trim()) {
                    filtered = filtered.filter(show =>
                        (show.ShowType && show.ShowType.toLowerCase().includes(searchTerm.toLowerCase())) ||
                        (show.DirectorName && show.DirectorName.toLowerCase().includes(searchTerm.toLowerCase())) ||
                        (show.RoomName && show.RoomName.toLowerCase().includes(searchTerm.toLowerCase()))
                    );
                }

                // Status filter
                if (statusFilter !== 'all') {
                    filtered = filtered.filter(show => getShowStatus(show) === statusFilter);
                }

                // Type filter
                if (typeFilter !== 'all') {
                    filtered = filtered.filter(show => {
                        const showType = show.ShowType || show.ShowTypeName;
                        return showType === typeFilter;
                    });
                }

                // Date range filter
                if (dateFilter !== 'all') {
                    const now = new Date();
                    filtered = filtered.filter(show => {
                        const showDate = new Date(show.ShowDate || show.date);
                        
                        switch (dateFilter) {
                            case 'past-week':
                                return showDate >= new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000) && showDate < now;
                            case 'past-month':
                                return showDate >= new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000) && showDate < now;
                            case 'next-week':
                                return showDate >= now && showDate <= new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
                            case 'next-month':
                                return showDate >= now && showDate <= new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000);
                            default:
                                return true;
                        }
                    });
                }

                // Sort the results
                if (sortConfig.key) {
                    filtered.sort((a, b) => {
                        let aVal = a[sortConfig.key] || '';
                        let bVal = b[sortConfig.key] || '';
                        
                        if (sortConfig.direction === 'asc') {
                            return aVal.toString().localeCompare(bVal.toString());
                        } else {
                            return bVal.toString().localeCompare(aVal.toString());
                        }
                    });
                }

                return filtered;
            };

            const handleSort = (key) => {
                let direction = 'asc';
                if (sortConfig.key === key && sortConfig.direction === 'asc') {
                    direction = 'desc';
                }
                setSortConfig({ key, direction });
            };

            const loadModalData = async () => {
                try {
                    const [typesResp, roomsResp, directorsResp, castResp, bartendersResp, crewTypesResp, gamesResp] = await Promise.all([
                        gasService.getAllShowTypes(),
                        gasService.getAllRooms(),
                        gasService.getAllDirectors(),
                        gasService.getAllCastMembers(),
                        gasService.getAllBartenders(),
                        gasService.getAllCrewDutyTypes(),
                        gasService.getAllGames()
                    ]);

                    if (typesResp.success || Array.isArray(typesResp)) {
                        setShowTypes(Array.isArray(typesResp) ? typesResp : (typesResp.data?.data || typesResp.data || []));
                    }
                    if (roomsResp.success || Array.isArray(roomsResp)) {
                        setRooms(Array.isArray(roomsResp) ? roomsResp : (roomsResp.data?.data || roomsResp.data || []));
                    }
                    if (directorsResp.success || Array.isArray(directorsResp)) {
                        setDirectors(Array.isArray(directorsResp) ? directorsResp : (directorsResp.data?.data || directorsResp.data || []));
                    }
                    if (castResp.success || Array.isArray(castResp)) {
                        setCastMembers(Array.isArray(castResp) ? castResp : (castResp.data?.data || castResp.data || []));
                    }
                    if (bartendersResp.success || Array.isArray(bartendersResp)) {
                        setBartenders(Array.isArray(bartendersResp) ? bartendersResp : (bartendersResp.data?.data || bartendersResp.data || []));
                    }
                    if (crewTypesResp.success || Array.isArray(crewTypesResp)) {
                        setCrewDutyTypes(Array.isArray(crewTypesResp) ? crewTypesResp : (crewTypesResp.data?.data || crewTypesResp.data || []));
                    }
                    if (gamesResp.success || Array.isArray(gamesResp)) {
                        setMasterGames(Array.isArray(gamesResp) ? gamesResp : (gamesResp.data?.data || gamesResp.data || []));
                    }
                } catch (error) {
                    console.error('Error loading modal data:', error);
                }
            };

            const handleOpenModal = (mode, show = null) => {
                setModalMode(mode);
                setSelectedShow(show);
                
                if (mode === 'edit' && show) {
                    // Convert ShowTime to proper time format for HTML time input
                    let timeValue = '';
                    if (show.ShowTime) {
                        console.log('Original ShowTime value:', show.ShowTime);
                        console.log('ShowTime type:', typeof show.ShowTime);
                        
                        try {
                            // Try parsing as formatted time first (e.g., "9:15 PM")
                            if (show.ShowTime.includes('PM') || show.ShowTime.includes('AM')) {
                                // Parse 12-hour format time like "9:15 PM"
                                const timeRegex = /^(\d{1,2}):(\d{2})\s*(AM|PM)$/i;
                                const match = show.ShowTime.match(timeRegex);
                                
                                if (match) {
                                    let hours = parseInt(match[1]);
                                    const minutes = match[2];
                                    const period = match[3].toUpperCase();
                                    
                                    // Convert to 24-hour format
                                    if (period === 'PM' && hours !== 12) {
                                        hours += 12;
                                    } else if (period === 'AM' && hours === 12) {
                                        hours = 0;
                                    }
                                    
                                    timeValue = `${hours.toString().padStart(2, '0')}:${minutes}`;
                                    console.log('Converted 12-hour to 24-hour:', timeValue);
                                } else {
                                    console.log('12-hour format regex did not match');
                                    timeValue = show.ShowTime;
                                }
                            } else {
                                // Try parsing as timestamp or other format
                                const timeDate = new Date(show.ShowTime);
                                console.log('Parsed Date object:', timeDate);
                                console.log('Is valid date:', !isNaN(timeDate.getTime()));
                                
                                if (!isNaN(timeDate.getTime())) {
                                    // Format as HH:MM for HTML time input
                                    timeValue = timeDate.toLocaleTimeString('en-GB', { 
                                        hour: '2-digit', 
                                        minute: '2-digit',
                                        hour12: false 
                                    });
                                    console.log('Formatted time value:', timeValue);
                                } else {
                                    // If it's already in HH:MM format, use as is
                                    timeValue = show.ShowTime;
                                    console.log('Using original value (not a valid date):', timeValue);
                                }
                            }
                        } catch (e) {
                            // Fallback to original value
                            console.log('Error parsing time:', e);
                            timeValue = show.ShowTime;
                        }
                    } else {
                        console.log('No ShowTime provided');
                    }
                    
                    console.log('Final timeValue for form:', timeValue);
                    
                    // Debug: Log all show data to see what crew fields are available
                    console.log('Complete show object:', show);
                    console.log('Show crew fields:');
                    console.log('- TechCrew:', show.TechCrew);
                    console.log('- BoxOfficeCrew:', show.BoxOfficeCrew);
                    console.log('- HouseManagerCrew:', show.HouseManagerCrew);
                    console.log('- BartenderAssignment:', show.BartenderAssignment);
                    console.log('- TechCrewID:', show.TechCrewID);
                    console.log('- BoxOfficeCrewID:', show.BoxOfficeCrewID);
                    console.log('- HouseManagerCrewID:', show.HouseManagerCrewID);
                    console.log('- BartenderID:', show.BartenderID);
                    
                    // Debug: Log cast members data
                    console.log('Show CastMembers:', show.CastMembers);
                    console.log('CastMembers length:', show.CastMembers ? show.CastMembers.length : 'undefined');
                    
                    // Extract cast member IDs from the CastMembers array
                    const existingCastAssignments = show.CastMembers && Array.isArray(show.CastMembers) 
                        ? show.CastMembers.map(castMember => castMember.PersonnelID || castMember.CastMemberID).filter(id => id)
                        : [];
                    console.log('Extracted cast assignments:', existingCastAssignments);
                    
                    setFormData({
                        ShowID: show.ShowID,
                        ShowTypeID: show.ShowTypeID || '',
                        ShowDate: show.ShowDate ? show.ShowDate.split('T')[0] : '',
                        ShowTime: timeValue,
                        RoomID: show.RoomID || '',
                        DirectorID: show.DirectorID || '',
                        ShowNotes: show.ShowNotes || '',
                        castAssignments: existingCastAssignments,
                        techCrew: show.TechCrewID || show.TechCrew || '',
                        boxOfficeCrew: show.BoxOfficeCrewID || show.BoxOfficeCrew || '',
                        houseManagerCrew: show.HouseManagerCrewID || show.HouseManagerCrew || '',
                        bartenderAssignment: show.BartenderID || show.BartenderAssignment || ''
                    });
                    
                    // Load games for this show
                    loadShowGames(show.ShowID);
                } else {
                    setFormData({
                        ShowTypeID: '',
                        ShowDate: '',
                        ShowTime: '',
                        RoomID: '',
                        DirectorID: '',
                        ShowNotes: '',
                        castAssignments: [],
                        techCrew: '',
                        boxOfficeCrew: '',
                        houseManagerCrew: '',
                        bartenderAssignment: ''
                    });
                    
                    // Clear games for new show
                    setLoggedGames([]);
                }
                
                setShowModal(true);
                loadModalData();
            };

            const handleCloseModal = () => {
                setShowModal(false);
                setSelectedShow(null);
                // Reset cast assignment UI state
                setCastSearchTerm('');
                setShowOnlySelected(false);
                // Reset games state
                setLoggedGames([]);
                setGameSearchTerm('');
                setShowOnlySelectedGames(false);
                setGameFormData({
                    selectedGameId: '',
                    customGameName: '',
                    variationNotes: '',
                    flagForMasterList: false
                });
                setFormData({
                    ShowTypeID: '',
                    ShowDate: '',
                    ShowTime: '',
                    RoomID: '',
                    DirectorID: '',
                    ShowNotes: '',
                    castAssignments: [],
                    techCrew: '',
                    boxOfficeCrew: '',
                    houseManagerCrew: '',
                    bartenderAssignment: ''
                });
            };

            const handleInputChange = (field, value) => {
                setFormData(prev => ({
                    ...prev,
                    [field]: value
                }));
            };

            const handleCastSelection = (castMemberId) => {
                setFormData(prev => {
                    const currentSelections = prev.castAssignments || [];
                    if (currentSelections.includes(castMemberId)) {
                        return {
                            ...prev,
                            castAssignments: currentSelections.filter(id => id !== castMemberId)
                        };
                    } else {
                        return {
                            ...prev,
                            castAssignments: [...currentSelections, castMemberId]
                        };
                    }
                });
            };

            // Enhanced cast member filtering and sorting
            const getFilteredAndSortedCastMembers = () => {
                let filtered = castMembers;
                
                // Apply search filter
                if (castSearchTerm.trim()) {
                    filtered = filtered.filter(cast => {
                        const fullName = cast.FullName || `${cast.FirstName} ${cast.LastName}`;
                        return fullName.toLowerCase().includes(castSearchTerm.toLowerCase());
                    });
                }
                
                // Apply selection filter
                if (showOnlySelected) {
                    filtered = filtered.filter(cast => 
                        formData.castAssignments.includes(cast.CastMemberID)
                    );
                }
                
                // Sort alphabetically by name
                return filtered.sort((a, b) => {
                    const nameA = a.FullName || `${a.FirstName} ${a.LastName}`;
                    const nameB = b.FullName || `${b.FirstName} ${b.LastName}`;
                    return nameA.localeCompare(nameB);
                });
            };

            const handleSelectAllCast = () => {
                const filteredMembers = getFilteredAndSortedCastMembers();
                const filteredIds = filteredMembers.map(cast => cast.CastMemberID);
                
                setFormData(prev => ({
                    ...prev,
                    castAssignments: [...new Set([...prev.castAssignments, ...filteredIds])]
                }));
            };

            const handleDeselectAllCast = () => {
                const filteredMembers = getFilteredAndSortedCastMembers();
                const filteredIds = filteredMembers.map(cast => cast.CastMemberID);
                
                setFormData(prev => ({
                    ...prev,
                    castAssignments: prev.castAssignments.filter(id => !filteredIds.includes(id))
                }));
            };

            // ===================================================================
            // GAMES LOGGING FUNCTIONS
            // ===================================================================

            const loadShowGames = async (showId) => {
                if (!showId) return;
                try {
                    console.log('Loading games for show:', showId);
                    const response = await gasService.getShowGames(showId);
                    console.log('getShowGames response:', response);
                    
                    if (response.success) {
                        // Handle different response structures
                        let gamesData = response.data || [];
                        
                        // If data has nested structure, extract the actual array
                        if (gamesData.data && Array.isArray(gamesData.data)) {
                            gamesData = gamesData.data;
                        } else if (!Array.isArray(gamesData)) {
                            console.log('Warning: gamesData is not an array:', gamesData);
                            gamesData = [];
                        }
                        
                        console.log('Setting logged games:', gamesData);
                        // Convert to the format needed for the UI
                        const formattedGames = gamesData.map(game => ({
                            ...game,
                            tempId: Date.now() + Math.random(), // Add temp ID for UI tracking
                            gameName: game.GameName || game.CustomGameName,
                            isCustom: !game.GameID
                        }));
                        setLoggedGames(Array.isArray(formattedGames) ? formattedGames : []);
                    } else {
                        console.log('getShowGames failed:', response.error);
                        setLoggedGames([]);
                    }
                } catch (error) {
                    console.error('Error loading show games:', error);
                    setLoggedGames([]);
                }
            };

            // Enhanced game filtering and sorting similar to cast members
            const getFilteredAndSortedGames = () => {
                let filtered = masterGames;
                
                // Apply search filter
                if (gameSearchTerm.trim()) {
                    filtered = filtered.filter(game => {
                        const gameName = game.Name || '';
                        const gameType = game.GameType || '';
                        const description = game['SHORT DESCRIPTION'] || '';
                        return gameName.toLowerCase().includes(gameSearchTerm.toLowerCase()) ||
                               gameType.toLowerCase().includes(gameSearchTerm.toLowerCase()) ||
                               description.toLowerCase().includes(gameSearchTerm.toLowerCase());
                    });
                }
                
                // Apply selection filter - show only games not already logged
                if (showOnlySelectedGames) {
                    const loggedGameIds = loggedGames.map(lg => lg.GameID).filter(id => id);
                    filtered = filtered.filter(game => 
                        !loggedGameIds.includes(game.GameID)
                    );
                }
                
                // Sort alphabetically by name
                return filtered.sort((a, b) => {
                    const nameA = a.Name || '';
                    const nameB = b.Name || '';
                    return nameA.localeCompare(nameB);
                });
            };

            const handleGameToggle = (gameId) => {
                const game = masterGames.find(g => g.GameID == gameId);
                if (!game) return;

                const existingGame = loggedGames.find(lg => lg.GameID == gameId);
                
                if (existingGame) {
                    // Remove game
                    setLoggedGames(prev => prev.filter(lg => lg.GameID != gameId));
                } else {
                    // Add game
                    const newGame = {
                        tempId: Date.now() + Math.random(),
                        GameID: game.GameID,
                        gameName: game.Name,
                        CustomGameName: null,
                        GameVariationNotes: null,
                        FlagForMasterList: false,
                        isCustom: false
                    };
                    setLoggedGames(prev => [...prev, newGame]);
                }
            };

            const handleGameFormChange = (field, value) => {
                setGameFormData(prev => ({
                    ...prev,
                    [field]: value
                }));
            };

            const addCustomGame = () => {
                const { customGameName, variationNotes, flagForMasterList } = gameFormData;
                
                // Validation
                if (!customGameName.trim()) {
                    setMessage({ type: 'error', text: 'Please enter a custom game name' });
                    return;
                }

                // Create custom game object
                const customGame = {
                    tempId: Date.now() + Math.random(),
                    GameID: null,
                    gameName: customGameName.trim(),
                    CustomGameName: customGameName.trim(),
                    GameVariationNotes: variationNotes.trim() || null,
                    FlagForMasterList: flagForMasterList,
                    isCustom: true
                };

                // Add to logged games
                setLoggedGames(prev => [...prev, customGame]);

                // Clear form
                setGameFormData({
                    selectedGameId: '',
                    customGameName: '',
                    variationNotes: '',
                    flagForMasterList: false
                });
            };

            const removeGameFromLog = (tempId) => {
                setLoggedGames(prev => prev.filter(game => game.tempId !== tempId));
            };

            const updateGameVariation = (tempId, variation) => {
                setLoggedGames(prev => prev.map(game => 
                    game.tempId === tempId 
                        ? { ...game, GameVariationNotes: variation }
                        : game
                ));
            };

            const handleSelectAllVisibleGames = () => {
                const filteredGames = getFilteredAndSortedGames();
                const loggedGameIds = loggedGames.map(lg => lg.GameID).filter(id => id);
                
                filteredGames.forEach(game => {
                    if (!loggedGameIds.includes(game.GameID)) {
                        const newGame = {
                            tempId: Date.now() + Math.random(),
                            GameID: game.GameID,
                            gameName: game.Name,
                            CustomGameName: null,
                            GameVariationNotes: null,
                            FlagForMasterList: false,
                            isCustom: false
                        };
                        setLoggedGames(prev => [...prev, newGame]);
                    }
                });
            };

            const handleDeselectAllVisibleGames = () => {
                const filteredGames = getFilteredAndSortedGames();
                const filteredGameIds = filteredGames.map(game => game.GameID);
                
                setLoggedGames(prev => prev.filter(game => 
                    !filteredGameIds.includes(game.GameID)
                ));
            };

            const handleSaveShow = async () => {
                // Validation
                if (!formData.ShowTypeID || !formData.ShowDate || !formData.ShowTime) {
                    setMessage({ type: 'error', text: 'Please fill in Show Type, Date, and Time' });
                    return;
                }

                setIsSaving(true);
                try {
                    const response = await gasService.createOrUpdateShow(formData);

                    if (response.success) {
                        const showId = selectedShow?.ShowID || response.showId;
                        
                        // Save games if there are any logged
                        if (Array.isArray(loggedGames) && loggedGames.length > 0 && showId) {
                            const gamesForSave = loggedGames.map(game => ({
                                gameId: game.GameID,
                                customName: game.CustomGameName,
                                variation: game.GameVariationNotes,
                                flag: game.FlagForMasterList
                            }));
                            
                            const gamesResponse = await gasService.updateShowGames(showId, gamesForSave);
                            if (!gamesResponse.success) {
                                console.error('Error saving games:', gamesResponse.error);
                                setMessage({ type: 'warning', text: 'Show saved but there was an issue saving games' });
                                return;
                            } else if (gamesResponse.flaggedGamesProcessed > 0) {
                                setMessage({ 
                                    type: 'success', 
                                    text: `Show saved successfully! ${gamesResponse.flaggedGamesProcessed} custom game(s) added to Master Game List.`
                                });
                                handleCloseModal();
                                loadShows();
                                return;
                            }
                        }
                        
                        setMessage({ 
                            type: 'success', 
                            text: modalMode === 'create' ? 'Show created successfully!' : 'Show updated successfully!' 
                        });
                        handleCloseModal();
                        loadShows();
                    } else {
                        setMessage({ type: 'error', text: response.error || 'Failed to save show' });
                    }
                } catch (error) {
                    console.error('Error saving show:', error);
                    setMessage({ type: 'error', text: 'Error saving show' });
                } finally {
                    setIsSaving(false);
                }
            };

            const handleDeleteShow = async (showId) => {
                if (!confirm('Are you sure you want to delete this show?')) {
                    return;
                }

                try {
                    const response = await gasService.deleteShow(showId);
                    if (response.success) {
                        setMessage({ type: 'success', text: 'Show deleted successfully' });
                        loadShows();
                    } else {
                        setMessage({ type: 'error', text: response.error || 'Failed to delete show' });
                    }
                } catch (error) {
                    console.error('Error deleting show:', error);
                    setMessage({ type: 'error', text: 'Error deleting show' });
                }
            };

            if (isLoading) {
                return e(Loader, { text: 'Loading shows...' });
            }

            return e('div', { className: 'p-6 max-w-screen-xl' },
                // Header
                e('div', { className: 'flex justify-between items-center mb-6' },
                    e('div', null,
                        e('h1', { className: 'text-2xl font-bold text-gray-900' }, 'Show Management'),
                        e('p', { className: 'text-sm text-gray-500 mt-0.5' }, `${filteredShows.length} shows`)
                    ),
                    e('button', {
                        onClick: () => handleOpenModal('create'),
                        className: 'btn-primary text-white px-4 py-2 text-sm font-semibold rounded-xl flex items-center gap-2'
                    },
                        e('svg', { className: 'w-4 h-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                            e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M12 4v16m8-8H4' })
                        ),
                        'Create New Show'
                    )
                ),

                message && e('div', { className: 'mb-4' },
                    e(Message, {
                        type: message.type,
                        message: message.text,
                        onClose: () => setMessage(null)
                    })
                ),

                // Search
                e('div', { className: 'mb-5' },
                    e('input', {
                        type: 'text',
                        placeholder: 'Search shows by type, director, or room…',
                        value: searchTerm,
                        onChange: (ev) => setSearchTerm(ev.target.value),
                        className: 'w-full max-w-sm px-4 py-2.5 text-sm border border-gray-200 rounded-xl bg-white shadow-sm focus:border-sky-400 transition-colors'
                    })
                ),

                // Enhanced Filtering Controls
                e('div', { className: 'mb-6 bg-white p-4 rounded-xl shadow-card border border-gray-100' },
                    e('div', { className: 'grid grid-cols-1 md:grid-cols-3 gap-4' },
                        // Status Filter
                        e('div', null,
                            e('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 'Status'),
                            e('select', {
                                value: statusFilter,
                                onChange: (ev) => setStatusFilter(ev.target.value),
                                className: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500'
                            },
                                e('option', { value: 'all' }, 'All Statuses'),
                                e('option', { value: 'upcoming' }, 'Upcoming'),
                                e('option', { value: 'active' }, 'Active/Today'),
                                e('option', { value: 'completed' }, 'Completed')
                            )
                        ),
                        // Type Filter
                        e('div', null,
                            e('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 'Type'),
                            e('select', {
                                value: typeFilter,
                                onChange: (ev) => setTypeFilter(ev.target.value),
                                className: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500'
                            },
                                e('option', { value: 'all' }, 'All Types'),
                                ...Array.from(new Set(shows.map(s => s.ShowType || s.ShowTypeName).filter(Boolean))).map(type =>
                                    e('option', { key: type, value: type }, type)
                                )
                            )
                        ),
                        // Date Range Filter
                        e('div', null,
                            e('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 'Date Range'),
                            e('select', {
                                value: dateFilter,
                                onChange: (ev) => setDateFilter(ev.target.value),
                                className: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500'
                            },
                                e('option', { value: 'all' }, 'All Time'),
                                e('option', { value: 'past-week' }, 'Past Week'),
                                e('option', { value: 'past-month' }, 'Past Month'),
                                e('option', { value: 'next-week' }, 'Next Week'),
                                e('option', { value: 'next-month' }, 'Next Month')
                            )
                        )
                    ),
                    // Stats Summary Row
                    showStats && e('div', { className: 'mt-4 pt-4 border-t border-gray-200' },
                        e('div', { className: 'grid grid-cols-2 md:grid-cols-4 gap-4 text-center' },
                            e('div', null,
                                e('div', { className: 'text-2xl font-bold text-blue-600' }, showStats.total),
                                e('div', { className: 'text-sm text-gray-600' }, 'Total Shows')
                            ),
                            e('div', null,
                                e('div', { className: 'text-2xl font-bold text-yellow-600' }, showStats.upcoming),
                                e('div', { className: 'text-sm text-gray-600' }, 'Upcoming')
                            ),
                            e('div', null,
                                e('div', { className: 'text-2xl font-bold text-blue-600' }, showStats.active),
                                e('div', { className: 'text-sm text-gray-600' }, 'Active/Today')
                            ),
                            e('div', null,
                                e('div', { className: 'text-2xl font-bold text-green-600' }, showStats.completed),
                                e('div', { className: 'text-sm text-gray-600' }, 'Completed')
                            )
                        )
                    )
                ),

                // Shows Table
                filteredShows.length === 0 ? (
                    e('div', { className: 'text-center py-12 bg-white rounded-lg shadow-sm' },
                        e('svg', { className: 'mx-auto h-12 w-12 text-gray-400', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                            e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z' })
                        ),
                        e('h3', { className: 'mt-2 text-sm font-medium text-gray-900' }, 'No shows found'),
                        e('p', { className: 'mt-1 text-sm text-gray-500' }, 'Get started by creating your first show'),
                        e('div', { className: 'mt-6' },
                            e('button', {
                                onClick: () => handleOpenModal('create'),
                                className: 'inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700'
                            },
                                e('svg', { className: '-ml-1 mr-2 h-5 w-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                                    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M12 4v16m8-8H4' })
                                ),
                                'Create New Show'
                            )
                        )
                    )
                ) : (
                    e('div', { className: 'bg-white rounded-xl shadow-card border border-gray-100 overflow-hidden' },
                        e('table', { className: 'min-w-full divide-y divide-gray-200' },
                            e('thead', { className: 'bg-gray-50' },
                                e('tr', null,
                                    e('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider' }, 'Status'),
                                    e('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider' }, 'Date'),
                                    e('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider' }, 'Time'),
                                    e('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider' }, 'Show Type'),
                                    e('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider' }, 'Director'),
                                    e('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider' }, 'Room'),
                                    e('th', { className: 'px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider' }, 'Actions')
                                )
                            ),
                            e('tbody', { className: 'bg-white divide-y divide-gray-200' },
                                filteredShows.map(show =>
                                    e('tr', { key: show.ShowID, className: 'hover:bg-gray-50' },
                                        e('td', { className: 'px-6 py-4 whitespace-nowrap' },
                                            e('span', { 
                                                className: `inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                                                    getShowStatus(show) === 'completed' ? 'bg-green-100 text-green-800' :
                                                    getShowStatus(show) === 'active' ? 'bg-blue-100 text-blue-800' :
                                                    getShowStatus(show) === 'upcoming' ? 'bg-yellow-100 text-yellow-800' :
                                                    'bg-gray-100 text-gray-800'
                                                }`
                                            }, getShowStatus(show))
                                        ),
                                        e('td', { className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-900' },
                                            show.ShowDate ? new Date(show.ShowDate).toLocaleDateString() : '-'
                                        ),
                                        e('td', { className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-900' },
                                            show.ShowTime || '-'
                                        ),
                                        e('td', { className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-900' },
                                            show.ShowType || show.ShowTypeName || `Type ${show.ShowTypeID || '-'}`
                                        ),
                                        e('td', { className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-500' },
                                            show.DirectorName || '-'
                                        ),
                                        e('td', { className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-500' },
                                            show.RoomName || show.Venue || '-'
                                        ),
                                        e('td', { className: 'px-6 py-4 whitespace-nowrap text-right text-sm font-medium' },
                                            e('div', { className: 'flex justify-end gap-2' },
                                                e('button', {
                                                    onClick: () => handleOpenModal('edit', show),
                                                    className: 'text-blue-600 hover:text-blue-900'
                                                }, 'Edit'),
                                                e('button', {
                                                    onClick: () => handleDeleteShow(show.ShowID),
                                                    className: 'text-red-600 hover:text-red-900'
                                                }, 'Delete')
                                            )
                                        )
                                    )
                                )
                            )
                        )
                    )
                ),

                // Create/Edit Show Modal
                showModal && e('div', { 
                    className: 'fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 p-4',
                    onClick: handleCloseModal
                },
                    e('div', { 
                        className: 'bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto',
                        onClick: (ev) => ev.stopPropagation()
                    },
                        // Modal Header
                        e('div', { className: 'px-6 py-4 border-b border-gray-200 flex items-center justify-between sticky top-0 bg-white z-10' },
                            e('h2', { className: 'text-2xl font-bold text-gray-900' }, 
                                modalMode === 'create' ? 'Create New Show' : 'Edit Show'
                            ),
                            e('button', {
                                onClick: handleCloseModal,
                                className: 'text-gray-400 hover:text-gray-600 text-2xl font-bold'
                            }, '×')
                        ),

                        // Modal Body
                        e('div', { className: 'px-6 py-6 space-y-6' },
                            // Section 1: Core Show Details
                            e('div', { className: 'bg-gray-50 p-4 rounded-lg' },
                                e('h3', { className: 'text-lg font-semibold text-gray-900 mb-4' }, 'Show Details'),
                                e('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4' },
                                    // Show Type
                                    e('div', null,
                                        e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Show Type *'),
                                        e('select', {
                                            value: formData.ShowTypeID,
                                            onChange: (ev) => handleInputChange('ShowTypeID', ev.target.value),
                                            className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500'
                                        },
                                            e('option', { value: '' }, '-- Select Show Type --'),
                                            showTypes.map(type =>
                                                e('option', { key: type.ShowTypeID, value: type.ShowTypeID }, type.ShowTypeName || type.Name)
                                            )
                                        )
                                    ),
                                    // Show Date
                                    e('div', null,
                                        e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Show Date *'),
                                        e('input', {
                                            type: 'date',
                                            value: formData.ShowDate,
                                            onChange: (ev) => handleInputChange('ShowDate', ev.target.value),
                                            className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500'
                                        })
                                    ),
                                    // Show Time
                                    e('div', null,
                                        e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Show Time *'),
                                        e('input', {
                                            type: 'time',
                                            value: formData.ShowTime,
                                            onChange: (ev) => handleInputChange('ShowTime', ev.target.value),
                                            className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500'
                                        })
                                    ),
                                    // Room
                                    e('div', null,
                                        e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Room'),
                                        e('select', {
                                            value: formData.RoomID,
                                            onChange: (ev) => handleInputChange('RoomID', ev.target.value),
                                            className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500'
                                        },
                                            e('option', { value: '' }, '-- Select Room --'),
                                            rooms.map(room =>
                                                e('option', { key: room.RoomID, value: room.RoomID }, room.RoomName)
                                            )
                                        )
                                    ),
                                    // Director
                                    e('div', null,
                                        e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Director'),
                                        e('select', {
                                            value: formData.DirectorID,
                                            onChange: (ev) => handleInputChange('DirectorID', ev.target.value),
                                            className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500'
                                        },
                                            e('option', { value: '' }, '-- Select Director --'),
                                            directors.map(director =>
                                                e('option', { 
                                                    key: director.PersonnelID, 
                                                    value: director.PersonnelID 
                                                }, director.DirectorName || `${director.FirstName} ${director.LastName}`)
                                            )
                                        )
                                    )
                                ),
                                // Show Notes
                                e('div', { className: 'mt-4' },
                                    e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Show Notes'),
                                    e('textarea', {
                                        value: formData.ShowNotes,
                                        onChange: (ev) => handleInputChange('ShowNotes', ev.target.value),
                                        rows: 3,
                                        className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500'
                                    })
                                )
                            ),

                            // Section 2: Cast & Crew Assignments
                            e('div', { className: 'bg-gray-50 p-4 rounded-lg' },
                                e('h3', { className: 'text-lg font-semibold text-gray-900 mb-4' }, 'Cast & Crew Assignments'),
                                
                                // Cast Members (Enhanced Multi-select)
                                e('div', { className: 'mb-4' },
                                    e('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 
                                        `Assign Cast (${formData.castAssignments.length} selected)`
                                    ),
                                    
                                    // Search and filter controls
                                    e('div', { className: 'mb-3 space-y-2' },
                                        // Search input
                                        e('div', { className: 'relative' },
                                            e('input', {
                                                type: 'text',
                                                placeholder: 'Search cast members...',
                                                value: castSearchTerm,
                                                onChange: (ev) => setCastSearchTerm(ev.target.value),
                                                className: 'w-full px-3 py-2 pl-8 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm'
                                            }),
                                            e('svg', {
                                                className: 'absolute left-2 top-2.5 h-4 w-4 text-gray-400',
                                                fill: 'none',
                                                stroke: 'currentColor',
                                                viewBox: '0 0 24 24'
                                            },
                                                e('path', {
                                                    strokeLinecap: 'round',
                                                    strokeLinejoin: 'round',
                                                    strokeWidth: 2,
                                                    d: 'M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z'
                                                })
                                            )
                                        ),
                                        
                                        // Control buttons
                                        e('div', { className: 'flex flex-wrap gap-2' },
                                            e('button', {
                                                type: 'button',
                                                onClick: () => setShowOnlySelected(!showOnlySelected),
                                                className: `px-3 py-1 text-xs rounded-lg border ${
                                                    showOnlySelected 
                                                        ? 'bg-blue-50 border-blue-300 text-blue-700' 
                                                        : 'bg-white border-gray-300 text-gray-700'
                                                } hover:bg-blue-50`
                                            }, showOnlySelected ? '✓ Show Selected Only' : 'Show Selected Only'),
                                            
                                            e('button', {
                                                type: 'button',
                                                onClick: handleSelectAllCast,
                                                className: 'px-3 py-1 text-xs rounded-lg border border-green-300 bg-green-50 text-green-700 hover:bg-green-100'
                                            }, 'Select All Visible'),
                                            
                                            e('button', {
                                                type: 'button',
                                                onClick: handleDeselectAllCast,
                                                className: 'px-3 py-1 text-xs rounded-lg border border-red-300 bg-red-50 text-red-700 hover:bg-red-100'
                                            }, 'Deselect All Visible'),
                                            
                                            castSearchTerm && e('button', {
                                                type: 'button',
                                                onClick: () => setCastSearchTerm(''),
                                                className: 'px-3 py-1 text-xs rounded-lg border border-gray-300 bg-gray-50 text-gray-700 hover:bg-gray-100'
                                            }, 'Clear Search')
                                        )
                                    ),
                                    
                                    // Cast member list
                                    e('div', { 
                                        className: 'border border-gray-300 rounded-lg bg-white',
                                        style: { maxHeight: '300px', overflowY: 'auto' }
                                    },
                                        (() => {
                                            const filteredCastMembers = getFilteredAndSortedCastMembers();
                                            
                                            if (castMembers.length === 0) {
                                                return e('p', { className: 'text-sm text-gray-500 italic p-4' }, 'No cast members available');
                                            }
                                            
                                            if (filteredCastMembers.length === 0) {
                                                return e('div', { className: 'p-4 text-center' },
                                                    e('p', { className: 'text-sm text-gray-500 italic mb-2' }, 
                                                        castSearchTerm ? 'No cast members match your search' : 'No selected cast members'
                                                    ),
                                                    castSearchTerm && e('button', {
                                                        type: 'button',
                                                        onClick: () => setCastSearchTerm(''),
                                                        className: 'text-xs text-blue-600 hover:text-blue-800 underline'
                                                    }, 'Clear search to see all members')
                                                );
                                            }
                                            
                                            return filteredCastMembers.map((cast, index) => {
                                                const isSelected = formData.castAssignments.includes(cast.CastMemberID);
                                                return e('label', { 
                                                    key: cast.CastMemberID,
                                                    className: `flex items-center py-2 px-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-b-0 ${
                                                        isSelected ? 'bg-blue-50' : ''
                                                    }`
                                                },
                                                    e('input', {
                                                        type: 'checkbox',
                                                        checked: isSelected,
                                                        onChange: () => handleCastSelection(cast.CastMemberID),
                                                        className: 'mr-3 h-4 w-4 text-blue-600 rounded focus:ring-blue-500'
                                                    }),
                                                    e('div', { className: 'flex-1 min-w-0' },
                                                        e('span', { className: 'text-sm text-gray-900 font-medium block truncate' }, 
                                                            cast.FullName || `${cast.FirstName} ${cast.LastName}`
                                                        ),
                                                        cast.Status && e('span', { 
                                                            className: `text-xs px-2 py-0.5 rounded-full ml-2 ${
                                                                cast.Status === 'Active' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'
                                                            }`
                                                        }, cast.Status)
                                                    )
                                                );
                                            });
                                        })()
                                    ),
                                    
                                    // Summary info
                                    (() => {
                                        const filteredCount = getFilteredAndSortedCastMembers().length;
                                        const totalCount = castMembers.length;
                                        const selectedCount = formData.castAssignments.length;
                                        
                                        return e('div', { className: 'mt-2 text-xs text-gray-600' },
                                            `Showing ${filteredCount} of ${totalCount} cast members`,
                                            selectedCount > 0 && ` • ${selectedCount} selected`
                                        );
                                    })()
                                ),

                                // Crew Duties
                                e('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4' },
                                    // Tech
                                    e('div', null,
                                        e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Tech'),
                                        e('select', {
                                            value: formData.techCrew,
                                            onChange: (ev) => handleInputChange('techCrew', ev.target.value),
                                            className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500'
                                        },
                                            e('option', { value: '' }, '-- Select Tech --'),
                                            castMembers.map(cast =>
                                                e('option', { key: cast.CastMemberID, value: cast.CastMemberID }, 
                                                    cast.FullName || `${cast.FirstName} ${cast.LastName}`
                                                )
                                            )
                                        )
                                    ),
                                    // Box Office
                                    e('div', null,
                                        e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Box Office'),
                                        e('select', {
                                            value: formData.boxOfficeCrew,
                                            onChange: (ev) => handleInputChange('boxOfficeCrew', ev.target.value),
                                            className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500'
                                        },
                                            e('option', { value: '' }, '-- Select Box Office --'),
                                            castMembers.map(cast =>
                                                e('option', { key: cast.CastMemberID, value: cast.CastMemberID }, 
                                                    cast.FullName || `${cast.FirstName} ${cast.LastName}`
                                                )
                                            )
                                        )
                                    ),
                                    // House Manager
                                    e('div', null,
                                        e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'House Manager'),
                                        e('select', {
                                            value: formData.houseManagerCrew,
                                            onChange: (ev) => handleInputChange('houseManagerCrew', ev.target.value),
                                            className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500'
                                        },
                                            e('option', { value: '' }, '-- Select House Manager --'),
                                            castMembers.map(cast =>
                                                e('option', { key: cast.CastMemberID, value: cast.CastMemberID }, 
                                                    cast.FullName || `${cast.FirstName} ${cast.LastName}`
                                                )
                                            )
                                        )
                                    ),
                                    // Bartender
                                    e('div', null,
                                        e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Bartender'),
                                        e('select', {
                                            value: formData.bartenderAssignment,
                                            onChange: (ev) => handleInputChange('bartenderAssignment', ev.target.value),
                                            className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500'
                                        },
                                            e('option', { value: '' }, '-- Select Bartender --'),
                                            bartenders.map(bartender =>
                                                e('option', { key: bartender.BartenderID, value: bartender.PersonnelID }, 
                                                    bartender.FullName || `${bartender.FirstName} ${bartender.LastName}`
                                                )
                                            )
                                        )
                                    )
                                )
                            ),

                            // Section 3: Log Games Played (only for past shows)
                            (() => {
                                // Check if show date is in the past
                                const showDate = formData.ShowDate;
                                const isPastShow = showDate && new Date(showDate) < new Date();
                                
                                if (!isPastShow) return null;
                                
                                return e('div', { 
                                    className: 'bg-green-50 p-4 rounded-lg border border-green-200'
                                },
                                    e('h3', { className: 'text-lg font-semibold text-gray-900 mb-4' }, 
                                        '🎮 Log Games Played'
                                    ),
                                    
                                    // Games Multi-select (similar to cast section)
                                    e('div', { className: 'mb-4' },
                                        e('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 
                                            `Select Games (${Array.isArray(loggedGames) ? loggedGames.length : 0} selected)`
                                        ),
                                        
                                        // Search and filter controls
                                        e('div', { className: 'mb-3 space-y-2' },
                                            // Search input
                                            e('div', { className: 'relative' },
                                                e('input', {
                                                    type: 'text',
                                                    placeholder: 'Search games by name, type, or description...',
                                                    value: gameSearchTerm,
                                                    onChange: (ev) => setGameSearchTerm(ev.target.value),
                                                    className: 'w-full px-3 py-2 pl-8 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 text-sm'
                                                }),
                                                e('svg', {
                                                    className: 'absolute left-2 top-2.5 h-4 w-4 text-gray-400',
                                                    fill: 'none',
                                                    stroke: 'currentColor',
                                                    viewBox: '0 0 24 24'
                                                },
                                                    e('path', {
                                                        strokeLinecap: 'round',
                                                        strokeLinejoin: 'round',
                                                        strokeWidth: 2,
                                                        d: 'M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z'
                                                    })
                                                )
                                            ),
                                            
                                            // Control buttons
                                            e('div', { className: 'flex flex-wrap gap-2' },
                                                e('button', {
                                                    type: 'button',
                                                    onClick: () => setShowOnlySelectedGames(!showOnlySelectedGames),
                                                    className: `px-3 py-1 text-xs rounded-lg border ${
                                                        showOnlySelectedGames 
                                                            ? 'bg-green-50 border-green-300 text-green-700' 
                                                            : 'bg-white border-gray-300 text-gray-700'
                                                    } hover:bg-green-50`
                                                }, showOnlySelectedGames ? '✓ Show Available Only' : 'Show Available Only'),
                                                
                                                e('button', {
                                                    type: 'button',
                                                    onClick: handleSelectAllVisibleGames,
                                                    className: 'px-3 py-1 text-xs rounded-lg border border-green-300 bg-green-50 text-green-700 hover:bg-green-100'
                                                }, 'Select All Visible'),
                                                
                                                e('button', {
                                                    type: 'button',
                                                    onClick: handleDeselectAllVisibleGames,
                                                    className: 'px-3 py-1 text-xs rounded-lg border border-red-300 bg-red-50 text-red-700 hover:bg-red-100'
                                                }, 'Deselect All Visible'),
                                                
                                                gameSearchTerm && e('button', {
                                                    type: 'button',
                                                    onClick: () => setGameSearchTerm(''),
                                                    className: 'px-3 py-1 text-xs rounded-lg border border-gray-300 bg-gray-50 text-gray-700 hover:bg-gray-100'
                                                }, 'Clear Search')
                                            )
                                        ),
                                        
                                        // Games list
                                        e('div', { 
                                            className: 'border border-gray-300 rounded-lg bg-white',
                                            style: { maxHeight: '200px', overflowY: 'auto' }
                                        },
                                            (() => {
                                                const filteredGames = getFilteredAndSortedGames();
                                                const loggedGameIds = loggedGames.map(lg => lg.GameID).filter(id => id);
                                                
                                                if (masterGames.length === 0) {
                                                    return e('p', { className: 'text-sm text-gray-500 italic p-4' }, 'No games available');
                                                }
                                                
                                                if (filteredGames.length === 0) {
                                                    return e('div', { className: 'p-4 text-center' },
                                                        e('p', { className: 'text-sm text-gray-500 italic mb-2' }, 
                                                            gameSearchTerm ? 'No games match your search' : 'No available games'
                                                        ),
                                                        gameSearchTerm && e('button', {
                                                            type: 'button',
                                                            onClick: () => setGameSearchTerm(''),
                                                            className: 'text-xs text-green-600 hover:text-green-800 underline'
                                                        }, 'Clear search to see all games')
                                                    );
                                                }
                                                
                                                return filteredGames.map((game) => {
                                                    const isSelected = loggedGameIds.includes(game.GameID);
                                                    return e('label', { 
                                                        key: game.GameID,
                                                        className: `flex items-center py-2 px-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-b-0 ${
                                                            isSelected ? 'bg-green-50' : ''
                                                        }`
                                                    },
                                                        e('input', {
                                                            type: 'checkbox',
                                                            checked: isSelected,
                                                            onChange: () => handleGameToggle(game.GameID),
                                                            className: 'mr-3 h-4 w-4 text-green-600 rounded focus:ring-green-500'
                                                        }),
                                                        e('div', { className: 'flex-1 min-w-0' },
                                                            e('div', { className: 'flex items-center gap-2' },
                                                                e('span', { className: 'text-sm text-gray-900 font-medium' }, 
                                                                    game.Name || 'Unnamed Game'
                                                                ),
                                                                game.GameType && e('span', { 
                                                                    className: 'text-xs px-2 py-0.5 rounded-full bg-blue-100 text-blue-700'
                                                                }, game.GameType),
                                                                game.PlayerCount && e('span', { 
                                                                    className: 'text-xs px-2 py-0.5 rounded-full bg-gray-100 text-gray-600'
                                                                }, `${game.PlayerCount} players`)
                                                            ),
                                                            game['SHORT DESCRIPTION'] && e('div', { 
                                                                className: 'text-xs text-gray-600 mt-1 truncate'
                                                            }, game['SHORT DESCRIPTION'])
                                                        )
                                                    );
                                                });
                                            })()
                                        ),
                                        
                                        // Summary info
                                        (() => {
                                            const filteredCount = getFilteredAndSortedGames().length;
                                            const totalCount = masterGames.length;
                                            const selectedCount = Array.isArray(loggedGames) ? loggedGames.length : 0;
                                            
                                            return e('div', { className: 'mt-2 text-xs text-gray-600' },
                                                `Showing ${filteredCount} of ${totalCount} games`,
                                                selectedCount > 0 && ` • ${selectedCount} selected`
                                            );
                                        })()
                                    ),
                                    
                                    // Add Custom Game Section
                                    e('div', { className: 'mb-4 p-3 bg-white rounded-lg border border-gray-200' },
                                        e('h4', { className: 'text-md font-medium text-gray-800 mb-3' }, '➕ Add Custom Game'),
                                        
                                        e('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-3' },
                                            // Custom Game Name
                                            e('div', null,
                                                e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Custom Game Name'),
                                                e('input', {
                                                    type: 'text',
                                                    value: gameFormData.customGameName,
                                                    onChange: (ev) => handleGameFormChange('customGameName', ev.target.value),
                                                    className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 text-sm',
                                                    placeholder: 'Enter custom game name'
                                                })
                                            ),
                                            
                                            // Variation/Notes
                                            e('div', null,
                                                e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Notes (Optional)'),
                                                e('input', {
                                                    type: 'text',
                                                    value: gameFormData.variationNotes,
                                                    onChange: (ev) => handleGameFormChange('variationNotes', ev.target.value),
                                                    className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 text-sm',
                                                    placeholder: 'e.g., "Speed round", "With props"'
                                                })
                                            )
                                        ),
                                        
                                        e('div', { className: 'mt-3 flex items-center gap-3' },
                                            e('label', { className: 'flex items-center text-sm text-gray-700' },
                                                e('input', {
                                                    type: 'checkbox',
                                                    checked: gameFormData.flagForMasterList,
                                                    onChange: (ev) => handleGameFormChange('flagForMasterList', ev.target.checked),
                                                    className: 'mr-2 h-4 w-4 text-green-600 rounded focus:ring-green-500'
                                                }),
                                                '🏃 Flag to add to Master Game List'
                                            ),
                                            e('button', {
                                                type: 'button',
                                                onClick: addCustomGame,
                                                disabled: !gameFormData.customGameName.trim(),
                                                className: 'px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-sm font-medium'
                                            }, 'Add Custom Game')
                                        )
                                    ),
                                    
                                    // Selected Games List with Variations
                                    e('div', null,
                                        e('h4', { className: 'text-md font-medium text-gray-800 mb-3' }, 
                                            `Games Selected (${Array.isArray(loggedGames) ? loggedGames.length : 0})`
                                        ),
                                        !Array.isArray(loggedGames) || loggedGames.length === 0 ? 
                                            e('p', { className: 'text-sm text-gray-500 italic p-3 bg-white rounded border' }, 
                                                'No games selected yet. Select games from the list above or add custom games.'
                                            ) :
                                            e('div', { className: 'space-y-2' },
                                                loggedGames.map((game, index) =>
                                                    e('div', { 
                                                        key: game.tempId || index,
                                                        className: 'flex items-center gap-3 p-3 bg-white rounded border border-gray-200'
                                                    },
                                                        e('div', { className: 'flex-1' },
                                                            e('div', { className: 'flex items-center gap-2' },
                                                                e('span', { className: 'font-medium text-gray-900' }, 
                                                                    game.gameName
                                                                ),
                                                                game.isCustom && e('span', { 
                                                                    className: 'text-xs px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full'
                                                                }, 'Custom'),
                                                                game.FlagForMasterList && e('span', { 
                                                                    className: 'text-xs px-2 py-1 bg-green-100 text-green-800 rounded-full'
                                                                }, '🏃 Flagged')
                                                            ),
                                                            // Inline variation editor
                                                            e('input', {
                                                                type: 'text',
                                                                value: game.GameVariationNotes || '',
                                                                onChange: (ev) => updateGameVariation(game.tempId, ev.target.value),
                                                                placeholder: 'Add variation notes...',
                                                                className: 'mt-2 w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-green-500'
                                                            })
                                                        ),
                                                        e('button', {
                                                            type: 'button',
                                                            onClick: () => removeGameFromLog(game.tempId),
                                                            className: 'px-3 py-1 text-sm text-red-600 border border-red-300 rounded hover:bg-red-50'
                                                        }, 'Remove')
                                                    )
                                                )
                                            )
                                    )
                                );
                            })()
                        ),

                        // Modal Footer
                        e('div', { className: 'px-6 py-4 border-t border-gray-200 flex justify-end gap-3 sticky bottom-0 bg-white' },
                            e('button', {
                                onClick: handleCloseModal,
                                disabled: isSaving,
                                className: 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors disabled:opacity-50'
                            }, 'Cancel'),
                            e('button', {
                                onClick: handleSaveShow,
                                disabled: isSaving,
                                className: 'px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 flex items-center gap-2'
                            },
                                isSaving && e('svg', { className: 'animate-spin h-4 w-4', fill: 'none', viewBox: '0 0 24 24' },
                                    e('circle', { className: 'opacity-25', cx: '12', cy: '12', r: '10', stroke: 'currentColor', strokeWidth: '4' }),
                                    e('path', { className: 'opacity-75', fill: 'currentColor', d: 'M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z' })
                                ),
                                isSaving ? 'Saving...' : 'Save Show'
                            )
                        )
                    )
                )
            );
        }

        function Inventory() {
            const [inventory, setInventory] = useState([]);
            const [filteredInventory, setFilteredInventory] = useState([]);
            const [categories, setCategories] = useState([]);
            const [locations, setLocations] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [message, setMessage] = useState(null);
            const [showModal, setShowModal] = useState(false);
            const [modalMode, setModalMode] = useState('create'); // 'create', 'edit', or 'transaction'
            const [selectedItem, setSelectedItem] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            
            // Enhanced filtering state
            const [categoryFilter, setCategoryFilter] = useState('all');
            const [locationFilter, setLocationFilter] = useState('all');
            const [stockFilter, setStockFilter] = useState('all'); // 'all', 'low', 'out', 'available'
            const [sortConfig, setSortConfig] = useState({ key: 'ItemName', direction: 'asc' });
            
            // Statistics state
            const [inventoryStats, setInventoryStats] = useState({
                total: 0,
                categories: 0,
                locations: 0,
                lowStock: 0,
                outOfStock: 0
            });
            
            // Form state - Updated for new schema
            const [formData, setFormData] = useState({
                ItemName: '',
                CategoryID: '',
                LocationID: '',
                SKU: '',
                ReorderPoint: '',
                Description: '',
                InitialQuantity: '', // For new items
                // Transaction fields
                QuantityChange: '',
                TransactionType: 'Stock In',
                TransactionDate: (() => {
                    const now = new Date();
                    const year = now.getFullYear();
                    const month = String(now.getMonth() + 1).padStart(2, '0');
                    const day = String(now.getDate()).padStart(2, '0');
                    const hours = String(now.getHours()).padStart(2, '0');
                    const minutes = String(now.getMinutes()).padStart(2, '0');
                    return `${year}-${month}-${day}T${hours}:${minutes}`;
                })(),
                Notes: ''
            });
            const [isSaving, setIsSaving] = useState(false);

            useEffect(() => {
                loadInventory();
                loadCategories();
                loadLocations();
            }, []);

            useEffect(() => {
                // Apply filtering when any filter changes
                const filtered = getFilteredInventory();
                setFilteredInventory(filtered);
            }, [inventory, searchTerm, categoryFilter, locationFilter, stockFilter, sortConfig]);

            const loadInventory = async () => {
                setIsLoading(true);
                try {
                    const response = await gasService.getAllInventory();
                    console.log('getAllInventory response:', response);

                    let itemData = [];
                    
                    if (Array.isArray(response)) {
                        itemData = response;
                    } else if (response && response.success && response.data) {
                        itemData = Array.isArray(response.data) 
                            ? response.data 
                            : (response.data.data || []);
                    }
                    
                    if (itemData.length > 0) {
                        console.log('Sample inventory item:', itemData[0]);
                        setInventory(itemData);
                        
                        // Calculate statistics using new schema
                        const stats = calculateInventoryStats(itemData);
                        setInventoryStats(stats);
                        
                        setMessage({ type: 'success', text: `Loaded ${itemData.length} inventory records successfully` });
                    } else {
                        setInventory([]);
                        setMessage({ type: 'info', text: 'No inventory items found' });
                    }
                } catch (error) {
                    console.error('Error loading inventory:', error);
                    setMessage({ type: 'error', text: 'Error loading inventory' });
                } finally {
                    setIsLoading(false);
                }
            };

            const loadCategories = async () => {
                try {
                    const response = await gasService.getAllInventoryCategories();
                    console.log('getAllInventoryCategories response:', response);
                    
                    // Handle the nested response structure we're seeing
                    let categoryData = [];
                    
                    // Check for deeply nested data structure
                    if (response && response.data && response.data.data && Array.isArray(response.data.data)) {
                        categoryData = response.data.data;
                        console.log('Using deeply nested response.data.data');
                    }
                    // Standard success response
                    else if (response && response.success === true && Array.isArray(response.data)) {
                        categoryData = response.data;
                        console.log('Using standard response.data');
                    }
                    // Direct array
                    else if (Array.isArray(response)) {
                        categoryData = response;
                        console.log('Using direct array response');
                    }
                    
                    console.log('Final categoryData:', categoryData);
                    console.log('Final categoryData length:', categoryData.length);
                    if (categoryData.length > 0) {
                        console.log('Sample category:', categoryData[0]);
                    }
                    setCategories(categoryData);
                } catch (error) {
                    console.error('Error loading categories:', error);
                    setCategories([]);
                }
            };

            const loadLocations = async () => {
                try {
                    const response = await gasService.getAllStorageLocations();
                    console.log('getAllStorageLocations response:', response);
                    
                    // Handle the nested response structure we're seeing
                    let locationData = [];
                    
                    // Check for deeply nested data structure
                    if (response && response.data && response.data.data && Array.isArray(response.data.data)) {
                        locationData = response.data.data;
                        console.log('Using deeply nested locations response.data.data');
                    }
                    // Standard success response
                    else if (response && response.success === true && Array.isArray(response.data)) {
                        locationData = response.data;
                        console.log('Using standard locations response.data');
                    }
                    // Direct array
                    else if (Array.isArray(response)) {
                        locationData = response;
                        console.log('Using direct array locations response');
                    }
                    
                    console.log('Final locationData:', locationData);
                    console.log('Final locationData length:', locationData.length);
                    if (locationData.length > 0) {
                        console.log('Sample location:', locationData[0]);
                    }
                    setLocations(locationData);
                } catch (error) {
                    console.error('Error loading locations:', error);
                    setLocations([]);
                }
            };

            // Utility functions - Updated for new schema
            const calculateInventoryStats = (itemData) => {
                const stats = {
                    total: itemData.length,
                    categories: new Set(itemData.map(item => item.CategoryName).filter(Boolean)).size,
                    locations: new Set(itemData.map(item => item.LocationName).filter(Boolean)).size,
                    lowStock: 0,
                    outOfStock: 0
                };
                
                itemData.forEach(item => {
                    const quantity = parseInt(item.CurrentQuantity) || 0;
                    const reorderPoint = parseInt(item.ReorderPoint) || 0;
                    
                    if (quantity === 0) {
                        stats.outOfStock++;
                    } else if (quantity <= reorderPoint) {
                        stats.lowStock++;
                    }
                });
                
                return stats;
            };

            const getStockStatus = (item) => {
                const quantity = parseInt(item.CurrentQuantity) || 0;
                const reorderPoint = parseInt(item.ReorderPoint) || 0;
                
                if (quantity === 0) return 'out';
                if (quantity <= reorderPoint) return 'low';
                return 'available';
            };

            const getFilteredInventory = () => {
                let filtered = [...inventory];
                
                // Text search
                if (searchTerm.trim()) {
                    filtered = filtered.filter(item =>
                        (item.ItemName && item.ItemName.toLowerCase().includes(searchTerm.toLowerCase())) ||
                        (item.CategoryName && item.CategoryName.toLowerCase().includes(searchTerm.toLowerCase())) ||
                        (item.LocationName && item.LocationName.toLowerCase().includes(searchTerm.toLowerCase())) ||
                        (item.Description && item.Description.toLowerCase().includes(searchTerm.toLowerCase())) ||
                        (item.SKU && item.SKU.toLowerCase().includes(searchTerm.toLowerCase()))
                    );
                }

                // Category filter
                if (categoryFilter !== 'all') {
                    filtered = filtered.filter(item => item.CategoryName === categoryFilter);
                }

                // Location filter
                if (locationFilter !== 'all') {
                    filtered = filtered.filter(item => item.LocationName === locationFilter);
                }

                // Stock status filter
                if (stockFilter !== 'all') {
                    filtered = filtered.filter(item => getStockStatus(item) === stockFilter);
                }

                // Sort the results
                if (sortConfig.key) {
                    filtered.sort((a, b) => {
                        let aVal = a[sortConfig.key] || '';
                        let bVal = b[sortConfig.key] || '';
                        
                        // Handle numeric sorting for CurrentQuantity and ReorderPoint
                        if (sortConfig.key === 'CurrentQuantity' || sortConfig.key === 'ReorderPoint') {
                            aVal = parseInt(aVal) || 0;
                            bVal = parseInt(bVal) || 0;
                        }
                        
                        if (sortConfig.direction === 'asc') {
                            return aVal.toString().localeCompare(bVal.toString(), undefined, { numeric: true });
                        } else {
                            return bVal.toString().localeCompare(aVal.toString(), undefined, { numeric: true });
                        }
                    });
                }

                return filtered;
            };

            const handleSort = (key) => {
                let direction = 'asc';
                if (sortConfig.key === key && sortConfig.direction === 'asc') {
                    direction = 'desc';
                }
                setSortConfig({ key, direction });
            };

            const handleOpenModal = (mode, item = null) => {
                setModalMode(mode);
                setSelectedItem(item);
                
                if (mode === 'edit' && item) {
                    setFormData({
                        ItemName: item.ItemName || '',
                        CategoryID: item.CategoryID || '',
                        LocationID: item.LocationID || '',
                        SKU: item.SKU || '',
                        ReorderPoint: item.ReorderPoint || '',
                        Description: item.Description || '',
                        InitialQuantity: '',
                        QuantityChange: '',
                        TransactionType: 'Stock In',
                        Notes: ''
                    });
                } else if (mode === 'transaction' && item) {
                    setFormData({
                        ItemName: item.ItemName || '',
                        CategoryID: '',
                        LocationID: item.LocationID || '',
                        SKU: '',
                        ReorderPoint: '',
                        Description: '',
                        InitialQuantity: '',
                        QuantityChange: '',
                        TransactionType: 'Stock In',
                        Notes: ''
                    });
                } else {
                    setFormData({
                        ItemName: '',
                        CategoryID: '',
                        LocationID: '',
                        SKU: '',
                        ReorderPoint: '',
                        Description: '',
                        InitialQuantity: '',
                        QuantityChange: '',
                        TransactionType: 'Stock In',
                        Notes: ''
                    });
                }
                
                setShowModal(true);
            };

            const handleCloseModal = () => {
                setShowModal(false);
                setSelectedItem(null);
                setFormData({
                    ItemName: '',
                    CategoryID: '',
                    LocationID: '',
                    SKU: '',
                    ReorderPoint: '',
                    Description: '',
                    InitialQuantity: '',
                    QuantityChange: '',
                    TransactionType: 'Stock In',
                    TransactionDate: (() => {
                        const now = new Date();
                        const year = now.getFullYear();
                        const month = String(now.getMonth() + 1).padStart(2, '0');
                        const day = String(now.getDate()).padStart(2, '0');
                        const hours = String(now.getHours()).padStart(2, '0');
                        const minutes = String(now.getMinutes()).padStart(2, '0');
                        return `${year}-${month}-${day}T${hours}:${minutes}`;
                    })(),
                    Notes: ''
                });
            };

            const handleSaveItem = async () => {
                // Validation
                if (!formData.ItemName.trim()) {
                    setMessage({ type: 'error', text: 'Item name is required' });
                    return;
                }

                if (modalMode === 'transaction') {
                    // Transaction mode validation
                    if (!formData.QuantityChange || parseInt(formData.QuantityChange) === 0) {
                        setMessage({ type: 'error', text: 'Quantity change is required' });
                        return;
                    }
                    if (!formData.LocationID) {
                        setMessage({ type: 'error', text: 'Location is required for transactions' });
                        return;
                    }
                } else {
                    // Item creation/editing validation
                    if (!formData.CategoryID) {
                        setMessage({ type: 'error', text: 'Category is required' });
                        return;
                    }
                }

                setIsSaving(true);
                try {
                    let response;
                    
                    if (modalMode === 'transaction') {
                        // Log inventory transaction
                        const transactionData = {
                            ItemID: selectedItem.ItemID,
                            LocationID: formData.LocationID,
                            PersonnelID: 1, // TODO: Get current user ID
                            QuantityChange: parseInt(formData.QuantityChange) || 0,
                            TransactionType: formData.TransactionType,
                            TransactionDate: formData.TransactionDate,
                            Notes: formData.Notes || ''
                        };
                        
                        response = await gasService.addInventoryTransaction(transactionData);
                    } else {
                        // Create or update item
                        const itemData = {
                            ItemName: formData.ItemName,
                            CategoryID: formData.CategoryID,
                            SKU: formData.SKU || '',
                            ReorderPoint: parseInt(formData.ReorderPoint) || 0,
                            Description: formData.Description || ''
                        };
                        
                        // Add initial quantity and location if provided for new items
                        if (modalMode === 'create' && formData.InitialQuantity && formData.LocationID) {
                            itemData.InitialQuantity = parseInt(formData.InitialQuantity);
                            itemData.LocationID = formData.LocationID;
                            itemData.PersonnelID = 1; // TODO: Get current user ID
                        }

                        if (modalMode === 'edit') {
                            itemData.ItemID = selectedItem.ItemID;
                            response = await gasService.updateInventoryItem(itemData);
                        } else {
                            response = await gasService.createInventoryItem(itemData);
                        }
                    }

                    if (response.success || response === true || response.ItemID || response.TransactionID) {
                        const actionText = modalMode === 'transaction' ? 'Transaction logged' :
                                         modalMode === 'edit' ? 'Item updated' : 'Item created';
                        setMessage({ 
                            type: 'success', 
                            text: `${actionText} successfully` 
                        });
                        handleCloseModal();
                        loadInventory();
                    } else {
                        setMessage({ type: 'error', text: response.error || `Failed to ${modalMode === 'transaction' ? 'log transaction' : 'save item'}` });
                    }
                } catch (error) {
                    console.error('Error saving:', error);
                    setMessage({ type: 'error', text: `Error ${modalMode === 'transaction' ? 'logging transaction' : 'saving item'}` });
                } finally {
                    setIsSaving(false);
                }
            };

            const handleDeleteItem = async (itemId) => {
                if (!confirm('Are you sure you want to delete this item?')) {
                    return;
                }

                try {
                    const response = await gasService.deleteInventoryItem(itemId);
                    if (response.success || response === true) {
                        setMessage({ type: 'success', text: 'Item deleted successfully' });
                        loadInventory();
                    } else {
                        setMessage({ type: 'error', text: 'Failed to delete item' });
                    }
                } catch (error) {
                    console.error('Error deleting item:', error);
                    setMessage({ type: 'error', text: 'Error deleting item' });
                }
            };

            if (isLoading) {
                return e('div', { className: 'p-6' },
                    e('div', { className: 'flex justify-center items-center h-64' },
                        e('div', { className: 'animate-spin rounded-full h-32 w-32 border-b-2 border-blue-500' })
                    )
                );
            }

            return e('div', { className: 'p-6 max-w-screen-xl' },
                // Header
                e('div', { className: 'flex justify-between items-center mb-6' },
                    e('div', null,
                        e('h1', { className: 'text-2xl font-bold text-gray-900' }, 'Inventory Management'),
                        e('p', { className: 'text-sm text-gray-500 mt-0.5' }, 'Track and manage your inventory items')
                    ),
                    e('button', {
                        onClick: () => handleOpenModal('create'),
                        className: 'btn-primary text-white px-4 py-2 text-sm font-semibold rounded-xl flex items-center gap-2'
                    },
                        e('svg', { className: 'w-4 h-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                            e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M12 4v16m8-8H4' })
                        ),
                        'Add New Item'
                    )
                ),

                // Message
                message && e('div', { className: 'mb-4' },
                    e(Message, { type: message.type, message: message.text, onClose: () => setMessage(null) })
                ),

                // Search
                e('div', { className: 'mb-6' },
                    e('input', {
                        type: 'text',
                        placeholder: 'Search items by name, category, location, or notes...',
                        value: searchTerm,
                        onChange: (ev) => setSearchTerm(ev.target.value),
                        className: 'w-full max-w-md px-4 py-2 border border-gray-300 rounded-lg focus:border-sky-400'
                    })
                ),

                // Enhanced Filtering Controls
                e('div', { className: 'mb-6 bg-white p-4 rounded-lg shadow-sm border border-gray-200' },
                    e('div', { className: 'grid grid-cols-1 md:grid-cols-3 gap-4' },
                        // Category Filter
                        e('div', null,
                            e('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 'Category'),
                            e('select', {
                                value: categoryFilter,
                                onChange: (ev) => setCategoryFilter(ev.target.value),
                                className: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500'
                            },
                                e('option', { value: 'all' }, 'All Categories'),
                                ...Array.from(new Set((Array.isArray(inventory) ? inventory : []).map(item => item.CategoryName).filter(Boolean))).map(category =>
                                    e('option', { key: category, value: category }, category)
                                )
                            )
                        ),
                        // Location Filter
                        e('div', null,
                            e('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 'Location'),
                            e('select', {
                                value: locationFilter,
                                onChange: (ev) => setLocationFilter(ev.target.value),
                                className: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500'
                            },
                                e('option', { value: 'all' }, 'All Locations'),
                                ...Array.from(new Set((Array.isArray(inventory) ? inventory : []).map(item => item.LocationName).filter(Boolean))).map(location =>
                                    e('option', { key: location, value: location }, location)
                                )
                            )
                        ),
                        // Stock Status Filter
                        e('div', null,
                            e('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 'Stock Status'),
                            e('select', {
                                value: stockFilter,
                                onChange: (ev) => setStockFilter(ev.target.value),
                                className: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500'
                            },
                                e('option', { value: 'all' }, 'All Items'),
                                e('option', { value: 'available' }, 'Available (6+)'),
                                e('option', { value: 'low' }, 'Low Stock (1-5)'),
                                e('option', { value: 'out' }, 'Out of Stock (0)')
                            )
                        )
                    ),
                    // Stats Summary Row
                    inventoryStats && e('div', { className: 'mt-4 pt-4 border-t border-gray-200' },
                        e('div', { className: 'grid grid-cols-2 md:grid-cols-5 gap-4 text-center' },
                            e('div', null,
                                e('div', { className: 'text-2xl font-bold text-blue-600' }, inventoryStats.total),
                                e('div', { className: 'text-sm text-gray-600' }, 'Total Items')
                            ),
                            e('div', null,
                                e('div', { className: 'text-2xl font-bold text-purple-600' }, inventoryStats.categories),
                                e('div', { className: 'text-sm text-gray-600' }, 'Categories')
                            ),
                            e('div', null,
                                e('div', { className: 'text-2xl font-bold text-indigo-600' }, inventoryStats.locations),
                                e('div', { className: 'text-sm text-gray-600' }, 'Locations')
                            ),
                            e('div', null,
                                e('div', { className: 'text-2xl font-bold text-yellow-600' }, inventoryStats.lowStock),
                                e('div', { className: 'text-sm text-gray-600' }, 'Low Stock')
                            ),
                            e('div', null,
                                e('div', { className: 'text-2xl font-bold text-red-600' }, inventoryStats.outOfStock),
                                e('div', { className: 'text-sm text-gray-600' }, 'Out of Stock')
                            )
                        )
                    )
                ),

                // Inventory Table
                filteredInventory.length === 0 ? (
                    e('div', { className: 'text-center py-12 bg-white rounded-lg shadow-sm' },
                        e('svg', { className: 'mx-auto h-12 w-12 text-gray-400', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                            e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4' })
                        ),
                        e('h3', { className: 'mt-2 text-sm font-medium text-gray-900' }, 'No items found'),
                        e('p', { className: 'mt-1 text-sm text-gray-500' }, 'Get started by adding your first inventory item'),
                        e('div', { className: 'mt-6' },
                            e('button', {
                                onClick: () => handleOpenModal('create'),
                                className: 'inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700'
                            },
                                e('svg', { className: '-ml-1 mr-2 h-5 w-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                                    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M12 4v16m8-8H4' })
                                ),
                                'Add New Item'
                            )
                        )
                    )
                ) : (
                    e('div', { className: 'bg-white rounded-xl shadow-card border border-gray-100 overflow-hidden' },
                        e('table', { className: 'min-w-full divide-y divide-gray-200' },
                            e('thead', { className: 'bg-gray-50' },
                                e('tr', null,
                                    e('th', { 
                                        className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer',
                                        onClick: () => handleSort('ItemName')
                                    }, 'Item Name ' + (sortConfig.key === 'ItemName' ? (sortConfig.direction === 'asc' ? '↑' : '↓') : '')),
                                    e('th', { 
                                        className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer',
                                        onClick: () => handleSort('CategoryName')
                                    }, 'Category ' + (sortConfig.key === 'CategoryName' ? (sortConfig.direction === 'asc' ? '↑' : '↓') : '')),
                                    e('th', { 
                                        className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer',
                                        onClick: () => handleSort('CurrentQuantity')
                                    }, 'Current Qty ' + (sortConfig.key === 'CurrentQuantity' ? (sortConfig.direction === 'asc' ? '↑' : '↓') : '')),
                                    e('th', { 
                                        className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer',
                                        onClick: () => handleSort('LocationName')
                                    }, 'Location ' + (sortConfig.key === 'LocationName' ? (sortConfig.direction === 'asc' ? '↑' : '↓') : '')),
                                    e('th', { className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider' }, 'Reorder Point'),
                                    e('th', { className: 'px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider' }, 'Actions')
                                )
                            ),
                            e('tbody', { className: 'bg-white divide-y divide-gray-200' },
                                filteredInventory.map(item =>
                                    e('tr', { key: `${item.ItemID}-${item.LocationID}`, className: 'hover:bg-gray-50' },
                                        e('td', { className: 'px-6 py-4 whitespace-nowrap' },
                                            e('div', { className: 'text-sm font-medium text-gray-900' }, item.ItemName || '-'),
                                            e('div', { className: 'text-sm text-gray-500' }, `ID: ${item.ItemID}${item.SKU ? ` • SKU: ${item.SKU}` : ''}`)
                                        ),
                                        e('td', { className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-900' },
                                            item.CategoryName || '-'
                                        ),
                                        e('td', { className: 'px-6 py-4 whitespace-nowrap' },
                                            e('div', { className: 'flex items-center' },
                                                e('span', { className: 'text-sm font-medium text-gray-900' }, item.CurrentQuantity || '0'),
                                                e('span', { 
                                                    className: `ml-2 inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                                                        getStockStatus(item) === 'out' ? 'bg-red-100 text-red-800' :
                                                        getStockStatus(item) === 'low' ? 'bg-yellow-100 text-yellow-800' :
                                                        'bg-green-100 text-green-800'
                                                    }`
                                                }, 
                                                    getStockStatus(item) === 'out' ? 'Out' :
                                                    getStockStatus(item) === 'low' ? 'Low' : 'OK'
                                                )
                                            )
                                        ),
                                        e('td', { className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-900' },
                                            item.LocationName || '-'
                                        ),
                                        e('td', { className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-900' },
                                            item.ReorderPoint || '0'
                                        ),
                                        e('td', { className: 'px-6 py-4 whitespace-nowrap text-right text-sm font-medium' },
                                            e('div', { className: 'flex justify-end gap-2' },
                                                e('button', {
                                                    onClick: () => handleOpenModal('transaction', item),
                                                    className: 'text-green-600 hover:text-green-900',
                                                    title: 'Log Transaction'
                                                }, 'Stock'),
                                                e('button', {
                                                    onClick: () => handleOpenModal('edit', item),
                                                    className: 'text-indigo-600 hover:text-indigo-900'
                                                }, 'Edit'),
                                                e('button', {
                                                    onClick: () => handleDeleteItem(item.ItemID),
                                                    className: 'text-red-600 hover:text-red-900'
                                                }, 'Delete')
                                            )
                                        )
                                    )
                                )
                            )
                        )
                    )
                ),

                // Modal - Updated for new schema with three modes
                showModal && e('div', { className: 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50' },
                    e('div', { className: 'relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white max-h-[90vh] overflow-y-auto' },
                        e('div', { className: 'mt-3' },
                            e('h3', { className: 'text-lg font-medium text-gray-900 mb-4' },
                                modalMode === 'edit' ? 'Edit Item' : 
                                modalMode === 'transaction' ? `Log Transaction - ${selectedItem?.ItemName}` :
                                'Add New Item'
                            ),
                            e('div', { className: 'space-y-4' },
                                // Show different fields based on modal mode
                                modalMode === 'transaction' ? [
                                    // Transaction Mode Fields
                                    e('div', { key: 'current-info' },
                                        e('div', { className: 'bg-gray-50 p-3 rounded-md' },
                                            e('div', { className: 'text-sm text-gray-600' }, 'Current Stock Information'),
                                            e('div', { className: 'text-lg font-medium' }, `${selectedItem?.ItemName || 'Unknown Item'}`),
                                            e('div', { className: 'text-sm text-gray-500' }, `Location: ${selectedItem?.LocationName || 'Unknown'}`),
                                            e('div', { className: 'text-sm text-gray-500' }, `Current Quantity: ${selectedItem?.CurrentQuantity || 0}`)
                                        )
                                    ),
                                    e('div', { key: 'location' },
                                        e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Location *'),
                                        e('select', {
                                            value: formData.LocationID,
                                            onChange: (ev) => setFormData(prev => ({ ...prev, LocationID: ev.target.value })),
                                            className: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500'
                                        },
                                            e('option', { value: '' }, 'Select location...'),
                                            ...(Array.isArray(locations) ? locations.map(location =>
                                                e('option', { key: location.LocationID, value: location.LocationID }, location.LocationName)
                                            ) : [])
                                        )
                                    ),
                                    e('div', { key: 'quantity-change' },
                                        e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Quantity Change *'),
                                        e('input', {
                                            type: 'number',
                                            value: formData.QuantityChange,
                                            onChange: (ev) => setFormData(prev => ({ ...prev, QuantityChange: ev.target.value })),
                                            className: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500',
                                            placeholder: 'e.g., +10 for stock in, -2 for sale'
                                        })
                                    ),
                                    e('div', { key: 'transaction-type' },
                                        e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Transaction Type'),
                                        e('select', {
                                            value: formData.TransactionType,
                                            onChange: (ev) => setFormData(prev => ({ ...prev, TransactionType: ev.target.value })),
                                            className: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500'
                                        },
                                            e('option', { value: 'Stock In' }, 'Stock In'),
                                            e('option', { value: 'Sale' }, 'Sale'),
                                            e('option', { value: 'Internal Transfer' }, 'Internal Transfer'),
                                            e('option', { value: 'Damage' }, 'Damage'),
                                            e('option', { value: 'Manual Adjustment' }, 'Manual Adjustment')
                                        )
                                    ),
                                    e('div', { key: 'transaction-date' },
                                        e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Transaction Date & Time'),
                                        e('input', {
                                            type: 'datetime-local',
                                            value: formData.TransactionDate,
                                            onChange: (ev) => setFormData(prev => ({ ...prev, TransactionDate: ev.target.value })),
                                            className: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500'
                                        })
                                    ),
                                    e('div', { key: 'transaction-notes' },
                                        e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Notes'),
                                        e('textarea', {
                                            value: formData.Notes,
                                            onChange: (ev) => setFormData(prev => ({ ...prev, Notes: ev.target.value })),
                                            className: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500',
                                            rows: 3,
                                            placeholder: 'Optional transaction notes'
                                        })
                                    )
                                ] : [
                                    // Item Creation/Edit Mode Fields
                                    e('div', { key: 'item-name' },
                                        e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Item Name *'),
                                        e('input', {
                                            type: 'text',
                                            value: formData.ItemName,
                                            onChange: (ev) => setFormData(prev => ({ ...prev, ItemName: ev.target.value })),
                                            className: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500',
                                            placeholder: 'Enter item name'
                                        })
                                    ),
                                    e('div', { key: 'category' },
                                        e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Category *'),
                                        e('select', {
                                            value: formData.CategoryID,
                                            onChange: (ev) => setFormData(prev => ({ ...prev, CategoryID: ev.target.value })),
                                            className: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500'
                                        },
                                            e('option', { value: '' }, 'Select category...'),
                                            ...((() => {
                                                console.log('Rendering category dropdown, categories:', categories);
                                                console.log('Categories is array:', Array.isArray(categories));
                                                console.log('Categories length:', categories?.length);
                                                if (Array.isArray(categories) && categories.length > 0) {
                                                    console.log('First category:', categories[0]);
                                                }
                                                return Array.isArray(categories) ? categories.map(category => {
                                                    console.log('Mapping category:', category);
                                                    return e('option', { key: category.CategoryID, value: category.CategoryID }, category.CategoryName);
                                                }) : [];
                                            })())
                                        )
                                    ),
                                    e('div', { key: 'sku' },
                                        e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'SKU'),
                                        e('input', {
                                            type: 'text',
                                            value: formData.SKU,
                                            onChange: (ev) => setFormData(prev => ({ ...prev, SKU: ev.target.value })),
                                            className: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500',
                                            placeholder: 'Optional SKU or barcode'
                                        })
                                    ),
                                    e('div', { key: 'reorder-point' },
                                        e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Reorder Point'),
                                        e('input', {
                                            type: 'number',
                                            value: formData.ReorderPoint,
                                            onChange: (ev) => setFormData(prev => ({ ...prev, ReorderPoint: ev.target.value })),
                                            className: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500',
                                            placeholder: '0',
                                            min: '0'
                                        })
                                    ),
                                    modalMode === 'create' && e('div', { key: 'initial-stock' },
                                        e('h4', { className: 'text-md font-medium text-gray-900 mt-4 mb-2' }, 'Initial Stock (Optional)'),
                                        e('div', { className: 'grid grid-cols-2 gap-3' },
                                            e('div', null,
                                                e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Initial Quantity'),
                                                e('input', {
                                                    type: 'number',
                                                    value: formData.InitialQuantity,
                                                    onChange: (ev) => setFormData(prev => ({ ...prev, InitialQuantity: ev.target.value })),
                                                    className: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500',
                                                    placeholder: '0',
                                                    min: '0'
                                                })
                                            ),
                                            e('div', null,
                                                e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Location'),
                                                e('select', {
                                                    value: formData.LocationID,
                                                    onChange: (ev) => setFormData(prev => ({ ...prev, LocationID: ev.target.value })),
                                                    className: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500'
                                                },
                                                    e('option', { value: '' }, 'Select location...'),
                                                    ...(Array.isArray(locations) ? locations.map(location =>
                                                        e('option', { key: location.LocationID, value: location.LocationID }, location.LocationName)
                                                    ) : [])
                                                )
                                            )
                                        )
                                    ),
                                    e('div', { key: 'description' },
                                        e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Description'),
                                        e('textarea', {
                                            value: formData.Description,
                                            onChange: (ev) => setFormData(prev => ({ ...prev, Description: ev.target.value })),
                                            className: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500',
                                            rows: 3,
                                            placeholder: 'Optional item description'
                                        })
                                    )
                                ]
                            ),
                            e('div', { className: 'flex justify-end gap-3 mt-6' },
                                e('button', {
                                    onClick: handleCloseModal,
                                    className: 'px-4 py-2 text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300',
                                    disabled: isSaving
                                }, 'Cancel'),
                                e('button', {
                                    onClick: handleSaveItem,
                                    className: 'px-4 py-2 text-white bg-blue-600 rounded-md hover:bg-blue-700 disabled:opacity-50',
                                    disabled: isSaving
                                }, isSaving ? 'Saving...' : 
                                   modalMode === 'transaction' ? 'Log Transaction' :
                                   modalMode === 'edit' ? 'Update Item' : 'Create Item')
                            )
                        )
                    )
                )
            );
        }

        function Scheduling() {
            return e('div', { className: 'p-6 max-w-screen-xl' },
                e('div', { className: 'mb-6' },
                    e('h1', { className: 'text-2xl font-bold text-gray-900' }, 'Schedule'),
                    e('p', { className: 'text-sm text-gray-500 mt-0.5' }, 'Upcoming features')
                ),
                e('div', { className: 'bg-white rounded-xl shadow-card border border-gray-100 p-12 text-center' },
                    e('p', { className: 'text-4xl mb-3' }, '📅'),
                    e('p', { className: 'text-lg font-semibold text-gray-700 mb-1' }, 'Scheduling Coming Soon'),
                    e('p', { className: 'text-sm text-gray-400' }, 'This feature is under development.')
                )
            );
        }

        // StudentDirectory Component
        function StudentDirectory({ onNavigateToStudent }) {
            const [students, setStudents] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [searchTerm, setSearchTerm] = useState('');
            const [message, setMessage] = useState(null);

            useEffect(() => {
                loadStudents();
            }, []);

            const loadStudents = async () => {
                setIsLoading(true);
                try {
                    const response = await gasService.getAllStudents();
                    console.log('getAllStudents response in StudentDirectory:', response);
                    
                    if (response.success && Array.isArray(response.data)) {
                        console.log('Sample student data:', response.data[0]);
                        setStudents(response.data);
                    } else if (response.success && response.data && Array.isArray(response.data.data)) {
                        console.log('Sample student data (nested):', response.data.data[0]);
                        setStudents(response.data.data);
                    } else {
                        setMessage({ type: 'error', text: response.error || 'Failed to load students.' });
                        setStudents([]);
                    }
                } catch (error) {
                    console.error('Error loading students:', error);
                    setMessage({ type: 'error', text: 'Error loading students.' });
                    setStudents([]);
                } finally {
                    setIsLoading(false);
                }
            };

            const filteredStudents = students.filter(student =>
                `${student.FirstName} ${student.LastName || student.LastName || ''}`.toLowerCase().includes(searchTerm.toLowerCase()) ||
                (student.PrimaryEmail && student.PrimaryEmail.toLowerCase().includes(searchTerm.toLowerCase()))
            );

            return e('div', { className: 'p-6 max-w-screen-xl' },
                e('div', { className: 'flex justify-between items-center mb-6' },
                    e('div', null,
                        e('h1', { className: 'text-2xl font-bold text-gray-900' }, 'Student Directory'),
                        e('p', { className: 'text-sm text-gray-500 mt-0.5' }, `${filteredStudents.length} students`)
                    )
                ),

                message && e('div', { className: 'mb-4' },
                    e(Message, {
                        type: message.type,
                        message: message.text,
                        onClose: () => setMessage(null)
                    })
                ),

                e('div', { className: 'mb-6' },
                    e('input', {
                        type: 'text',
                        placeholder: 'Search by name or email…',
                        value: searchTerm,
                        onChange: (e) => setSearchTerm(e.target.value),
                        className: 'w-full max-w-sm px-4 py-2.5 text-sm border border-gray-200 rounded-xl bg-white shadow-sm focus:border-sky-400 transition-colors'
                    })
                ),

                isLoading ? e(Loader, { text: 'Loading students...' }) :
                filteredStudents.length === 0 ? (
                    e('div', { className: 'text-center text-gray-400 mt-8' },
                        e('p', { className: 'text-gray-600 font-medium' }, 'No students found.'),
                        e('button', {
                            onClick: loadStudents,
                            className: 'btn-primary mt-3 px-4 py-2 text-sm font-semibold text-white rounded-xl'
                        }, 'Reload')
                    )
                ) : (
                    e('div', { className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4' },
                        filteredStudents.map(student => {
                            // Determine what to show in the circle
                            const getCurrentOrRecentLevel = () => {
                                // Debug log for first student
                                if (student.StudentID === filteredStudents[0].StudentID) {
                                    console.log('Student debug:', {
                                        name: `${student.FirstName} ${student.LastName}`,
                                        CurrentEnrollment: student.CurrentEnrollment,
                                        HighestLevelCompleted: student.HighestLevelCompleted
                                    });
                                }
                                
                                if (student.CurrentEnrollment) {
                                    // Extract level number/name from current enrollment
                                    // Examples: "Level 101" -> "101", "Advanced Improv" -> "ADV"
                                    const match = student.CurrentEnrollment.match(/\d+/);
                                    if (match) {
                                        return match[0];
                                    }
                                    // If no number, use first 3 letters
                                    return student.CurrentEnrollment.substring(0, 3).toUpperCase();
                                }
                                // Fallback to highest level completed or initials
                                if (student.HighestLevelCompleted) {
                                    const match = student.HighestLevelCompleted.match(/\d+/);
                                    if (match) {
                                        return match[0];
                                    }
                                    return student.HighestLevelCompleted.substring(0, 3).toUpperCase();
                                }
                                return `${(student.FirstName || '').charAt(0)}${(student.LastName || student.LastName || '').charAt(0)}`.toUpperCase();
                            };
                            
                            const levelDisplay = getCurrentOrRecentLevel();
                            const isNumericLevel = /^\d+$/.test(levelDisplay);
                            
                            return e('div', {
                                key: student.StudentID || student.PersonnelID,
                                className: 'bg-white rounded-xl shadow-card border border-gray-100 p-4 hover:shadow-md transition-shadow cursor-pointer',
                                onClick: () => onNavigateToStudent && onNavigateToStudent(student.StudentID || student.PersonnelID)
                            },
                                e('div', { className: 'flex items-center space-x-3 mb-3' },
                                    e('div', { 
                                        className: `w-12 h-12 rounded-full flex items-center justify-center font-bold text-white shadow-sm ${
                                            student.CurrentEnrollment 
                                                ? 'bg-gradient-to-br from-green-500 to-green-600' 
                                                : student.HighestLevelCompleted
                                                ? 'bg-gradient-to-br from-blue-500 to-blue-600'
                                                : 'bg-gradient-to-br from-gray-400 to-gray-500'
                                        }`
                                    },
                                        isNumericLevel 
                                            ? e('span', { className: 'text-sm' }, levelDisplay)
                                            : e('span', { className: 'text-xs' }, levelDisplay)
                                    ),
                                    e('div', { className: 'flex-1' },
                                        e('h3', { className: 'font-semibold text-gray-900' }, 
                                            `${student.FirstName} ${student.LastName || student.LastName || ''}`
                                        ),
                                        e('p', { className: 'text-sm text-gray-600' }, student.PrimaryEmail)
                                    )
                                ),
                                student.CurrentEnrollment && e('div', { className: 'mb-2 px-2.5 py-1.5 bg-emerald-50 border border-emerald-100 rounded-lg text-xs' },
                                    e('span', { className: 'font-semibold text-emerald-700' }, 'Current: '),
                                    e('span', { className: 'text-emerald-600' }, student.CurrentEnrollment)
                                ),
                                e('div', { className: 'text-xs text-gray-500 space-y-0.5' },
                                    e('p', null, `📞 ${student.PrimaryPhone || 'N/A'}`),
                                    e('p', null, `🎂 ${student.Birthday ? new Date(student.Birthday).toLocaleDateString() : 'N/A'}`)
                                ),
                                e('button', {
                                    className: 'mt-3 px-3 py-1.5 text-xs font-semibold bg-sky-50 text-sky-600 rounded-lg hover:bg-sky-100 transition-colors w-full border border-sky-100',
                                    onClick: (e) => { 
                                        e.stopPropagation(); 
                                        onNavigateToStudent && onNavigateToStudent(student.StudentID || student.PersonnelID); 
                                    }
                                }, 'View Profile')
                            );
                        })
                    )
                )
            );
        }

        // Main App Component
        function App() {
            const [currentPage, setCurrentPage] = useState('dashboard');
            const [selectedStudentId, setSelectedStudentId] = useState(null);
            const [showStudentProfile, setShowStudentProfile] = useState(false);

            const handleNavigateToStudentProfile = (studentId) => {
                setSelectedStudentId(studentId);
                setShowStudentProfile(true);
            };

            const handleBackToStudentDirectory = () => {
                setShowStudentProfile(false);
                setSelectedStudentId(null);
                setCurrentPage('student-directory');
            };

            const renderPage = () => {
                if (showStudentProfile && selectedStudentId) {
                    return e(StudentProfile, {
                        studentId: selectedStudentId,
                        onBack: handleBackToStudentDirectory
                    });
                }

                switch (currentPage) {
                    case 'dashboard':
                        return e(Dashboard);
                    case 'personnel':
                        return e(PersonnelDirectory);
                    case 'student-directory':
                        return e(StudentDirectory, {
                            onNavigateToStudent: handleNavigateToStudentProfile
                        });
                    case 'cast':
                        return e(CastDirectory);
                    case 'crew':
                        return e(CrewDirectory);
                    case 'bartenders':
                        return e(BartendersPage);
                    case 'teachers':
                        return e(TeachersPage);
                    case 'classes':
                        return e(ClassRegistration);
                    case 'shows':
                        return e(Shows);
                    case 'inventory':
                        return e(Inventory);
                    case 'scheduling':
                        return e(Scheduling);
                    default:
                        return e(Dashboard);
                }
            };

            return e('div', { className: 'flex w-full h-full bg-slate-100 overflow-hidden' },
                e(Sidebar, { currentPage: currentPage, onNavigate: (page) => {
                    setShowStudentProfile(false);
                    setCurrentPage(page);
                }}),
                e('main', {
                    key: showStudentProfile ? `profile-${selectedStudentId}` : currentPage,
                    className: 'flex-1 overflow-hidden page-enter',
                    style: { display: 'flex', flexDirection: 'column', alignItems: 'center' }
                },
                    e('div', { style: { width: '100%', maxWidth: '1400px', flex: '1', minHeight: 0, display: 'flex', flexDirection: 'column', overflowY: 'auto' } },
                        renderPage()
                    )
                )
            );
        }

        // Expose debug functions globally for console testing
        window.debugPersonnel = async () => {
            console.log('=== Testing Personnel Debug Functions ===');
            try {
                // Test 1: Basic connection
                console.log('1. Testing basic connection...');
                const connectionTest = await gasService.testConnection();
                console.log('Connection test result:', connectionTest);

                // Test 2: Debug personnel sheet
                console.log('2. Testing personnel sheet debug...');
                const debugResult = await gasService.debugPersonnelSheet();
                console.log('Debug personnel result:', debugResult);

                // Test 3: Get all personnel 
                console.log('3. Testing getAllPersonnel...');
                const personnelResult = await gasService.getAllPersonnel();
                console.log('Get all personnel result:', personnelResult);

                return {
                    connectionTest,
                    debugResult,
                    personnelResult
                };
            } catch (error) {
                console.error('Error in debug functions:', error);
                return { error: error.toString() };
            }
        };

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(e(App));
    </script>
</body>
</html>
