<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JTF Team Management Portal</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e'
                        },
                        secondary: {
                            50: '#fdf4ff',
                            100: '#fae8ff',
                            200: '#f5d0fe',
                            300: '#f0abfc',
                            400: '#e879f9',
                            500: '#d946ef',
                            600: '#c026d3',
                            700: '#a21caf',
                            800: '#86198f',
                            900: '#701a75'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
        }
        .loading-spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #0ea5e9;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="root">
        <div style="display: flex; justify-content: center; align-items: center; height: 100vh; flex-direction: column;">
            <div class="loading-spinner"></div>
            <p style="margin-top: 20px; color: #6b7280;">Loading JTF Portal...</p>
        </div>
    </div>

    <script type="text/babel">
        // Google Apps Script Service
        // This service handles all CRUD operations between the frontend and Google Sheets database
        
        // Environment detection - check if we're in Google Apps Script environment
        let isDevelopment = true; // Default to development mode
        
        try {
            // Check if we're actually in a Google Apps Script environment
            if (typeof google !== 'undefined' && 
                google.script && 
                typeof google.script.run !== 'undefined' &&
                window.location.hostname.includes('script.google.com')) {
                isDevelopment = false; // We're in a real Google Apps Script environment
            }
        } catch (e) {
            // If any error occurs, stay in development mode
            isDevelopment = true;
        }

        // DEBUG: Log the environment detection
        console.log('=== ENVIRONMENT DETECTION ===');
        console.log('typeof google:', typeof google);
        console.log('google exists:', typeof google !== 'undefined');
        console.log('google.script exists:', typeof google !== 'undefined' && !!google.script);
        console.log('hostname:', window.location.hostname);
        console.log('isDevelopment:', isDevelopment);
        
        // Force production mode to use Google Sheets data
        isDevelopment = false;
        
        console.log('Final isDevelopment (forced to use real data):', isDevelopment);
        console.log('================================');

        class GoogleAppsScriptService {
            // ===================================================================
            // GOOGLE APPS SCRIPT COMMUNICATION METHOD
            // This method routes all CRUD operations to Google Apps Script functions  
            // Now connects directly to your Google Sheets database
            // ===================================================================
            async callServerFunction(functionName, ...args) {
                console.log(`=== callServerFunction called ===`);
                console.log(`Calling ${functionName} with args:`, args);
                console.log('isDevelopment:', isDevelopment);
                
                // Force Google Apps Script usage - no more mock data
                console.log('Making real Apps Script call to', functionName);
                
                try {
                    const result = await new Promise((resolve, reject) => {
                        google.script.run
                            .withSuccessHandler((result) => {
                                console.log(`${functionName} success:`, result);
                                resolve(result);
                            })
                            .withFailureHandler((error) => {
                                console.error(`${functionName} error:`, error);
                                reject(error);
                            })
                            [functionName](...args);
                    });

                    return { success: true, data: result };
                } catch (error) {
                    console.error(`Error calling ${functionName}:`, error);
                    return { success: false, error: error.toString() };
                }
            }

            // ===================================================================
            // PERSONNEL CRUD API METHODS
            // These methods interact with the Personnel sheet in Google Sheets
            // ===================================================================
            
            // READ: Get all personnel records from Personnel sheet
            async getAllPersonnel() {
                return this.callServerFunction('getAllPersonnel');
            }

            // CREATE: Add new person to Personnel sheet (PersonnelID auto-generated)
            async createPersonnel(personnel) {
                return this.callServerFunction('createPersonnel', personnel);
            }

            // UPDATE: Modify existing person in Personnel sheet by PersonnelID
            async updatePersonnel(personnel) {
                return this.callServerFunction('updatePersonnel', personnel);
            }

            // DELETE: Remove person from Personnel sheet by PersonnelID
            async deletePersonnel(personnelId) {
                return this.callServerFunction('deletePersonnel', personnelId);
            }

            // ===================================================================
            // DEBUG METHOD - Test Google Sheets connection
            // ===================================================================
            
            // DEBUG: Test the Personnel sheet connection and data
            // Test basic connection
            async testConnection() {
                return this.callServerFunction('testConnection');
            }

            async debugPersonnelSheet() {
                return this.callServerFunction('debugPersonnelSheet');
            }

            // ===================================================================
            // CAST CRUD API METHODS  
            // These methods interact with cast member data from ShowPerformances sheet
            // ===================================================================
            
            // READ: Get all cast members with show details
            async getAllCastMembers() {
                return this.callServerFunction('getAllCastMembers');
            }

            // ===================================================================
            // SHOW CRUD API METHODS  
            // These methods interact with the ShowInformation sheet in Google Sheets
            // ===================================================================
            
            // READ: Get all show records from ShowInformation sheet
            async getAllShows() {
                return this.callServerFunction('getAllShows');
            }

            // ===================================================================
            // CLASS CRUD API METHODS
            // These methods interact with the ClassOfferings sheet in Google Sheets
            // ===================================================================
            
            // READ: Get all class offering records from ClassOfferings sheet
            async getAllClasses() {
                return this.callServerFunction('getAllClasses');
            }

            // ===================================================================
            // INVENTORY CRUD API METHODS
            // These methods interact with the Inventory sheet in Google Sheets
            // ===================================================================
            
            // READ: Get all inventory items from Inventory sheet
            async getAllInventory() {
                return this.callServerFunction('getAllInventory');
            }

            // ===================================================================
            // DASHBOARD STATISTICS API METHOD
            // This method reads from multiple sheets to calculate dashboard stats
            // READS FROM: Personnel, ShowInformation, ClassOfferings, StudentEnrollments sheets
            // ===================================================================
            
            // READ: Calculate aggregated statistics from multiple sheets
            async getDashboardStats() {
                return this.callServerFunction('getDashboardStats');
            }

            // ===================================================================
            // ENROLLMENT CRUD API METHODS
            // These methods interact with the StudentEnrollments sheet in Google Sheets
            // ===================================================================
            
            // CREATE: Add student enrollment records to StudentEnrollments sheet
            // Links students (PersonnelID) to classes (OfferingID)
            async enrollStudents(offeringId, studentIds) {
                return this.callServerFunction('enrollStudents', offeringId, studentIds);
            }

            // ===================================================================
            // INVENTORY ITEM CRUD API METHODS (FULL CRUD OPERATIONS)
            // These methods provide complete Create, Read, Update, Delete for inventory
            // ===================================================================
            
            // CREATE: Add new inventory item to Inventory sheet (ItemID auto-generated)
            async createInventoryItem(item) {
                return this.callServerFunction('createInventoryItem', item);
            }

            // UPDATE: Modify existing inventory item in Inventory sheet by ItemID
            async updateInventoryItem(item) {
                return this.callServerFunction('updateInventoryItem', item);
            }

            // DELETE: Remove inventory item from Inventory sheet by ItemID
            async deleteInventoryItem(itemId) {
                return this.callServerFunction('deleteInventoryItem', itemId);
            }

            // ===================================================================
            // STUDENT MANAGEMENT API METHODS
            // These methods interact with student profile and enrollment data
            // ===================================================================

            // READ: Get comprehensive student profile data (uses StudentID from StudentInfo table)
            // Updated: 2025-10-13 - Now calls getStudentProfileData backend function
            async getStudentProfile(studentId) {
                console.log('=== gasService.getStudentProfile called ===');
                console.log('Calling backend: getStudentProfileData with studentId:', studentId);
                return this.callServerFunction('getStudentProfileData', studentId);
            }

            // READ: Get all students with full details (joins StudentInfo + Personnel)
            // Updated: 2025-10-13 - Now calls getAllStudentsWithDetails backend function
            async getAllStudents() {
                console.log('=== gasService.getAllStudents called ===');
                console.log('Calling backend: getAllStudentsWithDetails');
                return this.callServerFunction('getAllStudentsWithDetails');
            }

            // READ: Get active class offerings for enrollment
            async getActiveClassOfferings() {
                return this.callServerFunction('getActiveClassOfferings');
            }

            // CREATE: Enroll a single student in a class
            async enrollStudent(studentId, offeringId) {
                return this.callServerFunction('enrollStudent', studentId, offeringId);
            }
        }

        const gasService = new GoogleAppsScriptService();

        // React Components
        const { useState, useEffect, createElement: e } = React;

        // Loader Component
        function Loader({ text = 'Loading...' }) {
            return e('div', { className: 'flex flex-col items-center justify-center p-4' },
                e('div', { className: 'loading-spinner' }),
                e('p', { className: 'mt-2 text-sm text-gray-600' }, text)
            );
        }

        // Message Component
        function Message({ type, message, onClose }) {
            const typeClasses = {
                success: "bg-green-50 text-green-800 border border-green-200",
                error: "bg-red-50 text-red-800 border border-red-200",
                warning: "bg-yellow-50 text-yellow-800 border border-yellow-200",
                info: "bg-blue-50 text-blue-800 border border-blue-200"
            };

            const iconClasses = {
                success: "✓",
                error: "✗",
                warning: "⚠",
                info: "ℹ"
            };

            return e('div', { className: `p-4 rounded-lg flex items-center justify-between ${typeClasses[type]}` },
                e('div', { className: 'flex items-center' },
                    e('span', { className: 'mr-2 font-semibold' }, iconClasses[type]),
                    e('span', null, message)
                ),
                onClose && e('button', {
                    onClick: onClose,
                    className: 'ml-4 hover:opacity-70 transition-opacity'
                }, '×')
            );
        }

        // StatCard Component
        function StatCard({ title, value, icon, color = 'blue' }) {
            const colorClasses = {
                blue: 'bg-blue-50 text-blue-600 border-blue-200',
                green: 'bg-green-50 text-green-600 border-green-200',
                purple: 'bg-purple-50 text-purple-600 border-purple-200',
                orange: 'bg-orange-50 text-orange-600 border-orange-200'
            };

            return e('div', { className: 'bg-white rounded-lg shadow-sm border p-6' },
                e('div', { className: 'flex items-center justify-between' },
                    e('div', null,
                        e('p', { className: 'text-sm font-medium text-gray-600 mb-1' }, title),
                        e('p', { className: 'text-3xl font-bold text-gray-900' }, value)
                    ),
                    e('div', { className: `w-12 h-12 rounded-lg border flex items-center justify-center text-xl ${colorClasses[color]}` }, icon)
                )
            );
        }

        // PersonCard Component
        function PersonCard({ person, onClick }) {
            const getInitials = (firstName, lastName) => {
                return `${firstName.charAt(0)}${lastName.charAt(0)}`.toUpperCase();
            };

            return e('div', {
                onClick: onClick,
                className: 'bg-white rounded-lg shadow-sm border p-4 hover:shadow-md transition-shadow cursor-pointer'
            },
                e('div', { className: 'flex items-center space-x-3 mb-3' },
                    e('div', { className: 'w-10 h-10 bg-primary-100 rounded-full flex items-center justify-center text-primary-700 font-semibold' },
                        getInitials(person.FirstName, person.Lastname)
                    ),
                    e('div', null,
                        e('h3', { className: 'font-semibold text-gray-900' }, `${person.FirstName} ${person.Lastname}`),
                        e('p', { className: 'text-sm text-gray-600' }, person.PrimaryEmail)
                    )
                )
            );
        }

        // StudentProfile Component
        function StudentProfile({ studentId, onBack }) {
            const [student, setStudent] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [message, setMessage] = useState(null);

            useEffect(() => {
                loadStudentProfile();
            }, [studentId]);

            const loadStudentProfile = async () => {
                setIsLoading(true);
                try {
                    console.log('=== Loading Student Profile ===');
                    console.log('StudentID:', studentId);
                    const response = await gasService.getStudentProfile(studentId);
                    console.log('getStudentProfile response:', response);
                    
                    if (response.success) {
                        // The response structure is: { success: true, data: { success: true, data: actualStudentData } }
                        // We need to unwrap it properly
                        const studentData = response.data?.data || response.data;
                        console.log('Student data received (unwrapped):', studentData);
                        console.log('FirstName:', studentData?.FirstName);
                        console.log('Lastname:', studentData?.Lastname);
                        console.log('PrimaryEmail:', studentData?.PrimaryEmail);
                        console.log('PrimaryPhone:', studentData?.PrimaryPhone);
                        console.log('Birthday:', studentData?.Birthday);
                        setStudent(studentData);
                    } else {
                        console.error('Failed to load student:', response.error);
                        setMessage({ type: 'error', text: response.error || 'Failed to load student profile' });
                    }
                } catch (error) {
                    console.error('Error loading student profile:', error);
                    setMessage({ type: 'error', text: 'Error loading student profile' });
                } finally {
                    setIsLoading(false);
                }
            };

            if (isLoading) {
                return e(Loader, { text: 'Loading student profile...' });
            }

            if (!student) {
                return e('div', { className: 'p-6' },
                    e('button', {
                        onClick: onBack,
                        className: 'mb-4 px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors'
                    }, '← Back'),
                    message && e(Message, {
                        type: message.type,
                        message: message.text
                    })
                );
            }

            return e('div', { className: 'p-6' },
                e('div', { className: 'flex items-center justify-between mb-6' },
                    e('div', { className: 'flex items-center' },
                        e('button', {
                            onClick: onBack,
                            className: 'mr-4 px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors'
                        }, '← Back'),
                        e('h1', { className: 'text-2xl font-bold text-gray-900' }, 
                            `${student.FirstName || 'Unknown'} ${student.Lastname || 'Student'} - Student Profile`
                        )
                    )
                ),

                message && e('div', { className: 'mb-4' },
                    e(Message, {
                        type: message.type,
                        message: message.text,
                        onClose: () => setMessage(null)
                    })
                ),

                // Student Information Panel
                e('div', { className: 'grid grid-cols-1 lg:grid-cols-2 gap-6' },
                    // Basic Information
                    e('div', { className: 'bg-white rounded-lg shadow-sm border p-6' },
                        e('div', { className: 'flex items-center mb-6' },
                            e('div', { className: 'w-16 h-16 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center text-white font-bold text-xl mr-4' },
                                `${(student.FirstName || '').charAt(0)}${(student.Lastname || '').charAt(0)}`.toUpperCase()
                            ),
                            e('div', null,
                                e('h2', { className: 'text-xl font-bold text-gray-900' }, 
                                    `${student.FirstName || 'Unknown'} ${student.Lastname || 'Student'}`
                                ),
                                student.StudentStatus && e('span', { 
                                    className: `inline-block px-2 py-1 text-xs rounded-full mt-1 ${
                                        student.StudentStatus === 'Active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'
                                    }`
                                }, student.StudentStatus)
                            )
                        ),
                        e('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4' },
                            e('div', { className: 'space-y-4' },
                                e('div', null,
                                    e('div', { className: 'flex items-center mb-1' },
                                        e('svg', { className: 'w-4 h-4 text-gray-500 mr-2', fill: 'currentColor', viewBox: '0 0 20 20' },
                                            e('path', { d: 'M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z' }),
                                            e('path', { d: 'M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z' })
                                        ),
                                        e('label', { className: 'text-xs font-semibold text-gray-600 uppercase tracking-wide' }, 'Email')
                                    ),
                                    e('p', { className: 'text-sm text-gray-900 pl-6' }, student.PrimaryEmail || 'Not provided')
                                ),
                                e('div', null,
                                    e('div', { className: 'flex items-center mb-1' },
                                        e('svg', { className: 'w-4 h-4 text-gray-500 mr-2', fill: 'currentColor', viewBox: '0 0 20 20' },
                                            e('path', { d: 'M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z' })
                                        ),
                                        e('label', { className: 'text-xs font-semibold text-gray-600 uppercase tracking-wide' }, 'Phone')
                                    ),
                                    e('p', { className: 'text-sm text-gray-900 pl-6' }, student.PrimaryPhone || 'Not provided')
                                )
                            ),
                            e('div', { className: 'space-y-4' },
                                e('div', null,
                                    e('div', { className: 'flex items-center mb-1' },
                                        e('svg', { className: 'w-4 h-4 text-gray-500 mr-2', fill: 'currentColor', viewBox: '0 0 20 20' },
                                            e('path', { fillRule: 'evenodd', d: 'M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z', clipRule: 'evenodd' })
                                        ),
                                        e('label', { className: 'text-xs font-semibold text-gray-600 uppercase tracking-wide' }, 'Birthday')
                                    ),
                                    e('p', { className: 'text-sm text-gray-900 pl-6' }, 
                                        student.Birthday ? new Date(student.Birthday).toLocaleDateString() : 'Not provided'
                                    )
                                ),
                                student.EnrollmentDate && e('div', null,
                                    e('div', { className: 'flex items-center mb-1' },
                                        e('svg', { className: 'w-4 h-4 text-gray-500 mr-2', fill: 'currentColor', viewBox: '0 0 20 20' },
                                            e('path', { fillRule: 'evenodd', d: 'M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z', clipRule: 'evenodd' })
                                        ),
                                        e('label', { className: 'text-xs font-semibold text-gray-600 uppercase tracking-wide' }, 'Student Since')
                                    ),
                                    e('p', { className: 'text-sm text-gray-900 pl-6' }, 
                                        new Date(student.EnrollmentDate).toLocaleDateString()
                                    )
                                )
                            )
                        ),
                        student.CurrentLevel && e('div', { className: 'mt-6 pt-4 border-t border-gray-200' },
                            e('div', { className: 'flex items-center justify-between' },
                                e('span', { className: 'text-sm font-semibold text-gray-600' }, 'Current Level'),
                                e('span', { className: 'px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium' }, 
                                    `Level ${student.CurrentLevel}`
                                )
                            )
                        )
                    ),
                    
                    // Quick Stats Card
                    e('div', { className: 'bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg shadow-sm border border-blue-100 p-6' },
                        e('h2', { className: 'text-lg font-semibold text-gray-900 mb-4' }, 'Student Stats'),
                        e('div', { className: 'space-y-4' },
                            e('div', { className: 'bg-white rounded-lg p-4 shadow-sm' },
                                e('div', { className: 'flex items-center justify-between' },
                                    e('div', null,
                                        e('p', { className: 'text-xs font-medium text-gray-600 uppercase tracking-wide' }, 'Total Enrollments'),
                                        e('p', { className: 'text-2xl font-bold text-gray-900 mt-1' }, 
                                            student.Enrollments ? student.Enrollments.length : 0
                                        )
                                    ),
                                    e('div', { className: 'w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center' },
                                        e('svg', { className: 'w-6 h-6 text-blue-600', fill: 'currentColor', viewBox: '0 0 20 20' },
                                            e('path', { d: 'M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3zM3.31 9.397L5 10.12v4.102a8.969 8.969 0 00-1.05-.174 1 1 0 01-.89-.89 11.115 11.115 0 01.25-3.762zM9.3 16.573A9.026 9.026 0 007 14.935v-3.957l1.818.78a3 3 0 002.364 0l5.508-2.361a11.026 11.026 0 01.25 3.762 1 1 0 01-.89.89 8.968 8.968 0 00-5.35 2.524 1 1 0 01-1.4 0zM6 18a1 1 0 001-1v-2.065a8.935 8.935 0 00-2-.712V17a1 1 0 001 1z' })
                                        )
                                    )
                                )
                            ),
                            student.Enrollments && e('div', { className: 'bg-white rounded-lg p-4 shadow-sm' },
                                e('div', { className: 'flex items-center justify-between' },
                                    e('div', null,
                                        e('p', { className: 'text-xs font-medium text-gray-600 uppercase tracking-wide' }, 'Completed Classes'),
                                        e('p', { className: 'text-2xl font-bold text-green-600 mt-1' }, 
                                            student.Enrollments.filter(e => e.CompletionStatus === 'Completed').length
                                        )
                                    ),
                                    e('div', { className: 'w-12 h-12 bg-green-100 rounded-full flex items-center justify-center' },
                                        e('svg', { className: 'w-6 h-6 text-green-600', fill: 'currentColor', viewBox: '0 0 20 20' },
                                            e('path', { fillRule: 'evenodd', d: 'M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z', clipRule: 'evenodd' })
                                        )
                                    )
                                )
                            ),
                            student.Enrollments && e('div', { className: 'bg-white rounded-lg p-4 shadow-sm' },
                                e('div', { className: 'flex items-center justify-between' },
                                    e('div', null,
                                        e('p', { className: 'text-xs font-medium text-gray-600 uppercase tracking-wide' }, 'Active Classes'),
                                        e('p', { className: 'text-2xl font-bold text-blue-600 mt-1' }, 
                                            student.Enrollments.filter(e => 
                                                e.CompletionStatus === 'Active' || 
                                                e.CompletionStatus === 'In Progress' || 
                                                e.CompletionStatus === 'Enrolled'
                                            ).length
                                        )
                                    ),
                                    e('div', { className: 'w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center' },
                                        e('svg', { className: 'w-6 h-6 text-blue-600', fill: 'currentColor', viewBox: '0 0 20 20' },
                                            e('path', { fillRule: 'evenodd', d: 'M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z', clipRule: 'evenodd' })
                                        )
                                    )
                                )
                            )
                        )
                    )
                ),

                // Enrollment History
                student.Enrollments && student.Enrollments.length > 0 && e('div', { className: 'mt-6 bg-white rounded-lg shadow-sm border p-6' },
                    e('div', { className: 'flex items-center justify-between mb-6' },
                        e('h2', { className: 'text-xl font-bold text-gray-900' }, 'Enrollment History'),
                        e('span', { className: 'text-sm text-gray-600 bg-gray-100 px-3 py-1 rounded-full' }, 
                            `${student.Enrollments.length} total enrollment${student.Enrollments.length !== 1 ? 's' : ''}`
                        )
                    ),
                    e('div', { className: 'overflow-x-auto' },
                        e('table', { className: 'min-w-full' },
                            e('thead', null,
                                e('tr', { className: 'border-b-2 border-gray-200' },
                                    e('th', { className: 'px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider' }, 'Class Level'),
                                    e('th', { className: 'px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider' }, 'Instructor'),
                                    e('th', { className: 'px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider' }, 'Enrolled'),
                                    e('th', { className: 'px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider' }, 'Completed'),
                                    e('th', { className: 'px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider' }, 'Status')
                                )
                            ),
                            e('tbody', { className: 'divide-y divide-gray-200' },
                                student.Enrollments
                                    .sort((a, b) => {
                                        // Sort by enrollment date descending (newest first)
                                        const dateA = a.EnrollmentDate ? new Date(a.EnrollmentDate) : new Date(0);
                                        const dateB = b.EnrollmentDate ? new Date(b.EnrollmentDate) : new Date(0);
                                        return dateB - dateA;
                                    })
                                    .map((enrollment, index) =>
                                    e('tr', { 
                                        key: index,
                                        className: 'hover:bg-gray-50 transition-colors'
                                    },
                                        e('td', { className: 'px-6 py-4' }, 
                                            e('div', { className: 'flex items-center' },
                                                e('div', { 
                                                    className: `w-2 h-2 rounded-full mr-3 ${
                                                        enrollment.CompletionStatus === 'Completed' ? 'bg-blue-500' :
                                                        enrollment.CompletionStatus === 'In Progress' || enrollment.CompletionStatus === 'Active' ? 'bg-green-500' :
                                                        enrollment.CompletionStatus === 'Dropped' || enrollment.CompletionStatus === 'Withdrawn' ? 'bg-red-500' :
                                                        'bg-gray-400'
                                                    }`
                                                }),
                                                e('span', { className: 'text-sm font-medium text-gray-900' }, 
                                                    enrollment.ClassLevelName || `Offering ${enrollment.OfferingID}`
                                                )
                                            )
                                        ),
                                        e('td', { className: 'px-6 py-4 text-sm text-gray-600' }, 
                                            enrollment.TeacherName || e('span', { className: 'italic text-gray-400' }, 'N/A')
                                        ),
                                        e('td', { className: 'px-6 py-4 text-sm text-gray-600' }, 
                                            enrollment.EnrollmentDate ? new Date(enrollment.EnrollmentDate).toLocaleDateString('en-US', { 
                                                month: 'short', 
                                                day: 'numeric', 
                                                year: 'numeric' 
                                            }) : e('span', { className: 'italic text-gray-400' }, 'Unknown')
                                        ),
                                        e('td', { className: 'px-6 py-4 text-sm text-gray-600' }, 
                                            enrollment.CompletionDate ? new Date(enrollment.CompletionDate).toLocaleDateString('en-US', { 
                                                month: 'short', 
                                                day: 'numeric', 
                                                year: 'numeric' 
                                            }) : e('span', { className: 'text-gray-400' }, '—')
                                        ),
                                        e('td', { className: 'px-6 py-4' },
                                            e('span', { 
                                                className: `inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                                                    enrollment.CompletionStatus === 'Completed' ? 'bg-blue-100 text-blue-800' :
                                                    enrollment.CompletionStatus === 'In Progress' || enrollment.CompletionStatus === 'Active' ? 'bg-green-100 text-green-800' :
                                                    enrollment.CompletionStatus === 'Dropped' || enrollment.CompletionStatus === 'Withdrawn' ? 'bg-red-100 text-red-800' :
                                                    'bg-gray-100 text-gray-800'
                                                }`
                                            }, enrollment.CompletionStatus || enrollment.Status || 'Unknown')
                                        )
                                    )
                                )
                            )
                        )
                    )
                )
            );
        }

        // CastCard Component
        function CastCard({ castMember, onClick }) {
            const getInitials = (firstName, lastName) => {
                const first = (firstName || '').trim();
                const last = (lastName || '').trim();
                const firstInitial = first.length > 0 ? first.charAt(0) : '';
                const lastInitial = last.length > 0 ? last.charAt(0) : '';
                return `${firstInitial}${lastInitial}`.toUpperCase() || '??';
            };

            const formatDate = (dateString) => {
                if (!dateString) return 'TBD';
                try {
                    return new Date(dateString).toLocaleDateString();
                } catch {
                    return dateString;
                }
            };

            return e('div', {
                onClick: onClick,
                className: 'bg-white rounded-lg shadow-sm border p-4 hover:shadow-md transition-shadow cursor-pointer'
            },
                e('div', { className: 'flex items-center space-x-3 mb-3' },
                    e('div', { className: 'w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center text-purple-700 font-semibold' },
                        getInitials(castMember.FirstName, castMember.Lastname)
                    ),
                    e('div', { className: 'flex-1' },
                        e('h3', { className: 'font-semibold text-gray-900' }, 
                            `${castMember.FirstName || ''} ${castMember.Lastname || ''}`.trim() || 'Unknown Name'
                        ),
                        e('p', { className: 'text-sm text-gray-600' }, castMember.PrimaryEmail || 'No email')
                    )
                ),
                e('div', { className: 'space-y-1 text-sm text-gray-600' },
                    e('p', null, `Last Show: ${formatDate(castMember.LastShowDate)}`),
                    e('p', null, `Phone: ${castMember.PrimaryPhone || 'No phone'}`),
                    e('p', null, `Birthday: ${formatDate(castMember.Birthday)}`),
                    castMember.Status && e('span', { 
                        className: `inline-block px-2 py-1 text-xs rounded-full ${
                            castMember.Status === 'Active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                        }`
                    }, castMember.Status)
                )
            );
        }

        // PersonnelModal Component - FIXED VERSION
        function PersonnelModal({ isOpen, mode, person, onClose, onSave, onEdit, onDelete }) {
            const [formData, setFormData] = useState({
                FirstName: '',
                Lastname: '',
                PrimaryEmail: '',
                PrimaryPhone: '',
                Instagram: '',
                Birthday: ''
            });
            const [isLoading, setIsLoading] = useState(false); // FIXED: Added missing isLoading state

            useEffect(() => {
                if (person) {
                    setFormData(person);
                } else {
                    setFormData({
                        FirstName: '',
                        Lastname: '',
                        PrimaryEmail: '',
                        PrimaryPhone: '',
                        Instagram: '',
                        Birthday: ''
                    });
                }
            }, [person, isOpen]);

            const handleInputChange = (field, value) => {
                setFormData(prev => ({ ...prev, [field]: value }));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsLoading(true);
                
                try {
                    await onSave(formData);
                    onClose();
                } catch (error) {
                    console.error('Error saving personnel:', error);
                } finally {
                    setIsLoading(false);
                }
            };

            if (!isOpen) return null;

            const isEditable = mode === 'edit' || mode === 'create';
            const title = mode === 'create' ? 'Add New Personnel' : 
                         mode === 'edit' ? 'Edit Personnel' : 'Personnel Details';

            return e('div', { className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50' },
                e('div', { className: 'bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto' },
                    e('div', { className: 'flex justify-between items-center mb-6' },
                        e('h2', { className: 'text-xl font-semibold text-gray-900' }, title),
                        e('button', {
                            onClick: onClose,
                            className: 'text-gray-400 hover:text-gray-600 text-xl'
                        }, '×')
                    ),

                    isLoading ? e(Loader) : 
                    e('form', { onSubmit: handleSubmit },
                        e('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4 mb-6' },
                            // First Name
                            e('div', null,
                                e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'First Name'),
                                isEditable ? 
                                e('input', {
                                    type: 'text',
                                    value: formData.FirstName || '',
                                    onChange: (e) => handleInputChange('FirstName', e.target.value),
                                    className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent',
                                    required: true
                                }) :
                                e('p', { className: 'py-2 text-gray-900' }, formData.FirstName)
                            ),
                            
                            // Last Name
                            e('div', null,
                                e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Last Name'),
                                isEditable ? 
                                e('input', {
                                    type: 'text',
                                    value: formData.Lastname || '',
                                    onChange: (e) => handleInputChange('Lastname', e.target.value),
                                    className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent',
                                    required: true
                                }) :
                                e('p', { className: 'py-2 text-gray-900' }, formData.Lastname)
                            ),

                            // Email
                            e('div', null,
                                e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Email'),
                                isEditable ? 
                                e('input', {
                                    type: 'email',
                                    value: formData.PrimaryEmail || '',
                                    onChange: (e) => handleInputChange('PrimaryEmail', e.target.value),
                                    className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent',
                                    required: true
                                }) :
                                e('p', { className: 'py-2 text-gray-900' }, formData.PrimaryEmail)
                            ),

                            // Phone
                            e('div', null,
                                e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Phone'),
                                isEditable ? 
                                e('input', {
                                    type: 'tel',
                                    value: formData.PrimaryPhone || '',
                                    onChange: (e) => handleInputChange('PrimaryPhone', e.target.value),
                                    className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent'
                                }) :
                                e('p', { className: 'py-2 text-gray-900' }, formData.PrimaryPhone)
                            ),

                            // Instagram
                            e('div', null,
                                e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Instagram'),
                                isEditable ? 
                                e('input', {
                                    type: 'text',
                                    value: formData.Instagram || '',
                                    onChange: (e) => handleInputChange('Instagram', e.target.value),
                                    className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent',
                                    placeholder: '@username'
                                }) :
                                e('p', { className: 'py-2 text-gray-900' }, formData.Instagram)
                            ),

                            // Birthday
                            e('div', null,
                                e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Birthday'),
                                isEditable ? 
                                e('input', {
                                    type: 'date',
                                    value: formData.Birthday ? formData.Birthday.toString().split('T')[0] : '',
                                    onChange: (e) => handleInputChange('Birthday', e.target.value),
                                    className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent'
                                }) :
                                e('p', { className: 'py-2 text-gray-900' }, 
                                    formData.Birthday ? new Date(formData.Birthday).toLocaleDateString() : ''
                                )
                            )
                        ),

                        e('div', { className: 'flex justify-end space-x-3' },
                            e('button', {
                                type: 'button',
                                onClick: onClose,
                                className: 'px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors'
                            }, mode === 'view' ? 'Close' : 'Cancel'),
                            
                            // Edit and Delete buttons for view mode
                            mode === 'view' && person && [
                                e('button', {
                                    key: 'edit',
                                    type: 'button',
                                    onClick: onEdit,
                                    className: 'px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors'
                                }, 'Edit'),
                                e('button', {
                                    key: 'delete',
                                    type: 'button',
                                    onClick: onDelete,
                                    className: 'px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors'
                                }, 'Delete')
                            ],
                            
                            isEditable && e('button', {
                                type: 'submit',
                                disabled: isLoading,
                                className: 'px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors disabled:opacity-50'
                            }, mode === 'create' ? 'Create' : 'Save Changes')
                        )
                    )
                )
            );
        }

        // Dashboard Component
        // READS FROM: Multiple Google Sheets via getDashboardStats()
        // DATA SOURCES: Personnel, ShowInformation, ClassOfferings, StudentEnrollments sheets
        function Dashboard() {
            const [stats, setStats] = useState(null);
            const [isLoading, setIsLoading] = useState(true);

            useEffect(() => {
                loadDashboardData();
            }, []);

            const loadDashboardData = async () => {
                try {
                    // READ: Fetch aggregated statistics from multiple Google Sheets
                    // Data comes from: Personnel, ShowInformation, ClassOfferings, StudentEnrollments
                    const response = await gasService.getDashboardStats();
                    if (response.success && response.data) {
                        setStats(response.data);
                    }
                } catch (error) {
                    console.error('Error loading dashboard data:', error);
                } finally {
                    setIsLoading(false);
                }
            };

            if (isLoading) {
                return e(Loader, { text: 'Loading dashboard...' });
            }

            if (!stats) {
                return e('div', { className: 'p-6' },
                    e('h1', { className: 'text-2xl font-bold text-gray-900 mb-6' }, 'Dashboard'),
                    e('p', { className: 'text-gray-600' }, 'Unable to load dashboard data.')
                );
            }

            return e('div', { className: 'p-6' },
                e('h1', { className: 'text-2xl font-bold text-gray-900 mb-6' }, 'Dashboard'),
                
                e('div', { className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8' },
                    e(StatCard, {
                        title: 'Total Personnel',
                        value: stats.totalPersonnel,
                        icon: '👥',
                        color: 'blue'
                    }),
                    e(StatCard, {
                        title: 'Active Students',
                        value: stats.activeStudents,
                        icon: '🎭',
                        color: 'green'
                    }),
                    e(StatCard, {
                        title: 'Upcoming Shows',
                        value: stats.upcomingShows,
                        icon: '🎪',
                        color: 'purple'
                    }),
                    e(StatCard, {
                        title: 'Active Classes',
                        value: stats.activeClasses,
                        icon: '📚',
                        color: 'orange'
                    })
                ),

                e('div', { className: 'grid grid-cols-1 lg:grid-cols-2 gap-6' },
                    e('div', { className: 'bg-white rounded-lg shadow-sm border p-6' },
                        e('h2', { className: 'text-lg font-semibold text-gray-900 mb-4' }, 'Recent Activity'),
                        e('p', { className: 'text-gray-600' }, 'Dashboard activity feed coming soon...')
                    ),
                    e('div', { className: 'bg-white rounded-lg shadow-sm border p-6' },
                        e('h2', { className: 'text-lg font-semibold text-gray-900 mb-4' }, 'Quick Actions'),
                        e('div', { className: 'space-y-2' },
                            e('button', { className: 'w-full px-4 py-2 text-left bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors' }, 'Add New Person'),
                            e('button', { className: 'w-full px-4 py-2 text-left bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors' }, 'Schedule Show'),
                            e('button', { className: 'w-full px-4 py-2 text-left bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors' }, 'Create Class')
                        )
                    )
                )
            );
        }

        // PersonnelDirectory Component
        // FULL CRUD OPERATIONS: Create, Read, Update, Delete personnel records
        // DATA SOURCE: Personnel sheet (PersonnelID, FirstName, Lastname, PrimaryEmail, etc.)
        function PersonnelDirectory() {
            const [personnel, setPersonnel] = useState([]);
            const [filteredPersonnel, setFilteredPersonnel] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedPerson, setSelectedPerson] = useState(null);
            const [modalMode, setModalMode] = useState('view');
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [message, setMessage] = useState(null);

            useEffect(() => {
                loadPersonnel();
            }, []);

            useEffect(() => {
                const filtered = personnel.filter(person =>
                    `${person.FirstName} ${person.Lastname}`.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    person.PrimaryEmail.toLowerCase().includes(searchTerm.toLowerCase())
                );
                setFilteredPersonnel(filtered);
            }, [personnel, searchTerm]);

            const loadPersonnel = async () => {
                setIsLoading(true);
                console.log('Loading personnel...');
                console.log('isDevelopment:', isDevelopment);
                console.log('gasService:', gasService);
                
                try {
                    // STEP 1: First run debug function to test connection
                    console.log('=== RUNNING DEBUG TEST ===');
                    const debugResponse = await gasService.debugPersonnelSheet();
                    console.log('Debug response:', debugResponse);
                    
                    if (debugResponse && !debugResponse.success) {
                        setMessage({ 
                            type: 'error', 
                            text: `Debug failed: ${debugResponse.error}. Available sheets: ${debugResponse.availableSheets?.join(', ') || 'unknown'}` 
                        });
                        return;
                    }
                    
                    if (debugResponse && debugResponse.success) {
                        console.log('✓ Debug test passed! Sheet details:', {
                            dimensions: debugResponse.dimensions,
                            headers: debugResponse.headers,
                            sampleData: debugResponse.sampleData
                        });
                    }
                    
                    // STEP 2: Now try the regular getAllPersonnel function
                    console.log('=== RUNNING REGULAR getAllPersonnel ===');
                    const response = await gasService.getAllPersonnel();
                    console.log('Personnel response:', response);
                    console.log('Response type:', typeof response);
                    console.log('Response.success:', response.success);
                    console.log('Response.data:', response.data);
                    
                    if (response && response.success && response.data) {
                        setPersonnel(response.data);
                        console.log('Personnel data loaded:', response.data.length, 'records');
                    } else {
                        console.error('Personnel loading failed. Full response:', response);
                        let errorMsg = 'Failed to load personnel from Google Sheets';
                        
                        if (response && response.success && response.data === null) {
                            errorMsg = 'getAllPersonnel returned null. Check the getAllPersonnel function in Code.gs for errors.';
                        } else if (response && !response.success) {
                            errorMsg = `Google Apps Script error: ${response.error}`;
                        }
                        
                        setMessage({ type: 'error', text: errorMsg });
                    }
                } catch (error) {
                    console.error('Personnel loading error:', error);
                    console.error('Error stack:', error.stack);
                    setMessage({ type: 'error', text: 'Error loading personnel data: ' + error.message });
                } finally {
                    setIsLoading(false);
                }
            };

            const handlePersonClick = (person) => {
                setSelectedPerson(person);
                setModalMode('view');
                setIsModalOpen(true);
            };

            const handleAddNew = () => {
                setSelectedPerson(null);
                setModalMode('create');
                setIsModalOpen(true);
            };

            const handleSavePerson = async (personData) => {
                try {
                    let response;
                    if (modalMode === 'create') {
                        // CREATE: Add new person to Personnel sheet with auto-generated PersonnelID
                        response = await gasService.createPersonnel(personData);
                    } else {
                        // UPDATE: Modify existing person in Personnel sheet by PersonnelID
                        response = await gasService.updatePersonnel(personData);
                    }

                    if (response.success) {
                        setMessage({ 
                            type: 'success', 
                            text: modalMode === 'create' ? 'Personnel created successfully' : 'Personnel updated successfully'
                        });
                        // Reload personnel list to show changes
                        loadPersonnel();
                    } else {
                        setMessage({ type: 'error', text: response.error || 'Failed to save personnel' });
                    }
                } catch (error) {
                    setMessage({ type: 'error', text: 'Error saving personnel' });
                }
            };

            const handleCloseModal = () => {
                setIsModalOpen(false);
                setSelectedPerson(null);
            };

            const handleEditPerson = () => {
                setModalMode('edit');
            };

            const handleDeletePerson = async () => {
                if (selectedPerson) {
                    const confirmDelete = confirm(`Are you sure you want to delete ${selectedPerson.FirstName} ${selectedPerson.Lastname}? This action cannot be undone.`);
                    if (confirmDelete) {
                        try {
                            const response = await gasService.deletePersonnel(selectedPerson.PersonnelID);
                            if (response.success) {
                                setMessage({ type: 'success', text: 'Personnel deleted successfully' });
                                // Reload personnel list to show changes
                                loadPersonnel();
                                // Close modal
                                setIsModalOpen(false);
                                setSelectedPerson(null);
                            } else {
                                setMessage({ type: 'error', text: response.error || 'Failed to delete personnel' });
                            }
                        } catch (error) {
                            setMessage({ type: 'error', text: 'Error deleting personnel' });
                        }
                    }
                }
            };

            return e('div', { className: 'p-6' },
                e('div', { className: 'flex justify-between items-center mb-6' },
                    e('h1', { className: 'text-2xl font-bold text-gray-900' }, 'Personnel Directory'),
                    e('button', {
                        onClick: handleAddNew,
                        className: 'px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors'
                    }, 'Add New Person')
                ),

                message && e('div', { className: 'mb-4' },
                    e(Message, {
                        type: message.type,
                        message: message.text,
                        onClose: () => setMessage(null)
                    })
                ),

                e('div', { className: 'mb-6' },
                    e('input', {
                        type: 'text',
                        placeholder: 'Search by name or email...',
                        value: searchTerm,
                        onChange: (e) => setSearchTerm(e.target.value),
                        className: 'w-full max-w-md px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent'
                    })
                ),

                isLoading ? e(Loader, { text: 'Loading personnel...' }) :
                e('div', { className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4' },
                    filteredPersonnel.map((person) =>
                        e(PersonCard, {
                            key: person.PersonnelID,
                            person: person,
                            onClick: () => handlePersonClick(person)
                        })
                    )
                ),

                e(PersonnelModal, {
                    isOpen: isModalOpen,
                    mode: modalMode,
                    person: selectedPerson,
                    onClose: handleCloseModal,
                    onSave: handleSavePerson,
                    onEdit: handleEditPerson,
                    onDelete: handleDeletePerson
                })
            );
        }

        // Cast Directory Component
        // READS FROM: ShowPerformances, Personnel, and ShowInformation sheets via getAllCastMembers()
        function CastDirectory() {
            const [castMembers, setCastMembers] = useState([]);
            const [filteredCastMembers, setFilteredCastMembers] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedCastMember, setSelectedCastMember] = useState(null);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [message, setMessage] = useState(null);

            useEffect(() => {
                loadCastMembers();
            }, []);

            useEffect(() => {
                const filtered = castMembers.filter(member =>
                    `${member.FirstName || ''} ${member.Lastname || ''}`.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    (member.PrimaryEmail || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
                    (member.PrimaryPhone || '').toLowerCase().includes(searchTerm.toLowerCase())
                );
                setFilteredCastMembers(filtered);
            }, [castMembers, searchTerm]);

            const loadCastMembers = async () => {
                setIsLoading(true);
                try {
                    const response = await gasService.getAllCastMembers();
                    if (response.success && response.data && response.data.data) {
                        setCastMembers(response.data.data);
                        setMessage(null);
                    } else {
                        setMessage({ type: 'error', text: response.error || 'Failed to load cast members' });
                    }
                } catch (error) {
                    setMessage({ type: 'error', text: 'Error loading cast member data' });
                } finally {
                    setIsLoading(false);
                }
            };

            const handleCastMemberClick = (castMember) => {
                setSelectedCastMember(castMember);
                setIsModalOpen(true);
            };

            const handleCloseModal = () => {
                setIsModalOpen(false);
                setSelectedCastMember(null);
            };

            return e('div', { className: 'p-6' },
                e('div', { className: 'flex justify-between items-center mb-6' },
                    e('h1', { className: 'text-2xl font-bold text-gray-900' }, 'Cast Directory'),
                    e('p', { className: 'text-sm text-gray-600' }, `${filteredCastMembers.length} cast assignments`)
                ),

                message && e('div', { className: 'mb-4' },
                    e(Message, {
                        type: message.type,
                        message: message.text,
                        onClose: () => setMessage(null)
                    })
                ),

                e('div', { className: 'mb-6' },
                    e('input', {
                        type: 'text',
                        placeholder: 'Search by name, email, or phone...',
                        value: searchTerm,
                        onChange: (e) => setSearchTerm(e.target.value),
                        className: 'w-full max-w-md px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent'
                    })
                ),

                isLoading ? e(Loader, { text: 'Loading cast members...' }) :
                message && message.type === 'error' ? (
                    e('div', { className: 'mb-4' },
                        e(Message, {
                            type: 'error',
                            message: message.text,
                            onClose: () => setMessage(null)
                        }),
                        e('button', {
                            onClick: loadCastMembers,
                            className: 'mt-2 px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors'
                        }, 'Retry')
                    )
                ) : filteredCastMembers.length === 0 ? (
                    e('div', { className: 'text-center text-gray-500 mt-8' },
                        e('p', null, 'No cast members found.'),
                        e('button', {
                            onClick: loadCastMembers,
                            className: 'mt-2 px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors'
                        }, 'Reload')
                    )
                ) : (
                    e('div', { className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4' },
                        filteredCastMembers.map((castMember) =>
                            e(CastCard, {
                                key: `${castMember.PerformanceID}-${castMember.CastMemberID}`,
                                castMember: castMember,
                                onClick: () => handleCastMemberClick(castMember)
                            })
                        )
                    )
                ),

                // Simple cast member detail modal (view only for now)
                selectedCastMember && e('div', { 
                    className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50',
                    onClick: handleCloseModal
                },
                    e('div', { 
                        className: 'bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto',
                        onClick: (e) => e.stopPropagation()
                    },
                        e('div', { className: 'flex justify-between items-center mb-6' },
                            e('h2', { className: 'text-xl font-semibold text-gray-900' }, 'Cast Member Details'),
                            e('button', {
                                onClick: handleCloseModal,
                                className: 'text-gray-400 hover:text-gray-600 text-xl'
                            }, '×')
                        ),
                        e('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4 mb-6' },
                            e('div', null,
                                e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Name'),
                                e('p', { className: 'text-gray-900' }, `${selectedCastMember.FirstName || ''} ${selectedCastMember.Lastname || ''}`.trim() || 'Unknown')
                            ),
                            e('div', null,
                                e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Last Show Date'),
                                e('p', { className: 'text-gray-900' }, selectedCastMember.LastShowDate && selectedCastMember.LastShowDate !== 'N/A' ? new Date(selectedCastMember.LastShowDate).toLocaleDateString() : 'N/A')
                            ),
                            e('div', null,
                                e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Birthday'),
                                e('p', { className: 'text-gray-900' }, selectedCastMember.Birthday ? new Date(selectedCastMember.Birthday).toLocaleDateString() : 'Not available')
                            ),
                            e('div', null,
                                e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Status'),
                                e('span', { 
                                    className: `inline-block px-2 py-1 text-xs rounded-full ${
                                        selectedCastMember.Status === 'Active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                                    }`
                                }, selectedCastMember.Status || 'Unknown')
                            ),
                            e('div', null,
                                e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Email'),
                                e('p', { className: 'text-gray-900' }, selectedCastMember.PrimaryEmail || 'Not available')
                            ),
                            e('div', null,
                                e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Phone'),
                                e('p', { className: 'text-gray-900' }, selectedCastMember.PrimaryPhone || 'Not available')
                            )
                        ),
                        e('div', { className: 'flex justify-end' },
                            e('button', {
                                onClick: handleCloseModal,
                                className: 'px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors'
                            }, 'Close')
                        )
                    )
                )
            );
        }

        // Sidebar Component
        function Sidebar({ currentPage, onNavigate }) {
            const navigationItems = [
                { id: 'dashboard', label: 'Dashboard', icon: '📊' },
                { id: 'personnel', label: 'Personnel', icon: '👥' },
                { id: 'student-directory', label: 'Students', icon: '🎓' },
                { id: 'cast', label: 'Cast', icon: '🎭' },
                { id: 'classes', label: 'Classes', icon: '📚' },
                { id: 'shows', label: 'Shows', icon: '🎬' },
                { id: 'inventory', label: 'Inventory', icon: '📦' },
                { id: 'scheduling', label: 'Schedule', icon: '📅' }
            ];

            return e('div', { className: 'bg-white shadow-sm border-r h-full w-64 flex flex-col' },
                e('div', { className: 'p-6 border-b' },
                    e('h1', { className: 'text-xl font-bold text-gray-900' }, 'JTF Portal'),
                    e('p', { className: 'text-sm text-gray-600' }, 'Team Management'),
                    e('p', { className: 'text-xs text-gray-400 mt-1' }, 'v1.0.1 - Updated from VS Code')
                ),
                
                e('nav', { className: 'flex-1 p-4' },
                    e('ul', { className: 'space-y-2' },
                        navigationItems.map((item) =>
                            e('li', { key: item.id },
                                e('button', {
                                    onClick: () => onNavigate(item.id),
                                    className: `w-full flex items-center space-x-3 px-3 py-2 rounded-lg text-left transition-colors ${
                                        currentPage === item.id
                                            ? 'bg-primary-100 text-primary-700'
                                            : 'text-gray-700 hover:bg-gray-100'
                                    }`
                                },
                                    e('span', { className: 'text-lg' }, item.icon),
                                    e('span', { className: 'font-medium' }, item.label)
                                )
                            )
                        )
                    )
                ),
                
                e('div', { className: 'p-4 border-t' },
                    e('p', { className: 'text-xs text-gray-500' }, '© 2024 JTF Team Portal')
                )
            );
        }

        // Class Registration / Management Component
        function ClassRegistration() {
            const [classes, setClasses] = useState([]);
            const [filteredClasses, setFilteredClasses] = useState([]);
            const [filter, setFilter] = useState('all');
            const [searchTerm, setSearchTerm] = useState('');
            const [isLoading, setIsLoading] = useState(true);
            const [message, setMessage] = useState(null);
            const [showNewClassModal, setShowNewClassModal] = useState(false);

            useEffect(() => {
                loadClasses();
            }, []);

            useEffect(() => {
                applyFilters();
            }, [classes, filter, searchTerm]);

            const loadClasses = async () => {
                setIsLoading(true);
                try {
                    const response = await gasService.getAllClassOfferings();
                    console.log('getAllClassOfferings response:', response);

                    if (response.success && response.data) {
                        setClasses(response.data);
                    } else {
                        setMessage({ type: 'error', text: response.error || 'Failed to load classes' });
                    }
                } catch (error) {
                    console.error('Error loading classes:', error);
                    setMessage({ type: 'error', text: 'Error loading classes' });
                } finally {
                    setIsLoading(false);
                }
            };

            const applyFilters = () => {
                let filtered = [...classes];

                // Apply status filter
                if (filter !== 'all') {
                    const statusMap = {
                        'all': '',
                        'upcoming': 'Upcoming',
                        'in-progress': 'In Progress',
                        'completed': 'Completed'
                    };
                    filtered = filtered.filter(c => c.Status === statusMap[filter]);
                }

                // Apply search filter
                if (searchTerm) {
                    filtered = filtered.filter(c =>
                        (c.LevelName && c.LevelName.toLowerCase().includes(searchTerm.toLowerCase())) ||
                        (c.TeacherName && c.TeacherName.toLowerCase().includes(searchTerm.toLowerCase())) ||
                        (c.Location && c.Location.toLowerCase().includes(searchTerm.toLowerCase()))
                    );
                }

                setFilteredClasses(filtered);
            };

            const getFilterCount = (filterType) => {
                if (filterType === 'all') return classes.length;
                const statusMap = {
                    'upcoming': 'Upcoming',
                    'in-progress': 'In Progress',
                    'completed': 'Completed'
                };
                return classes.filter(c => c.Status === statusMap[filterType]).length;
            };

            const handleManageClass = (offeringId) => {
                console.log('Navigate to class management:', offeringId);
                setMessage({ type: 'success', text: 'Class management page coming soon!' });
            };

            if (isLoading) {
                return e(Loader, { text: 'Loading classes...' });
            }

            return e('div', { className: 'p-6 max-w-7xl mx-auto' },
                // Header
                e('div', { className: 'mb-6' },
                    e('div', { className: 'flex justify-between items-center mb-4' },
                        e('div', null,
                            e('h1', { className: 'text-3xl font-bold text-gray-900' }, 'Class Management'),
                            e('p', { className: 'text-gray-600 mt-1' }, 'Manage class offerings, rosters, and attendance')
                        ),
                        e('button', {
                            onClick: () => setShowNewClassModal(true),
                            className: 'px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2'
                        },
                            e('svg', { className: 'w-5 h-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                                e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M12 4v16m8-8H4' })
                            ),
                            'New Class'
                        )
                    ),
                    message && e(Message, {
                        type: message.type,
                        message: message.text,
                        onClose: () => setMessage(null)
                    })
                ),

                // Filters
                e('div', { className: 'mb-6 space-y-4' },
                    e('div', { className: 'flex gap-2' },
                        e('button', {
                            onClick: () => setFilter('all'),
                            className: `px-4 py-2 rounded-lg font-medium transition-colors ${
                                filter === 'all'
                                    ? 'bg-blue-600 text-white'
                                    : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-50'
                            }`
                        }, `All Classes (${getFilterCount('all')})`),
                        e('button', {
                            onClick: () => setFilter('upcoming'),
                            className: `px-4 py-2 rounded-lg font-medium transition-colors ${
                                filter === 'upcoming'
                                    ? 'bg-yellow-500 text-white'
                                    : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-50'
                            }`
                        }, `Upcoming (${getFilterCount('upcoming')})`),
                        e('button', {
                            onClick: () => setFilter('in-progress'),
                            className: `px-4 py-2 rounded-lg font-medium transition-colors ${
                                filter === 'in-progress'
                                    ? 'bg-green-600 text-white'
                                    : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-50'
                            }`
                        }, `In Progress (${getFilterCount('in-progress')})`),
                        e('button', {
                            onClick: () => setFilter('completed'),
                            className: `px-4 py-2 rounded-lg font-medium transition-colors ${
                                filter === 'completed'
                                    ? 'bg-blue-600 text-white'
                                    : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-50'
                            }`
                        }, `Completed (${getFilterCount('completed')})`)
                    ),
                    // Search
                    e('div', { className: 'relative' },
                        e('input', {
                            type: 'text',
                            placeholder: 'Search classes by name, teacher, or location...',
                            value: searchTerm,
                            onChange: (ev) => setSearchTerm(ev.target.value),
                            className: 'w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent'
                        }),
                        e('svg', {
                            className: 'absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400',
                            fill: 'none',
                            stroke: 'currentColor',
                            viewBox: '0 0 24 24'
                        },
                            e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z' })
                        )
                    )
                ),

                // Classes Grid
                filteredClasses.length > 0 ? (
                    e('div', { className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6' },
                        filteredClasses.map(classOffering =>
                            e(ClassCard, {
                                key: classOffering.OfferingID,
                                classOffering: classOffering,
                                onManage: () => handleManageClass(classOffering.OfferingID)
                            })
                        )
                    )
                ) : (
                    e('div', { className: 'text-center py-12 bg-white rounded-lg border border-gray-200' },
                        e('svg', {
                            className: 'mx-auto h-12 w-12 text-gray-400',
                            fill: 'none',
                            stroke: 'currentColor',
                            viewBox: '0 0 24 24'
                        },
                            e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z' })
                        ),
                        e('h3', { className: 'mt-2 text-sm font-medium text-gray-900' }, 'No classes found'),
                        e('p', { className: 'mt-1 text-sm text-gray-500' },
                            searchTerm ? 'Try adjusting your search' : 'Get started by creating a new class'
                        ),
                        !searchTerm && e('div', { className: 'mt-6' },
                            e('button', {
                                onClick: () => setShowNewClassModal(true),
                                className: 'inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700'
                            },
                                e('svg', { className: '-ml-1 mr-2 h-5 w-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                                    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M12 4v16m8-8H4' })
                                ),
                                'New Class'
                            )
                        )
                    )
                ),

                // New Class Modal - Placeholder
                showNewClassModal && e('div', { className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50' },
                    e('div', { className: 'bg-white rounded-lg p-6 max-w-md w-full mx-4' },
                        e('h3', { className: 'text-xl font-bold text-gray-900 mb-4' }, 'Create New Class'),
                        e('p', { className: 'text-gray-600 mb-4' }, 'New class creation form coming soon!'),
                        e('button', {
                            onClick: () => setShowNewClassModal(false),
                            className: 'w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors'
                        }, 'Close')
                    )
                )
            );
        }

        // ClassCard Component
        function ClassCard({ classOffering, onManage }) {
            const getStatusColor = (status) => {
                switch (status?.toLowerCase()) {
                    case 'upcoming':
                        return 'bg-yellow-100 text-yellow-800 border-yellow-200';
                    case 'in progress':
                    case 'open':
                        return 'bg-green-100 text-green-800 border-green-200';
                    case 'completed':
                        return 'bg-blue-100 text-blue-800 border-blue-200';
                    case 'cancelled':
                        return 'bg-red-100 text-red-800 border-red-200';
                    default:
                        return 'bg-gray-100 text-gray-800 border-gray-200';
                }
            };

            const formatDate = (dateString) => {
                if (!dateString) return 'TBD';
                try {
                    return new Date(dateString).toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric'
                    });
                } catch {
                    return dateString;
                }
            };

            const enrollmentPercentage = classOffering.MaxStudents 
                ? (classOffering.EnrolledCount / classOffering.MaxStudents) * 100 
                : 0;

            return e('div', {
                onClick: onManage,
                className: 'bg-white rounded-lg shadow-sm border border-gray-200 p-5 hover:shadow-md transition-all cursor-pointer group'
            },
                // Header
                e('div', { className: 'flex items-start justify-between mb-3' },
                    e('div', { className: 'flex-1' },
                        e('h3', { className: 'text-lg font-bold text-gray-900 group-hover:text-primary-600 transition-colors' },
                            classOffering.LevelName || `Level ${classOffering.ClassLevelID}`
                        ),
                        e('p', { className: 'text-sm text-gray-600 mt-1' },
                            e('span', { className: 'inline-flex items-center' },
                                e('svg', { className: 'w-4 h-4 mr-1', fill: 'currentColor', viewBox: '0 0 20 20' },
                                    e('path', { d: 'M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z' })
                                ),
                                classOffering.TeacherName || 'TBA'
                            )
                        )
                    ),
                    e('span', { className: `px-3 py-1 rounded-full text-xs font-medium border ${getStatusColor(classOffering.Status)}` },
                        classOffering.Status
                    )
                ),

                // Schedule
                e('div', { className: 'space-y-2 mb-4' },
                    e('div', { className: 'flex items-center text-sm text-gray-600' },
                        e('svg', { className: 'w-4 h-4 mr-2 text-gray-400', fill: 'currentColor', viewBox: '0 0 20 20' },
                            e('path', { fillRule: 'evenodd', d: 'M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z', clipRule: 'evenodd' })
                        ),
                        e('span', null,
                            `${formatDate(classOffering.StartDate)} - ${formatDate(classOffering.EndDate)}`
                        )
                    ),
                    classOffering.VenueOrRoom && e('div', { className: 'flex items-center text-sm text-gray-600' },
                        e('svg', { className: 'w-4 h-4 mr-2 text-gray-400', fill: 'currentColor', viewBox: '0 0 20 20' },
                            e('path', { fillRule: 'evenodd', d: 'M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z', clipRule: 'evenodd' })
                        ),
                        e('span', null, classOffering.VenueOrRoom)
                    )
                ),

                // Enrollment Progress
                e('div', { className: 'space-y-2' },
                    e('div', { className: 'flex items-center justify-between text-sm' },
                        e('span', { className: 'text-gray-600' }, 'Enrollment'),
                        e('span', { className: 'font-semibold text-gray-900' },
                            `${classOffering.EnrolledCount || 0} / ${classOffering.MaxStudents || 12} students`
                        )
                    ),
                    e('div', { className: 'w-full bg-gray-200 rounded-full h-2' },
                        e('div', {
                            className: `h-2 rounded-full transition-all ${
                                enrollmentPercentage >= 100
                                    ? 'bg-red-500'
                                    : enrollmentPercentage >= 75
                                    ? 'bg-yellow-500'
                                    : 'bg-green-500'
                            }`,
                            style: { width: `${Math.min(enrollmentPercentage, 100)}%` }
                        })
                    )
                ),

                // View Details Link
                e('div', { className: 'mt-4 pt-4 border-t border-gray-100' },
                    e('button', { className: 'text-sm text-primary-600 hover:text-primary-700 font-medium flex items-center group-hover:translate-x-1 transition-transform' },
                        'Manage Class',
                        e('svg', { className: 'w-4 h-4 ml-1', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                            e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M9 5l7 7-7 7' })
                        )
                    )
                )
            );
        }

        // Placeholder Components for other pages

        function Shows() {
            return e('div', { className: 'p-6' },
                e('h1', { className: 'text-2xl font-bold text-gray-900 mb-6' }, 'Shows'),
                e('p', { className: 'text-gray-600' }, 'Show management functionality coming soon...')
            );
        }

        function Inventory() {
            return e('div', { className: 'p-6' },
                e('h1', { className: 'text-2xl font-bold text-gray-900 mb-6' }, 'Inventory'),
                e('p', { className: 'text-gray-600' }, 'Inventory management functionality coming soon...')
            );
        }

        function Scheduling() {
            return e('div', { className: 'p-6' },
                e('h1', { className: 'text-2xl font-bold text-gray-900 mb-6' }, 'Schedule'),
                e('p', { className: 'text-gray-600' }, 'Scheduling functionality coming soon...')
            );
        }

        // StudentDirectory Component
        function StudentDirectory({ onNavigateToStudent }) {
            const [students, setStudents] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [searchTerm, setSearchTerm] = useState('');
            const [message, setMessage] = useState(null);

            useEffect(() => {
                loadStudents();
            }, []);

            const loadStudents = async () => {
                setIsLoading(true);
                try {
                    const response = await gasService.getAllStudents();
                    console.log('getAllStudents response in StudentDirectory:', response);
                    
                    if (response.success && Array.isArray(response.data)) {
                        console.log('Sample student data:', response.data[0]);
                        setStudents(response.data);
                    } else if (response.success && response.data && Array.isArray(response.data.data)) {
                        console.log('Sample student data (nested):', response.data.data[0]);
                        setStudents(response.data.data);
                    } else {
                        setMessage({ type: 'error', text: response.error || 'Failed to load students.' });
                        setStudents([]);
                    }
                } catch (error) {
                    console.error('Error loading students:', error);
                    setMessage({ type: 'error', text: 'Error loading students.' });
                    setStudents([]);
                } finally {
                    setIsLoading(false);
                }
            };

            const filteredStudents = students.filter(student =>
                `${student.FirstName} ${student.Lastname || student.LastName || ''}`.toLowerCase().includes(searchTerm.toLowerCase()) ||
                (student.PrimaryEmail && student.PrimaryEmail.toLowerCase().includes(searchTerm.toLowerCase()))
            );

            return e('div', { className: 'p-6' },
                e('div', { className: 'flex justify-between items-center mb-6' },
                    e('h1', { className: 'text-2xl font-bold text-gray-900' }, 'Student Directory'),
                    e('p', { className: 'text-sm text-gray-600' }, `${filteredStudents.length} students`)
                ),

                message && e('div', { className: 'mb-4' },
                    e(Message, {
                        type: message.type,
                        message: message.text,
                        onClose: () => setMessage(null)
                    })
                ),

                e('div', { className: 'mb-6' },
                    e('input', {
                        type: 'text',
                        placeholder: 'Search by name or email...',
                        value: searchTerm,
                        onChange: (e) => setSearchTerm(e.target.value),
                        className: 'w-full max-w-md px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent'
                    })
                ),

                isLoading ? e(Loader, { text: 'Loading students...' }) :
                filteredStudents.length === 0 ? (
                    e('div', { className: 'text-center text-gray-500 mt-8' },
                        e('p', null, 'No students found.'),
                        e('button', {
                            onClick: loadStudents,
                            className: 'mt-2 px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors'
                        }, 'Reload')
                    )
                ) : (
                    e('div', { className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4' },
                        filteredStudents.map(student => {
                            // Determine what to show in the circle
                            const getCurrentOrRecentLevel = () => {
                                // Debug log for first student
                                if (student.StudentID === filteredStudents[0].StudentID) {
                                    console.log('Student debug:', {
                                        name: `${student.FirstName} ${student.Lastname}`,
                                        CurrentEnrollment: student.CurrentEnrollment,
                                        HighestLevelCompleted: student.HighestLevelCompleted
                                    });
                                }
                                
                                if (student.CurrentEnrollment) {
                                    // Extract level number/name from current enrollment
                                    // Examples: "Level 101" -> "101", "Advanced Improv" -> "ADV"
                                    const match = student.CurrentEnrollment.match(/\d+/);
                                    if (match) {
                                        return match[0];
                                    }
                                    // If no number, use first 3 letters
                                    return student.CurrentEnrollment.substring(0, 3).toUpperCase();
                                }
                                // Fallback to highest level completed or initials
                                if (student.HighestLevelCompleted) {
                                    const match = student.HighestLevelCompleted.match(/\d+/);
                                    if (match) {
                                        return match[0];
                                    }
                                    return student.HighestLevelCompleted.substring(0, 3).toUpperCase();
                                }
                                return `${(student.FirstName || '').charAt(0)}${(student.Lastname || student.LastName || '').charAt(0)}`.toUpperCase();
                            };
                            
                            const levelDisplay = getCurrentOrRecentLevel();
                            const isNumericLevel = /^\d+$/.test(levelDisplay);
                            
                            return e('div', {
                                key: student.StudentID || student.PersonnelID,
                                className: 'bg-white rounded-lg shadow-sm border p-4 hover:shadow-md transition-shadow cursor-pointer',
                                onClick: () => onNavigateToStudent && onNavigateToStudent(student.StudentID || student.PersonnelID)
                            },
                                e('div', { className: 'flex items-center space-x-3 mb-3' },
                                    e('div', { 
                                        className: `w-12 h-12 rounded-full flex items-center justify-center font-bold text-white shadow-sm ${
                                            student.CurrentEnrollment 
                                                ? 'bg-gradient-to-br from-green-500 to-green-600' 
                                                : student.HighestLevelCompleted
                                                ? 'bg-gradient-to-br from-blue-500 to-blue-600'
                                                : 'bg-gradient-to-br from-gray-400 to-gray-500'
                                        }`
                                    },
                                        isNumericLevel 
                                            ? e('span', { className: 'text-sm' }, levelDisplay)
                                            : e('span', { className: 'text-xs' }, levelDisplay)
                                    ),
                                    e('div', { className: 'flex-1' },
                                        e('h3', { className: 'font-semibold text-gray-900' }, 
                                            `${student.FirstName} ${student.Lastname || student.LastName || ''}`
                                        ),
                                        e('p', { className: 'text-sm text-gray-600' }, student.PrimaryEmail)
                                    )
                                ),
                                student.CurrentEnrollment && e('div', { className: 'mb-2 px-2 py-1 bg-green-50 border border-green-200 rounded text-xs' },
                                    e('span', { className: 'font-medium text-green-800' }, 'Current: '),
                                    e('span', { className: 'text-green-700' }, student.CurrentEnrollment)
                                ),
                                e('div', { className: 'text-sm text-gray-600' },
                                    e('p', null, `Phone: ${student.PrimaryPhone || 'N/A'}`),
                                    e('p', null, `Birthday: ${student.Birthday ? new Date(student.Birthday).toLocaleDateString() : 'N/A'}`)
                                ),
                                e('button', {
                                    className: 'mt-3 px-3 py-1 text-xs bg-blue-50 text-blue-600 rounded hover:bg-blue-100 transition-colors w-full',
                                    onClick: (e) => { 
                                        e.stopPropagation(); 
                                        onNavigateToStudent && onNavigateToStudent(student.StudentID || student.PersonnelID); 
                                    }
                                }, 'View Profile')
                            );
                        })
                    )
                )
            );
        }

        // Main App Component
        function App() {
            const [currentPage, setCurrentPage] = useState('dashboard');
            const [selectedStudentId, setSelectedStudentId] = useState(null);
            const [showStudentProfile, setShowStudentProfile] = useState(false);

            const handleNavigateToStudentProfile = (studentId) => {
                setSelectedStudentId(studentId);
                setShowStudentProfile(true);
            };

            const handleBackToStudentDirectory = () => {
                setShowStudentProfile(false);
                setSelectedStudentId(null);
                setCurrentPage('student-directory');
            };

            const renderPage = () => {
                if (showStudentProfile && selectedStudentId) {
                    return e(StudentProfile, {
                        studentId: selectedStudentId,
                        onBack: handleBackToStudentDirectory
                    });
                }

                switch (currentPage) {
                    case 'dashboard':
                        return e(Dashboard);
                    case 'personnel':
                        return e(PersonnelDirectory);
                    case 'student-directory':
                        return e(StudentDirectory, {
                            onNavigateToStudent: handleNavigateToStudentProfile
                        });
                    case 'cast':
                        return e(CastDirectory);
                    case 'classes':
                        return e(ClassRegistration);
                    case 'shows':
                        return e(Shows);
                    case 'inventory':
                        return e(Inventory);
                    case 'scheduling':
                        return e(Scheduling);
                    default:
                        return e(Dashboard);
                }
            };

            return e('div', { className: 'flex h-screen bg-gray-50' },
                e(Sidebar, { currentPage: currentPage, onNavigate: (page) => {
                    setShowStudentProfile(false);
                    setCurrentPage(page);
                }}),
                e('main', { className: 'flex-1 overflow-auto' }, renderPage())
            );
        }

        // Expose debug functions globally for console testing
        window.debugPersonnel = async () => {
            console.log('=== Testing Personnel Debug Functions ===');
            try {
                // Test 1: Basic connection
                console.log('1. Testing basic connection...');
                const connectionTest = await gasService.testConnection();
                console.log('Connection test result:', connectionTest);

                // Test 2: Debug personnel sheet
                console.log('2. Testing personnel sheet debug...');
                const debugResult = await gasService.debugPersonnelSheet();
                console.log('Debug personnel result:', debugResult);

                // Test 3: Get all personnel 
                console.log('3. Testing getAllPersonnel...');
                const personnelResult = await gasService.getAllPersonnel();
                console.log('Get all personnel result:', personnelResult);

                return {
                    connectionTest,
                    debugResult,
                    personnelResult
                };
            } catch (error) {
                console.error('Error in debug functions:', error);
                return { error: error.toString() };
            }
        };

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(e(App));
    </script>
</body>
</html>